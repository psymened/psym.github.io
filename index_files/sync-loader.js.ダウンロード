/* sync-loader.js
(C) 2015 digitalstage inc.
v 20151023
--------------------------------------------------------- */
var sync = {};

// 定義開始
(function(_sync) {

var PRTCL = document.location.protocol;
if (PRTCL == 'file:') PRTCL = 'http:';
var SYNC2_SERVER = 'http://sync2-cnsl.digitalstage.jp/';
var SYNC3_SERVER = PRTCL + '//sync3-cnsl.digitalstage.jp/';
var SYNC5_SERVER = PRTCL + '//sync5-cnsl.digitalstage.jp/';
var SYNC_RES_SERVER = PRTCL + '//sync5-res.digitalstage.jp/';
var DISQUS_LOCAL_TEST = false;

jQuery.ajaxSetup({scriptCharset:'utf-8'});
jQuery.fnbind = function(t, fn){ return function() { return fn.apply(t, arguments);}};
var isMobile = _bind.device.mobile;
var isAndroid = _bind.device.android;
var isIphone = _bind.device.iphone;
var isIpad = _bind.device.ipad;
var isTablet = ((_bind.device.ipad) || ((_bind.device.android) && (!_bind.device.mobile)));
var userAgent = window.navigator.userAgent.toLowerCase();
var isIEdge = false;
if(userAgent.indexOf('msie') > -1 || userAgent.indexOf('trident') > -1 || userAgent.indexOf('edge') > -1) {
	isIEdge = true;
} 

var userLang = document.getElementsByTagName("html")[0].getAttribute("lang");

// BiNDCLD
var bindobj = {};
bindobj = _bind.device;
bindobj.isLocal = (document.URL.indexOf('file://')==0);
bindobj.isCloud = false;
bindobj.isBind8 = false;
if ((location.host.indexOf("edit.bindcloud.jp")>-1) || (location.host.indexOf("edit2.bindcloud.jp")>-1) || (location.host.indexOf("edit.blks.jp")>-1)) bindobj.isCloud = true;
if (location.host.indexOf("localhost:")>-1) {
	bindobj.isCloud = true;
	bindobj.isBind8 = true;
}
bindobj.isCloudEditer = (bindobj.isCloud && window.frameElement && window.frameElement.id=='preview-area') ? true : false;

var currentBlogId;
var currentYm = null;
var currentPage = 1;
var mainJson = null;
var catList = [];
var blogOption;
var partsId = 0;
var currentNewsIdx = {};
var feedManager = null;
var hashChangeFlg = false;
var gMapManager = null;
var bkHeight = {};
var formOpt = {};
var partsCnt = 0;
var finishCnt = 0;
var fullScreenFlg = 0;

function syncDig(p) {
	var cl = p.childNodes;
	for (var i=0; i<cl.length; i++) {
		var c = cl[i];
		var nm = c.nodeName;
		var cls = c.className;

		if (nm == '#text') continue;
		else if (nm == 'DIV' || nm == 'SPAN') {
			if (cls.indexOf('js-sync') > -1) {
				loadService(cls, c);
			}
		}

		if (c.hasChildNodes()) {
			syncDig(c);
		}
	}
}

function loadService(cls, c) {
	partsCnt++;
	var ary = cls.split(' ');
	var type = ary[1].substring(1);
	var did = ary[2];

	var buf = jQuery(c).text();
	ary = buf.split(',');
	var gid = ary[0];
	var sid = ary[1];
	var did = ary[2];
	var option = null;

	if (buf.indexOf('{') > -1 && buf.indexOf('}') > -1) {
		var startidx = buf.indexOf('{');
		var endidx = buf.lastIndexOf('}');
		option = JSON.parse(buf.substring(startidx,endidx+1));
	}

	if (type == 'blog') {
		if (option == null) {
			dispSync1Error(c);
			return;
		}
		if (feedManager == null) feedManager = new FeedManager();
		option.blogid = option.blogid.replace(/[\/]/g, '');
		feedManager.addFeed(option.site, option.blogid, did, option, c, sid);

	} else if (type == 'video') {
		dispVideo(c, sid, did, option);

	} else if ((type == 'form') || (type == 'form3') || (type == 'form5')) {
		// TODO:複数フォームへの対応
		// var url = (type=='form3'?SYNC3_SERVER:SYNC2_SERVER) + 'sync/form.action';
		var baseurl = (type=='form5')?SYNC5_SERVER:((type=='form3')?SYNC3_SERVER:SYNC2_SERVER);
		var url = baseurl + 'sync/form.action';
		var form_load_tm = setTimeout(function() {
			dispSync1Error(c);
		}, 10000);
		ajaxFlg = true;
		jQuery.ajax({
			url: url,
			type: 'GET',
			dataType: 'jsonp',
			async: false,
			data: {
				's': sid
			},
			success: function(json) {
				clearTimeout(form_load_tm);
				if (option != null) formOpt = option;
				dispForm(c, sid, json, type);
				ajaxFlg = false;
			},
			error: function(req, stat, e) {
				ajaxFlg = false;
				//alert('フォームの基本情報の取得に失敗しました。');
			}
		});

	} else if (type == 'docs') {
		dispDoc(c, sid, option);

	} else if ((type == 'news') || (type == 'news3') || (type == 'news5')) {
		if (sid=='1')
			dispNews(c, option, type);
		else
			dispBookmark(c, option, type);

	} else if ((type == 'map') || (type == 'map5')) {
		new SyncYMap(sid, c, type);

	} else if (type == 'twitter') {
		dispTwitter(c, sid, option);

	} else if (type == 'ustream') {
		dispUstream(c, sid, did, option);

	} else if (type == 'search') {
		dispSearch(c, sid, option);

	} else if (type == 'translate') {
		dispTranslate(c, sid);

	} else if (type == 'likebtn') {
		dispLikeButtom(c, sid, option);

	} else if (type == 'twitbatch') {
		dispTwitbatch(c, sid, option);

	} else if (type == 'bbs') {
		if(sid == 'facebook'){
			dispFacebook(c, sid, option);
		}else if(sid == 'disqus'){
			dispDisqus(c, sid, option);
		}
	} else if(type == 'likebox'){
		dispLikebox(c, sid, option);

	} else if(type == 'instagramw'){
		dispInstagram(c, sid, option);

	} else if(type == 'gmap'){
		if (gMapManager == null) gMapManager = new GMapManager();
		var url = SYNC5_SERVER + 'syncgmap.json/?s=' + sid;
		jQuery.getJSON(url+'&callback=?', function(json) {
			gMapManager.addGmap(new GMapRenderer(c, sid, option, json));
		});

	} else if(type == 'affiliate'){
		dispAffiliate(c, sid, did, option);

	}
}

var ajaxFlg = false;

function dispSync1Error(c) {
	try {
		c.innerHTML = '<div class="kakomi"><p class="kakomi ac"><i><span class="fsize_l" style="color:#6C6C6C;">ここに貼られたSYNCウィジェットは、現在のバージョンと互換性が無いか、一時的なサーバー負荷のため表示できません。</span></i><br />' +
			'<i><span class="fsize_l" style="color:#6C6C6C;">一度このパーツを削除して新規にパーツを作成するか、サーバーの状況が改善されるのをお待ちください。</span></i><br />' +
			'<br />' +
			'<span class="fsize_s" style="color:#6C6C6C;"><a href="http://www.digitalstage.jp/go/sync5/trouble.html">SYNCのトラブルシューティングを開く</a></span></p></div>';
		c.style.display = '';
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
	} catch (err) {}
}

/**********
N E W S
********/
function dispNews(c, opt, type) {
	var baseurl = (type=='news5')?SYNC5_SERVER:((type=='news3')?SYNC3_SERVER:SYNC2_SERVER);
	var rssUrl = '';
	if (opt.newsSourceType=='typeRssDirect')
		rssUrl = baseurl + 'sync/rss?url=' + encodeURIComponent(opt.rssUrl);
	else
		rssUrl = baseurl + 'sync/news.json/' + opt.bindNewsId + '/?dm=1';

	jQuery.getJSON(rssUrl + '&callback=?', function(json) {
		c.innerHTML = '';
		var isStandard = (getSkinClass(c).indexOf('standard') > -1);
		var titleStr = '<a href="' + json.url + '" target="_blank">' + json.title + '</a>';

		// 通常
		if (opt.designId == 'design1') {
			if (isStandard) {
				var mc = nineSlice('slice h3', c);
				mc.append('<h3>' + titleStr + '</h3>');
			} else {
				var h3div = jQuery('<div class="h3"/>').appendTo(c);
				jQuery('<h3></h3>').appendTo(h3div).append(titleStr);
			}

			var div = jQuery('<div class="indent tabular"></div>');
			var table = jQuery('<table class="c-list_table"></table>').appendTo(div);
			for (var i=0,l=json.entries.length; i<l; i++) {
				var e = json.entries[i];
				var ds = '';
				if (e.news_date)
					ds = e.news_date;
				else
					ds = e.updated_date;
				var d = parseFeedDate(ds);
				var dt = d.year + '/' + d.month + '/' + d.day;

				var tr = jQuery('<tr></tr>');
				var th = jQuery('<th><div class="th">' + dt + '</div></th>').appendTo(tr);
				var td = jQuery('<td></td>').appendTo(tr);
				var a = jQuery('<a href="' + e.url + '">' + e.subject + '</a>');
				var balloon = (isStandard) ? nineSlice('balloon', td) : jQuery('<div class="balloon"></div>').appendTo(td);
				balloon.append(a);

				table.append(tr);
			}

			div.appendTo(c);

		// ティッカー
		} else if (opt.designId == 'design2') {
			var tickerMobile = '';
			if (bindobj.theme=="jquerymobile") {
				tickerMobile = ' ticker_mobile';
			}
			var ptid = getSyncPartsId();
			var div = jQuery('<div class="indent tabular" style="position:relative;"></div>');
			var table = jQuery('<table class="c-list_table ticker' + tickerMobile +'" style="min-height: 60px;"></table>').appendTo(div);
			var tr = jQuery('<tr></tr>');
			var th = jQuery('<th style="width: 30%;"><div class="th">' + titleStr + '</div></th>').appendTo(tr);
			var tr2 = jQuery('<tr></tr>');
			var td = jQuery('<td style="width: 70%; overflow:hidden;"></td>').appendTo(tr);
			var area = jQuery('<div id="' + ptid + '" class="sync_news_ticker' + tickerMobile +'"></div>');
			var balloon = (isStandard) ? nineSlice('balloon', td) : jQuery('<div class="balloon" sytle="position: relative; margin: 5px;"></div>').appendTo(td);
			balloon.append(area);
			table.append(tr);
			//table.append(tr2);
			div.appendTo(c);

			// 入れ替えの処理
			var ents = json.entries;
			if (ents.length > 0) {
				doNewsTicker(ents[0], ptid);

				if (ents.length > 1) {
					currentNewsIdx[ptid] = 1;
					setInterval(function(){
						var e = ents[currentNewsIdx[ptid]];
						doNewsTicker(e, ptid);

						currentNewsIdx[ptid]++;
						if (currentNewsIdx[ptid] >= ents.length) currentNewsIdx[ptid] = 0;
					}, 10000);
				}
			}
		}

		c.style.width = '100%';
		c.style.display = '';
		//setAlign(c);
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		finishSyncParts();
	});
}

function doNewsTicker(e, ptid) {
	jQuery('#' + ptid).parent().css('position', 'relative');
	jQuery('#' + ptid + ' span').fadeOut(1000, function() {
		this.parentNode.removeChild(this);
	});

	var pt = jQuery('#' + ptid);
	var w = pt.parent().width();
	if (w == 0) w = 500;

	var ds = '';
	if (e.news_date)
		ds = e.news_date;
	else
		ds = e.updated_date;
	var d = parseFeedDate(ds);
	var dt = d.year + '.' + d.month + '.' + d.day;
	var a = jQuery('<a href="' + e.url + '" class="no_linkeffect">' + dt + ' ' + e.subject + '</a>');
	var csso = {
		left: (w - 100) + 'px', position:'absolute'//, width: '100%'
	};
	if (bindobj.ie70) csso.width = '100%';
	if (!bindobj.vista && !bindobj.win7) csso.opacity = 0;
	var tickerMobile = '';
	if (bindobj.theme=="jquerymobile") {
		tickerMobile = 'ticker_mobile';
	}
	var n = jQuery('<span class="' + tickerMobile + '"></span>').css(csso).append(a).appendTo(pt);

	var o = {
		left: 0
	};
	if (!bindobj.vista && !bindobj.win7) o.opacity = 1;
	n.animate(o, 2000, 'easeOutExpo');
}

function dispBookmark(c, option, type) {
	var services = option.services;
	var linkNm = document.title;
	var addr = (option.urlType == 'urlTypeOwn') ? option.ownUrl:location.href;
	var isLocal = (addr.indexOf('file://') == 0);

	var hdr = '';
	var buf = '';
	var url = '';
	var rssYahooUrl = '';
	if (option.buttons.bookmark) {
		hdr += '<a href="javascript:;" onclick="sync.showPanel(this, \'bookmark-area\'); return false" class="tab-bookmark">ブックマーク</a>';
		buf += '<div class="bookmark-area">';
		buf += '<h3 class="newstype">ソーシャルブックマークへ登録する<a href="javascript:;" onclick="sync.closePanel(this)" class="close-area"></a></h3>';
		buf += '<p class="newsinfo">現在あなたがご覧のページを、ソーシャルブックマークに登録できます。<br />ソーシャルブックマークをまだ利用していない方は、それぞれの項目の「？」をクリックしてみましょう。すでに各種ブックマークサービスをお使いの方は、ご自分が利用されているサービス名をクリックしてください。人数が表示されている場合は人数をクリックでコメントなどを読むことができます。</p>';

		var oddEven = new OddEven();
		var onlyYahoo = true;
		for (var k in services) {
			if (services[k]) {
				switch (k) {
				/*
				case 'bmYahoo':
					var odd = oddEven.getNext();
					var yid = getSyncPartsId();
					buf += '<div class="bookmark-panel ' + odd + '">';
					buf += '<div class="bookmark-title">';
					buf += '<a href="javascript:void window.open(\'http://bookmarks.yahoo.co.jp/bookmarklet/showpopup?t=' + escape(linkNm) + '&u=' + encodeURIComponent(addr) + '&opener=bm&ei=UTF-8\',\'popup\',\'width=550,height=480,left=100,top=50,scrollbars=1,resizable=1\',0);" title="Yahoo!ブックマークへ追加">';
					buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/ybm16.gif" />Yahoo!ブックマーク</a>';
					buf += '</div>';
					buf += '<div id="' + yid + '"></div>';
					if (isLocal==false) {
						var baseurl = (type=='news5')?SYNC5_SERVER:((type=='news3')?SYNC3_SERVER:SYNC2_SERVER);
						jQuery.getJSON(baseurl + 'sync/yahoobm.action?u=' + encodeURIComponent(addr) + '&callback=?', function(json) {
							jQuery('#' + yid).html('<a href="http://bookmarks.yahoo.co.jp/url?url=' + encodeURIComponent(addr) + '" target="_blank">' + json.ybm_cnt + '人</a>');
						});
					}
					buf += '<a href="http://bookmarks.yahoo.co.jp/promo-about" target="_blank" class="help">Yahoo!ブックマークって何？</a>';
					buf += '</div>';
					break;
					*/
				case 'bmGoogle':
					var odd = oddEven.getNext();
					buf += '<div class="bookmark-panel ' + odd + '">';
					var url = PRTCL + '//www.google.com/bookmarks/mark?op=add&bkmk=' + encodeURIComponent(addr) + '&title=' + escape(linkNm);
					buf += '<div class="bookmark-title">';
					buf += '<a href="javascript:sync.wordOfMouse(\'' + url + '\')" title="Googleブックマークへ追加">';
					buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/google.png" />Googleブックマーク</a>&nbsp;';
					buf += '</div>';
					buf += '<a href="http://www.google.com/support/toolbar/bin/answer.py?answer=43305&topic=15364&hl=ja" target="_blank" class="help">iGoogleって何？</a>';
					buf += '</div>';
					onlyYahoo = false;
					break;
				case 'bmHatena':
					var odd = oddEven.getNext();
					buf += '<div class="bookmark-panel ' + odd + '">';
					var hid = getSyncPartsId();
					var url = 'http://b.hatena.ne.jp/add?mode=confirm&title=' + escape(linkNm) + '&url=' + encodeURIComponent(addr);
					buf += '<div class="bookmark-title">';
					buf += '<a href="javascript:sync.wordOfMouse(\'' + url + '\')" title="はてなブックマークへ追加">';
					buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/hatena.gif" style="vertical-align:middle" />はてなブックマーク</a>';
					buf += '</div>';
					buf += '<span id="' + hid + '"></span>&nbsp;';
					if (isLocal==false) {
						jQuery.getJSON(PRTCL + '//api.b.st-hatena.com/entry.count?url=' + encodeURIComponent(addr) + '&callback=?', function(json) {
							jQuery('#' + hid).html('<a href="http://b.hatena.ne.jp/entry/' + addr + '" target="_blank">' + json + '人</a>');
						});
					}
					buf += '<a href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B7%A5%E3%A5%EB%A5%D6%A5%C3%A5%AF%A5%DE%A1%BC%A5%AF" target="_blank" class="help">はてなブックマークって何？</a>';
					buf += '</div>';
					onlyYahoo = false;
					break;
				}
			}
		}
		buf += '</div>';
		if (onlyYahoo) {
			hdr = '';
			buf = '';
		}
	}

	if (option.buttons.rss) {
		var baseurl = (type=='news5')?SYNC5_SERVER:((type=='news3')?SYNC3_SERVER:SYNC2_SERVER);
		var rssAddr = (option.newsSourceType == 'typeRssDirect') ? option.rssUrl : baseurl + 'sync/news.atom/' + option.bindNewsId + '/';
		rssYahooUrl = rssAddr;
		hdr += '<a href="#" onclick="sync.showPanel(this, \'rss-area\'); return false;" class="tab-rss">RSSを購読</a>';
		buf += '<div class="rss-area">';
		buf += '<h3 class="newstype">RSSを購読する<a href="javascript:;" onclick="sync.closePanel(this)" class="close-area"></a></h3>';
		buf += '<p class="newsinfo">このページ（サイト）に関する最新情報をRSSリーダーを使って購読することができます。RSSリーダーをまだ利用していない方は、それぞれの項目の「？」をクリックしてみましょう。すでに各種RSSリーダーをお使いの方は、ご自分が利用されているサービス名をクリックしてください。人数が表示されている場合は人数をクリックでコメントなどを読むことができます。</p>';
		var oddEven = new OddEven();
		for (var k in services) {
			if (services[k]) {
				switch (k) {
				case 'rssYahoo':
					var odd = oddEven.getNext();
					buf += '<div class="bookmark-panel ' + odd + '">';
					var url = 'http://rd.yahoo.co.jp/myyahoo/rss/addtomy/users/*http://add.my.yahoo.co.jp/rss?url=' + encodeURIComponent(rssAddr);
					buf += '<div class="bookmark-title">';
					buf += '<a id="rss-yahoo" href="javascript:sync.wordOfMouse(\'' + url + '\')" title="My Yahoo!へ追加">';
					buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/addtomy2.gif" width="62" height="17" border="0" />My Yahoo!</a>';
					buf += '</div>';
					buf += '<a href="http://docs.my.yahoo.co.jp/newmyyahoo/promo/" target="_blank" class="help">MyYahoo!って何？</a>';
					buf += '</div>';
					break;
				}
			}
		}
		buf += '<div class="rss-direct">';
		buf += '<a href="' + rssAddr + '" target="_blank">RSSを直接開く</a>';
		buf += '</div>';
		buf += '</div>';
	}

	if (option.buttons.twitter) {
		var tid = getSyncPartsId();
		var rtid = getSyncPartsId();

		hdr += '<a href="#" onclick="sync.showPanel(this, \'twitter-area\'); return false;" class="tab-twitter">Twitterでつぶやく</a>';
		buf += '<div class="twitter-area">';
		buf += '<h3 class="newstype">Twitterでつぶやく<a href="javascript:;" onclick="sync.closePanel(this)" class="close-area"></a></h3>';
		buf += '<p class="newsinfo">Twitterを使ってこのページ（サイト）に関する「つぶやき」をすることができます。<br />つぶやきはURL付きのRT(Retweet）として表示されます。</p>';
		buf += '<div class="bookmark-panel">';
		buf += '<div class="bookmark-title">';

		if (isLocal==false) {
			var tg = PRTCL + '//twitter.com/home/?status=RT+%40' + services.twitterId + '+' + encodeURIComponent(linkNm) + '+' + encodeURIComponent(addr);
			buf += '<span id="' + tid + '"><a href="' + tg + '" title="retweet" target="_blank"><img src="' + SYNC_RES_SERVER + '_modules/images/newsres/tweet.png" />つぶやく</a></span>';
			jQuery.getJSON(PRTCL + '//search.twitter.com/search.json?q=' + encodeURIComponent(addr) + '&callback=?', function(json){
				var twid = getSyncPartsId();
				var retwBuf = '';
				var retwNum = json.results.length;
				if (retwNum > 0) {
					for (var i=0; i<retwNum; i++) {
						var r = json.results[i];
						retwBuf += '<p><img src="' + r.profile_image_url + '" width="20" style="margin-right:2px"/>';
						retwBuf += r.text;
						var dt = new Date(r.created_at);
						var twurl = PRTCL + '//twitter.com/' + r.from_user + '/statuses/' + r.id;
						retwBuf += '&nbsp;<a href="' + twurl + '" target="_blank">'
							+ String(dt.getMonth()+1) + '/' + String(dt.getDay()) + ' '
							+ String(dt.getHours()) + ':' + String(dt.getMinutes()) + "</a>";
						retwBuf += '</p>';
					}
					var retwPanel = jQuery('<div id="' + twid + '" class="rt-wrapper"></div>').append('<div class="close-btn"></div>').click(function(e){
						jQuery(this).fadeOut(200);
					}).appendTo(document.body).hide();
					jQuery('<div class="retweeter-panel">' + retwBuf + '</div>').appendTo(retwPanel);
				}

				var a = jQuery('<a href="' + PRTCL + '//search.twitter.com/search?q=' + encodeURIComponent(addr) + '" target="_blank">' + retwNum + '人</a>');
				if (retwNum > 0) {
					a.hover(function(e){
						retwPanel.css({'left': e.pageX, 'top': e.pageY});
						retwPanel.fadeIn(200);
					});
				}
				jQuery('#' + rtid).append('').append(a).append('');
			});
		} else {
			buf += '<span id="' + tid + '"></span>';
		}

		buf += '</div>';
		buf += '<span id="' + rtid + '"></span>&nbsp;';

		buf += '<a href="http://twitter.com/" target="_blank" class="help">Twitterって何？</a>';
		buf += '</div>';
		buf += '<div class="followme">';
		buf += '<a href="http://twitter.com/' + services.twitterId + '/" target="_blank">このサイトのオーナーをfollowする</a>';
		buf += '</div>';
		buf += '</div>';
	}

	hdr = '<div class="bookmark-toolbar">' + hdr + '</div>';
	jQuery(c).html(hdr + buf).show();
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
	if (option.buttons.rss) {
		if (jQuery('#rss-yahoo').length > 0) {
			jQuery.getScript('http://i.yimg.jp/images/security/pf/pcore-1.0.1.min.js', function() {
				var rdsig = YAHOO.JP.pcore.rdsig;
				var rdpath = '/myyahoo/rss/addtomy/users/';
				var rdurl = rdsig.gen_redirect_v1(encodeURI('http://add.my.yahoo.co.jp/rss?url=' + (rssYahooUrl)), rdpath);
				jQuery('#rss-yahoo').attr('href', 'javascript:sync.wordOfMouse(\"' + rdurl + '\")');
			});
		}
	}
}

function OddEven() {
	this.initialize.apply(this, arguments);
}
OddEven.prototype = {
	initialize: function() {
		this.oddCnt = 0;
	},
	getNext: function() {
		this.oddCnt++;
		return (this.oddCnt % 2 == 0) ? 'even':'odd';
	}
};

_sync.closePanel = function(a) {
	var anc = jQuery(a);
	var pnl = anc.parent().parent();
	pnl.slideUp(200);
	pnl.parent().find('div.bookmark-toolbar').children('a').removeClass('sel');
}

_sync.showPanel = function(a, cls) {
	var anc = jQuery(a);
	var prt = anc.parent();
	prt.children('a').each(function(i, e) {
		if (e != a)	jQuery(e).removeClass('sel');
	});
	anc.toggleClass('sel');

	var bmtop = prt.parent();
	bmtop.children('div.dispnow:not(.' + cls + ')').hide();
	bmtop.children('div.' + cls).slideToggle(200).addClass('dispnow');
}

_sync.wordOfMouse = function(url) {
	var win = window.open(url, 'bind_wordOfMouse', 'width=800,height=500,resizable=yes,scrollbars=yes,menubar=no,toolbar=no,location=no,status=no');
	win.focus();
}

/**********
 D O C S
********/
function dispDoc(c, sid, option) {
	var tv = sid.split(':');
	var type = tv[0];
	var docid = tv[1];
	jQuery(c).css('width','100%');
	if (type.indexOf('document') == 0) {
		var url = SYNC5_SERVER + 'sync/docs.action?callback=?';
		jQuery.getJSON(url, {'s': sid}, function(json) {
			if (json.csspart && json.csspart.length > 0)
				jQuery('<style type="text/css">' + json.csspart + '</style>').appendTo('head');
			c.innerHTML = json.content;
			jQuery('#report-abuse-button').hide();
			jQuery('a.google-small-link').attr('href', 'http://docs.google.com/');
			jQuery(c).fadeIn(500);
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		});
	} else if (type.indexOf('spreadsheet') == 0) {
		var h = getBkWidth(jQuery(c)) * 0.903;
		var id = "sheet_frame_" + docid;
		c.innerHTML = '<iframe id="' + id + '" src="' + PRTCL + '//spreadsheets.google.com/pub?key=' + docid + '" frameborder="0" width="100%" height="'+h+'" allowtransparency="true"></iframe>';
		if (option && option.newFlg)
			c.innerHTML = '<iframe id="' + id + '" src="' + PRTCL + '//docs.google.com/spreadsheets/d/' + docid + '/pubhtml?widget=true&headers=false" frameborder="0" width="100%" height="'+h+'" allowtransparency="true"></iframe>';
		jQuery(c).fadeIn(500);
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		jQuery(window).resize(function() {
			var h = getBkWidth(jQuery(c)) * 0.903;
			var ww = jQuery(window).width();
			jQuery('#'+id).attr('height',h);
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		});

	} else if (type.indexOf('presentation') == 0) {
		var h = getBkWidth(jQuery(c)) * 0.818;
		c.innerHTML = '<iframe id='+docid+' src="' + PRTCL + '//docs.google.com/presentation/d/' + docid + '/embed?delayms=3000" frameborder="0" width="100%" height="'+h+'" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" allowtransparency="true"></iframe>';
		jQuery(c).fadeIn(500);
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		jQuery(window).resize(function() {
			var h = getBkWidth(jQuery(c)) * 0.818;
			var ww = jQuery(window).width();
			jQuery('#'+docid).attr('height',h);
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		});

	}
}

/**********
 F O R M
********/
//form.jsにあるDetailDatと同じにしてください。
var DetailDat = {
		fields: [
			{id: 'txt_required', place: '※は必須入力です。', deflabel: 'は必須入力です。', label: ''},
			{id: 'txt_confirm', place: '送信確認', deflabel: 'この内容で送信します。よろしいですか？', label: ''},
			{id: 'btn_confirm', place: '確認ボタンの文言', deflabel: '確認', label: ''},
			{id: 'btn_transmit', place: '送信ボタンの文言', deflabel: '送信', label: ''},
			{id: 'btn_correct', place: '内容を修正ボタンの文言', deflabel: '内容を修正', label: ''},
			{id: 'chk_sel_required', place: '未選択エラー', deflabel: '選択してください。', label: ''},
			{id: 'chk_txt_required', place: '未入力エラー', deflabel: '入力してください。', label: ''},
			{id: 'chk_txt_format', place: '書式エラー', deflabel: '正しい書式で入れてください。', label: ''},
			{id: 'chk_txt_limit', place: '送信制限エラー', deflabel: '送信できるテキストは５００文字以内です。', label: ''},
			{id: 'chk_txt_conflict', place: '不一致確認エラー', deflabel: 'と一致しません。', label: ''},
			{id: 'msg_send_success', place: '送信成功の文言', deflabel: '送信を完了しました。', label: ''},
			{id: 'msg_send_error', place: '送信失敗の文言', deflabel: '送信に失敗しました。', label: ''},
			{id: 'msg_send_failed', place: 'タイムアウト時の文言', deflabel: 'フォームの送信に失敗した可能性があります。\n再送信してください。', label: ''}
		]
	};

var forms = null;
function dispForm(c, formId, json, type) {

	c.innerHTML = '';

	// for error check
	var sync_form_id = 'sync_form_' + formId;
	if (forms == null) forms = {};
	var fields = {
		'form_id' : formId,
		'back_url' : ((!json.back_url)?'':json.back_url),
		'back_txt' : ((!json.back_txt)?'':json.back_txt),
		'last_msg' : breakToTag(json.last_msg)
	};
	//var dtltxt = {};
	var total = DetailDat.fields.length;
	for (var i=0; i<total; i++) {
		fields[DetailDat.fields[i].id] = DetailDat.fields[i].deflabel;
		if (json.dtls) {
			var dtllen = json.dtls.length;
			for (var j=0; j<dtllen; j++) {
				if (DetailDat.fields[i].id == json.dtls[j].id) {
					fields[DetailDat.fields[i].id] = json.dtls[j].label;
				}
			}
		}
	}

	forms[sync_form_id] = fields;

	var required = jQuery('<span class="required" id="warningA" style="display:visibility">＊</span>');

	var skin = getSkinClass(c);
	if (skin.indexOf('standard') > -1) {
		var mc = nineSlice('slice h3', c);
		mc.append('<h3>' + json.title + '</h3>');
	} else {
		var h3div = jQuery('<div class="h3"/>').appendTo(c);
		jQuery('<h3></h3>').appendTo(h3div).append(json.title);
	}

	// 20150316 AuthSubアラート
	if (json.authsub || (type == 'form') || (type == 'form3')) {
		if (bindobj.isLocal || bindobj.isCloudEditer) {
			(getAuthSubEditWarnMsg()).appendTo(c);
		} else {
			(getAuthSubWarnMsg()).appendTo(c);
		}
	}

	var subt = json.subtitle;
	if (subt.length > 0)
		jQuery('<p class="lead"></p>').append(breakToTag(subt)).appendTo(c);

	//jQuery('<p class="note" id="warningA2" style="display:visibility">').append(required.clone()).append('は必須入力です。').appendTo(c);
	jQuery('<p class="note" id="warningA2" style="display:visibility">').append(required.clone()).append(fields.txt_required).appendTo(c);

	var frm = jQuery('<form id="' + sync_form_id + '"></form>');
	var inpA = jQuery('<div id="inputA" style="display:visibility"></div>');
	var cfmA = jQuery('<div id="confirmA" style="display:none">Confirm Area<table class="table sync_form"></table></div>');
	var tbl = jQuery('<table class="table sync_form">');

	// comps
	jQuery.each(json.comps, function(i, c) {
		var tr = jQuery('<tr>');
		var th = jQuery('<th>').appendTo(tr).append(c.label);

		var td = jQuery('<td>');
		var fcnt = c.fields.length;

		var err_area = 'err_' + sync_form_id + c.id;

		// fields
		var has_required = false;
		jQuery.each(c.fields, function(j, f) {
			var id = f.id;
			fields[id] = f;
			f['err_area'] = err_area;

			if (f.req) has_required = true;

			var sep = (id.indexOf('postal2') > -1
				|| id.indexOf('tel2') > -1 || id.indexOf('tel3') > -1) ? '':
					(getByFieldId(c.id)=='name' || getByFieldId(c.id)=='name_kana'
					|| id.indexOf('date_m') > -1 || id.indexOf('date_d') > -1) ? '　':'<br />';

			if (j > 0) td.append(sep);
			if (fcnt > 1 && id.indexOf('date_') == -1) jQuery('<label for="' + id + '">' + f.label + '</label>').appendTo(td);

			if (f.type == 'テキスト') {
				var txt = jQuery('<input type="text" />').attr('id', id).attr('name', id);
				if (isMobile) {
					if (id.indexOf('sei') > -1 || id.indexOf('mei') > -1) {
						txt.attr('size', 10);
					} else if (id.indexOf('single_text') > -1 || id.indexOf('street') > -1 ||id.indexOf('subject') > -1) {
						txt.attr('size', 30);
					}
				} else {
					if (f.size > 0) txt.attr('size', f.size);
				}
				txt.appendTo(td);
				txt.focus(chkInput).keyup(chkInput);

			} else if (f.type == '複数行テキスト') {
				if (isMobile) {
					var txt = jQuery('<textarea cols="35" rows="7"></textarea>').attr('id', id).attr('name', id).appendTo(td);
				} else {
					var txt = jQuery('<textarea cols="40" rows="7"></textarea>').attr('id', id).attr('name', id).appendTo(td);
				}
				txt.focus(chkInput).keyup(chkInput);

			} else if (f.type == '選択リスト') {
				var def = '';
				var sel = jQuery('<select></select>').attr('id', id).attr('name', id).appendTo(td);
				if (id.indexOf('calc_date') > -1) {
					var defDay = new Date();
					if (id.indexOf('calc_date_y') > -1) {
						var year = defDay.getYear();
						if (year < 2000) year += 1900;
						f.choices = [String(year-2), String(year-1), String(year), String(year+1), String(year+2), String(year+3)];
					}
				}
				if (f.choices) {
					jQuery.each(f.choices, function(i, cho) {
						if (id.indexOf('calc_date_y') > -1) {
							if (Number(cho) == year) def = ' selected="selected" ';
						} else if (id.indexOf('calc_date_m') > -1) {
							if (Number(cho) == (defDay.getMonth()+1)) def = ' selected="selected" ';
						} else if (id.indexOf('calc_date_d') > -1) {
							if (Number(cho) == (defDay.getDate())) def = ' selected="selected" ';
						}
						sel.append(jQuery('<option' + def + '></option>').append(cho).attr('value', cho));
						def = '';
					});
				}

			} else if (f.type == 'チェックボックス') {
				if (f.choices) {
					jQuery.each(f.choices, function(i, cho) {
						var cssId = id + '_' + i;
						jQuery('<input type="checkbox" id="' + cssId + '" name="' + id + '" value="' + cho + '" />').appendTo(td);
						jQuery('<label for="' + cssId + '">' + cho + '</label>').appendTo(td);
					});
				}

			} else if (f.type == 'ラジオボタン') {
				if (f.choices) {
					jQuery.each(f.choices, function(i, cho) {
						var cssId = id + '_' + i;
						jQuery('<input type="radio" id="' + cssId + '" name="' + id + '" value="' + cho + '" />').appendTo(td);
						jQuery('<label for="' + cssId + '">' + cho + '</label>').appendTo(td);
					});
				}

			} else if (f.type == '数値テキスト') {
				var txt = jQuery('<input type="text" />').attr('id', id).attr('name', id);
				if (isMobile) {
					if (id.indexOf('tel1') > -1) {
						txt.attr('size', 10);
					} else if (id.indexOf('tel2') > -1 || id.indexOf('tel3') > -1 || id.indexOf('ps_postal2') > -1) {
						txt.attr('size', 8);
					} else if (id.indexOf('ps_postal1') > -1) {
						txt.attr('size', 4);
					} else if (id.indexOf('adult_num') > -1 || id.indexOf('child_num') > -1) {
						txt.attr('size', 6);
					}
				} else {
					if (f.size > 0) txt.attr('size', f.size);
				}
				txt.appendTo(td);
				txt.focus(chkInput).keyup(chkInput).blur(function(e){chgHankaku(this.form,this.id,'2');});

			} else if (f.type == 'メールアドレス') {
				var txt = jQuery('<input type="text" />').attr('id', id).attr('name', id);
				if (isMobile) {
					txt.attr('size', 30);
				} else {
					if (f.size > 0) txt.attr('size', f.size);
				}
				txt.appendTo(td);
				txt.focus(chkInput).keyup(chkInput);
			}

			if ((f.type == '数値テキスト') || (f.type == 'テキスト')) {
				if (id.indexOf('postal1') > -1 || id.indexOf('postal2') > -1) {
					txt.blur(function(e){setZipAddress(this.form,this.id);});
				}
			}

			if (f.suffix) {
				if (f.suffix.length>0) {
					jQuery('<label for="' + id + '">&nbsp;' + f.suffix + '</label>').appendTo(td);
				}
			}

		});

		if (has_required) {
			th.append(required.clone());
		}

		td.append('<div id="' + err_area + '"></div>');
		tr.append(td);
		tr.append(td);
		tr.appendTo(tbl);
	});

	var footer = jQuery('<p class="ac">');
	//jQuery('<button class="sync_form_button" type="submit">').append('確認').appendTo(footer);
	jQuery('<button class="sync_form_button" type="submit">').append(fields.btn_confirm).appendTo(footer);
	frm.submit(function(e){
		var flds = forms[this.id];
		var hasError = false;
		jQuery.each(flds, function(i, f) {
			if (!chkOne(f, flds, frm)) hasError = true;
		});
		// 更新
		if (hasError == false) {
			confirmForm(c, formId, json, type, frm);
		}
		return false;
	});


	tbl.appendTo(inpA);
	footer.appendTo(inpA);
	inpA.appendTo(frm);
	cfmA.appendTo(frm);
	var div = jQuery('<div class="indent tabular">').append(frm);
	div.appendTo(c);

	c.style.width = '100%';
	jQuery(c).fadeIn(500);

	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}

// AuthSub警告表示 20150311 START 20140420廃止当日対応mod
/** エディタ上 **/
function getAuthSubEditWarnMsg() {
	var warnTitle = '<div style="margin-bottom:.5em;padding-bottom:.5em;font-size:16px;line-height:1.1;font-weight:bold;color:#c00;text-align:center;border-bottom:1px solid #c00;">'
		+ '<span style="margin-right:5px;position:relative;display: inline-block;box-sizing:border-box;width:20px;height:20px;border:2px solid #c00;border-radius:10px;font-size:0;line-height:0;vertical-align: bottom;">'
		+ '<span style="position:absolute;top:3px;left:50%;margin-left:-1px;width:2px;height:7px;background-color:#c00;"></span>'
		+ '<span style="position:absolute;bottom:3px;left:50%;margin-left:-1px;width:2px;height:2px;background-color:#c00;"></span>'
		+ '</span>'
		+ '<span>重要なお知らせ</span>'
		+ '</div>';
	var $warnTitle = jQuery(warnTitle);
	var warnMsg = '<div style="color:#222;">Google社のAPI提供終了に伴い、現在こちらのフォームは使用できません。'
				+ '<br><span style="color:#c00;">フォームの再設定を行ってください。</span>'
				+ '<br><span style="font-size:11px;line-height:2;color:#666;">※フォームの再設定を行うことで、このお知らせは表示されなくなります。</span></div>';
	var $warnMsg = jQuery(warnMsg);
	if (bindobj.isCloudEditer) {
		var warnLink = '<a href="javascript:;" id="warn-authsub-form" target="_blank" style="color:#06f;border:none;background:none;">'
					+ '<span style="display:inline-block;width:0;height:0;border:4px solid transparent;border-left-color:#06f;font-size:0;line-height:0;"></span><span style="text-decoration:underline;">詳しくはこちら</span></a>';
		var $warnLink = jQuery(warnLink);
		$warnLink.click(function(){window.open('http://www.digitalstage.jp/go/sync5/sync_authsub_help.html');});
	} else {
		var warnLink = '<a href="http://www.digitalstage.jp/go/sync5/sync_authsub_help.html" id="warn-authsub-form" style="color:#06f;border:none;background:none;">'
					+ '<span style="display:inline-block;width:0;height:0;border:4px solid transparent;border-left-color:#06f;font-size:0;line-height:0;"></span><span style="text-decoration:underline;">詳しくはこちら</span></a>';
		var $warnLink = jQuery(warnLink);
	}
	var authsubWarnMsg = '<div style="box-sizing:border-box;max-width:800px;margin:10px auto;padding:16px;border:2px solid #c00;background-color:#ffd;font-size:13px;line-height:1.7;font-family:sans-serif;" id="authsub-warnning-msg"></div>';
	var $authsubWarnMsg = jQuery(authsubWarnMsg);
	$authsubWarnMsg.append($warnTitle);
	$authsubWarnMsg.append($warnMsg);
	$authsubWarnMsg.append($warnLink);
	return $authsubWarnMsg;
}

/** 公開サイト上 **/
function getAuthSubWarnMsg() {
	var warnTitle = '<div style="margin-bottom:.5em;padding-bottom:.5em;font-size:16px;line-height:1.1;font-weight:bold;color:#933;text-align:center;border-bottom:1px solid #933;">'
		+ '<span style="margin-right:5px;position:relative;display: inline-block;box-sizing:border-box;width:20px;height:20px;border:2px solid #933;border-radius:10px;font-size:0;line-height:0;vertical-align: bottom;">'
		+ '<span style="position:absolute;top:3px;left:50%;margin-left:-1px;width:2px;height:7px;background-color:#933;"></span>'
		+ '<span style="position:absolute;bottom:3px;left:50%;margin-left:-1px;width:2px;height:2px;background-color:#933;"></span>'
		+ '</span>'
		+ '<span>重要なお知らせ</span>'
		+ '</div>';
	var $warnTitle = jQuery(warnTitle);
	var warnMsg = '<div style="color:#222;">Google社のAPI提供終了に伴い、<span style="color:#c00;">現在こちらのフォームは使用できません。</span>'
				+ '<br>サイト管理者様は、編集画面よりフォームの再設定を行ってください。<br>'
				+ '<span style="font-size:11px;line-height:2;color:#666;">※フォームの再設定を行うことで、このお知らせは表示されなくなります。</span></div>';
	var $warnMsg = jQuery(warnMsg);
	var warnLink = '<a href="javascript:;" id="warn-authsub-form" target="_blank" style="color:#06f;border:none;background:none;">'
				+ '<span style="display:inline-block;width:0;height:0;border:4px solid transparent;border-left-color:#06f;font-size:0;line-height:0;"></span><span style="text-decoration:underline;">詳しくはこちら</span></a>';
	var $warnLink = jQuery(warnLink);
	$warnLink.click(function(){window.open('http://www.digitalstage.jp/go/sync5/sync_authsub_help.html');});
	var authsubWarnMsg = '<div style="box-sizing:border-box;max-width:800px;margin:10px auto;padding:16px;border:2px solid #933;background-color:#fff;font-size:13px;line-height:1.7;font-family:sans-serif;" id="authsub-warnning-msg"></div>';
	var $authsubWarnMsg = jQuery(authsubWarnMsg);
	$authsubWarnMsg.append($warnTitle);
	$authsubWarnMsg.append($warnMsg);
	$authsubWarnMsg.append($warnLink);
	return $authsubWarnMsg;
}
// AuthSub警告表示 20150311 END

function confirmForm(c, formId, json, type, frm) {

	c.style.display = 'none';
	var wrnA = jQuery('#warningA', c);
	var wrnA2 = jQuery('#warningA2', c);
	var inpA = jQuery('#inputA', frm);
	var cfmA = jQuery('#confirmA', frm);
	cfmA.html('');

	// for error check
	var sync_form_id = 'sync_form_' + formId;
	if (forms == null) forms = {};
	var fields = {
		'form_id' : formId,
		'back_url' : ((!json.back_url)?'':json.back_url),
		'back_txt' : ((!json.back_txt)?'':json.back_txt),
		'last_msg' : breakToTag(json.last_msg)
	};

	//var dtltxt = {};
	var total = DetailDat.fields.length;
	for (var i=0; i<total; i++) {
		fields[DetailDat.fields[i].id] = DetailDat.fields[i].deflabel;
		if (json.dtls) {
			var dtllen = json.dtls.length;
			for (var j=0; j<dtllen; j++) {
				if (DetailDat.fields[i].id == json.dtls[j].id) {
					fields[DetailDat.fields[i].id] = json.dtls[j].label;
				}
			}
		}
	}

	forms[sync_form_id] = fields;

	var required = jQuery('<span class="required"></span>');

	jQuery('<p class="note">').append(required.clone()).append(fields.txt_confirm).appendTo(cfmA);

	var frm = jQuery('<div></div>');
	var tbl = jQuery('<table class="table sync_form">');
	// comps
	jQuery.each(json.comps, function(i, c) {
		var tr = jQuery('<tr>');
		var th = jQuery('<th>').appendTo(tr).append(c.label);

		var td = jQuery('<td>');
		var fcnt = c.fields.length;

		// fields
		var has_required = false;
		jQuery.each(c.fields, function(j, f) {
			var id = f.id;
			fields[id] = f;

			//if (getByFieldId(id)=='email_check') { return false; }
			if (id.match(/.*email_check$/i)) { return false; }
			var sep = (id.indexOf('postal2') > -1 || id.indexOf('tel2') > -1 || id.indexOf('tel3') > -1) ? '':
				(getByFieldId(c.id)=='name' || getByFieldId(c.id)=='name_kana') ? '　':'<br />';
			if (j > 0) td.append(sep);
			if (fcnt > 1) {
				var cap = f.label;
				//if (cap != '−') cap += '：';
				if ((cap != '−') && (cap != '-')) cap += '：';
				jQuery('<label for="' + id + '">' + cap + '</label>').appendTo(td);
			}

			switch (f.type) {
			case 'テキスト':
			case '数値テキスト':
			case 'メールアドレス':
			case '複数行テキスト':
			case '選択リスト':
			case 'チェックボックス':
			case 'ラジオボタン':
				value = getValue(id, jQuery('#' + sync_form_id));
				value = escapeHTML(value);
				if (f.type=='複数行テキスト') {
					var CR = String.fromCharCode(13);
					var LF = String.fromCharCode(10);
					workVal = '';

					for (i=0; i<value.length; i++) {
						if (value.charAt(i)==CR) {
						} else if (LF==value.charAt(i)) {
							workVal += "<br>";
						} else {
							workVal += value.charAt(i);
						}
					}
					value = workVal;
				}
				var txt = jQuery('<span>' + value + '</span>');
				txt.appendTo(td);
				break;
			default:
			}
		});
		tr.append(td);
		tr.appendTo(tbl);
	});

	var footer = jQuery('<p class="ac">');

	//j<button class="sync_form_button">').append('内容を修正').click(function() {
	jQuery('<button class="sync_form_button">').append(fields.btn_correct).click(function() {
		pageBack(c, wrnA, wrnA2, inpA, cfmA);
		return false;
	}).appendTo(footer);

	//jQuery('<button class="sync_form_button">').append('送信').click(function() {
	jQuery('<button class="sync_form_button">').append(fields.btn_transmit).click(function() {
		var flds = forms[this.form.id];
		var hasError = false;
		var frm = this.form;
		jQuery.each(flds, function(i, f) {
			if (!chkOne(f, flds, frm)) hasError = true;
		});

		// 更新
		if (hasError == false) {
			tbl.hide();
			footer.hide();
			jQuery('#confirmA p.note', frm).hide();
			var sending = jQuery('<div class="loading">').height(tbl.height()).appendTo(c);

			fdata = {};
			jQuery.each(flds, function(key, f) {
				if (key == 'form_id')
					fdata['form_id'] = f;
				else if (key == 'last_msg' && key.indexOf('email_check')>=0) {
				}
				else {
					//fdata[f.id] = getValue(f.id, this.form);
					fdata[f.id] = getValue(f.id, frm);
				}
			});

			var form_tm = setTimeout(function() {
				sending.removeClass('loading');
				sending.height(0);
				tbl.show();
				footer.show();
				//alert('フォームの送信に失敗した可能性があります。\n再送信してください。');
				alert(flds.msg_send_failed);
			}, 60000);
			var baseurl = (type=='form5')?SYNC5_SERVER:((type=='form3')?SYNC3_SERVER:SYNC2_SERVER);
			if ((typeof(formOpt.oem) != 'undefined') && (formOpt.oem == '1'))
				fdata['ndl'] = '1';
			else
				fdata['ndl'] = '0';
			jQuery.ajax({
				//url: SYNC2_SERVER + 'sync/form_save.action',
				url: baseurl + 'sync/form_save.action',
				type: 'GET',
				dataType: 'jsonp',
				data: fdata,
				async: false,
				success: function(json) {
					clearTimeout(form_tm);

					// 終了メッセージの表示
					sending.removeClass('loading');
					//jQuery('<h3 class="ac"></h3>').append('<span class="sent_msg"></span>').append('送信を完了しました。').appendTo(sending);
					jQuery('<h3 class="ac"></h3>').append('<span class="sent_msg"></span>').append(flds.msg_send_success).appendTo(sending);
					sending.append('<br />');
					var endmsg = jQuery('<p class="lead ac">').hide().append(flds.last_msg).appendTo(sending);
					tbl.hide();
					footer.hide();
					endmsg.fadeIn(500);

					if (flds.back_txt!='') {
						var btnarea = jQuery('<p class="lead ac">').appendTo(sending);
						var btnback = jQuery('<button class="sync_form_button">').append(flds.back_txt).appendTo(btnarea);
						btnback.click(function () {
							location.href = (flds.back_url=='')?location.href:flds.back_url;
							return false;
						});
					}
				},
				error: function(xhr, status) {
					clearTimeout(form_tm);
					//alert('送信に失敗しました。');
					alert(flds.msg_send_error);
					pageBack(c, wrnA, wrnA2, inpA, cfmA);
				}
			});
		}
		return false;
	}).appendTo(footer);

	tbl.appendTo(frm);
	footer.appendTo(frm);
	var div = jQuery('<div class="indent tabular">').append(frm);
	div.appendTo(cfmA);

	wrnA.attr('style','display: none');
	wrnA2.attr('style','display: none');
	inpA.attr('style','display: none');
	cfmA.attr('style','display: visibility');
	jQuery(c).fadeIn(500);
}

function escapeHTML(val) {
	return jQuery('<div>').text(val).html();
}

function strchange_h2z(str,flg) {
	var han=new Array("1","2","3","4","5","6","7","8","9","0","-","^","\\",
		"q","w","e","r","t","y","u","i","o","p","@","[","a","s","d",
		"f","g","h","j","k","l",";",":","]","z","x","c","v","b","n"
		,"m",",",".","/","\\","!","\"","#","$","%","&","'","(",")","=",
		"~","|","Q","W","E","R","T","Y","U","I","O","P","`","{","A",
		"S","D","F","G","H","J","K","L","+","*","}","Z","X","C","V",
		"B","N","M","<",">","?","_","ｶﾞ","ｷﾞ","ｸﾞ","ｹﾞ","ｺﾞ","ﾀﾞ","ﾁﾞ","ﾂﾞ",
		"ﾃﾞ","ﾄﾞ","ﾊﾞ","ﾋﾞ","ﾌﾞ","ﾍﾞ","ﾎﾞ","ﾊﾟ","ﾋﾟ","ﾌﾟ","ﾍﾟ","ﾎﾟ","ｳﾞ","ｱ","ｲ",
		"ｳ","ｴ","ｵ","ｶ","ｷ","ｸ","ｹ","ｺ","ｻ","ｼ","ｽ","ｾ","ｿ","ﾀ","ﾁ",
		"ﾂ","ﾃ","ﾄ","ﾅ","ﾆ","ﾇ","ﾈ","ﾉ","ﾊ","ﾋ","ﾌ","ﾍ","ﾎ","ﾏ","ﾐ",
		"ﾑ","ﾒ","ﾓ","ﾔ","ﾕ","ﾖ","ﾗ","ﾘ","ﾙ","ﾚ","ﾛ","ﾜ","ｦ","ﾝ","ｧ",
		"ｨ","ｩ","ｪ","ｫ","ｯ","ｬ","ｮ","｡","､","･"," ");
	var zen=new Array("１","２","３","４","５","６","７","８","９","０","－","＾","￥",
		"ｑ","ｗ","ｅ","ｒ","ｔ","ｙ","ｕ","ｉ","ｏ","ｐ","＠","［","ａ","ｓ","ｄ",
		"ｆ","ｇ","ｈ","ｊ","ｋ","ｌ","；","：","］","ｚ","ｘ","ｃ","ｖ","ｂ","ｎ",
		"ｍ","，","．","／","￥","！","”","＃","＄","％","＆","’","（","）","＝",
		"〜","｜","Ｑ","Ｗ","Ｅ","Ｒ","Ｔ","Ｙ","Ｕ","Ｉ","Ｏ","Ｐ","‘","｛","Ａ",
		"Ｓ","Ｄ","Ｆ","Ｇ","Ｈ","Ｊ","Ｋ","Ｌ","＋","＊","｝","Ｚ","Ｘ","Ｃ","Ｖ",
		"Ｂ","Ｎ","Ｍ","＜","＞","？","＿","ガ","ギ","グ","ゲ","ゴ","ダ","ヂ","ヅ",
		"デ","ド","バ","ビ","ブ","ベ","ボ","パ","ピ","プ","ペ","ポ","ヴ","ア","イ",
		"ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ",
		"ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ",
		"ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヲ","ン","ァ",
		"ィ","ゥ","ェ","ォ","ッ","ャ","ョ","。","、","・","　");

	var wk="";
	var ch=0;
	for (i=0;i<str.length;i++){
		for(j in han){
			ch=1;
			if(flg==1){
				if (str.substr(i,2)==han[j]){
					wk+=String(zen[j]);
					ch=0;
					break;
				}
				if (str.substr(i,1)==han[j]){
					wk+=String(zen[j]);
					ch=0;
					break;
				}
			}
			if(flg==2){
				if (str.substr(i,1)==zen[j]){
					wk+=String(han[j]);
					ch=0;
					break;
				}
			}
		}
		if ((ch==1) && (str.substr(i,1)!="ﾞ" && str.substr(i,1)!="ﾟ")) {
			wk+=String(str.substr(i,1));
		}
	}
	return(wk);
}

function chgHankaku(frm,id,flg) {
	var obj = jQuery("[name="+id+"]", frm);
	var val = strchange_h2z(obj.val(),flg);
	obj.val(val);

}

function setZipAddress(frm, id) {
	//とりあえずさんぷるです。
	if (id.match(/^(.*)ps_postal([12])$/i)) {
		var prestr = RegExp.$1;
		var prefix = '';
		var suffix = '';
		if (jQuery('#'+prestr+'ps_postal1',frm).length > 0){
			prefix = jQuery('#'+prestr+'ps_postal1',frm).val();
			if (jQuery('#'+prestr+'ps_postal2',frm).length > 0){
				suffix = jQuery('#'+prestr+'ps_postal2',frm).val();
			}
			if ((prefix.length+suffix.length)>=7) {
				zip2addrs(frm,prestr,prefix,suffix);
			}
		}
	}
}

function zip2addrs(frm,prestr,prefix,suffix) {
	jQuery.ajax({
		url: SYNC5_SERVER + 'sync/addrs.action',
		type: 'GET',
		dataType: 'jsonp',
		data: {
			'prefix':prefix,
			'suffix':suffix
		},
		async: false,
		success: function(json) {
			if (json.pref.length>0) {
				if (jQuery('#'+prestr+'prefs',frm).lenght > 0) {
					jQuery('#'+prestr+'prefs',frm).val(json.pref);
				}
				if (jQuery('#'+prestr+'street1',frm).length > 0) {
					jQuery('#'+prestr+'street1',frm).val(json.addr1);
				}
			}
		},
		error: function(xhr, status) {
			//alert('送信に失敗しました。');
		}
	});
}

function chkInput(e) {
	var flds = forms[this.form.id]
	var f = flds[this.id];
	chkOne(f, flds, this.form);
}
function chkOne(f, flds, frm) {
	if (typeof(f) == 'string') return true;

	var msg = '';
	var val = getValue(f.id, frm);

	if (f.type == '数値テキスト') {
		chgHankaku(frm,f.id,'2');
	}
	if (f.req) {
		if (f.type == 'チェックボックス' || f.type == 'ラジオボタン') {
			if (f.req && val.length == 0) {
				//msg = '選択してください。';
				msg = flds.chk_sel_required;
			}
		} else {
			if (f.req && val.length == 0) {
				//msg = '入力してください。';
				msg = flds.chk_txt_required;
			}
		}
	}

	if (f.re.length > 0 && val.length > 0) {
		if (f.re.length > 0 && !val.match(eval(f.re))) {
			if (msg.length > 0) msg += '<br />';
			//msg += (f.err.length > 0) ? f.err:'正しい書式で入れてください。';
			msg += (f.err.length > 0) ? f.err: flds.chk_txt_format;
		}

	}

	if (f.type == 'テキスト' || f.type == '複数行テキスト' || f.type == '数値テキスト') {
		if (val.length > 500) {
			if (msg.length > 0) msg += '<br />';
			//msg += '送信できるテキストは５００文字以内です。';
			msg += flds.chk_txt_limit;
		}
	}

	// 確認用項目
	var pos = f.id.indexOf('_check');
	if (pos > -1) {
		var o = flds[f.id.substring(0, pos)];
		if (o) {
			if (jQuery('#' + o.id, frm).val() != val) {
				if (msg.length > 0) msg += '<br />';
				//msg += o.label + 'と一致しません。';
				msg += o.label + flds.chk_txt_conflict;
			}
		}
	}

	// エラー表示
	var msgArea = jQuery('#' + f.err_area, frm);
	if (msg.length == 0) {
		msgArea.slideUp();
		return true;
	} else {
		var dp = msgArea[0].style.display;
		if (dp == '' || dp == 'none') {
			msgArea.hide();
			//msgArea.removeClass('success_msg');
			msgArea.addClass('err_msg');
			msgArea.html(msg);
			msgArea.slideDown();
		} else {
			msgArea.addClass('err_msg');
			msgArea.html(msg);
		}
		return false;
	}

	return true;
}

function getValue(id, frm) {
	var value = "";
	var ctl = jQuery("[name="+id+"]", frm);
	if (ctl.attr("type")=="radio" || ctl.attr("type")=="checkbox") {
		var obj = jQuery("input:checked[name=" + id + "]", frm);
		for (i=0 ; i<obj.length ; i++) {
			if (i!=0) { value += ","; }
			value += obj.get(i).value;
		}
	} else {
		value = ctl.val();
	}
	return value;
}

function pageBack(c, wrnA, wrnA2, inpA, cfmA) {
	c.style.display = 'none';
	wrnA.attr('style','display: visibility');
	wrnA2.attr('style','display: visibility');
	inpA.attr('style','display: visibility');
	cfmA.attr('style','display: none');
	jQuery(c).fadeIn(500);
}


/**********
B L O G
********/
/*
 * ブログのパーツレンダラー
 */
function BlogHandler() {
	this.initialize.apply(this, arguments);
}
BlogHandler.prototype = {
	initialize: function(service, blogId, designId, option, c, sid) {
		this.service = service;
		this.blogId = blogId;
		this.designId = designId;
		this.option = option;
		this.oldId = sid;

		this.container = jQuery(c).empty();
		this.container.append('<span class="loading"></span>').show();

		this.rendered1st = false;
		// sideは最初のみ読み込み
		this.loadOnly1st = (this.designId.indexOf('side') > -1) ? true : false;
		if (this.designId == 'main01' || this.designId == 'side01') hashChangeFlg = true;
	},
	attachFeedLoader: function(loader) {
		this.feedLoader = loader;
	},
	loadStart: function() {
		if (this.rendered1st && this.designId.indexOf('side') == -1) {
			var wrap = this.container.find('#blogWrapper');
			wrap.empty();
			wrap.attr('className', 'loading');
		}
	},
	render: function(json) {
		this.json = json;
		var skin = getSkinClass(this.container[0]);
		this.skin = skin;

		switch (this.designId) {
		case 'title':
			this.renderTitle(json, skin);
			break;
		case 'table':
			this.renderTable(json, skin);
			break;
		case 'standard':
			this.renderStandard(json, skin);
			break;
		case 'paging':
			this.renderPaging(json, skin);
			break;
		case 'accordion':
			this.renderAccordion(json, skin);
			break;
		case 'tab':
			this.renderTab(json, skin);
			break;
		case 'main01':
			this.renderMain01(json, skin);
			break;
		case 'side01':
			if (this.rendered1st == false) this.renderBlogSide(json, skin);
			break;
		}

		if (typeof(this.labelArea) != 'undefined') {
			this.labelArea.html(json.headerGuide);
			this.labelArea.show();
		}

		this.rendered1st = true;

		this.container.width("100%");
		this.container.find('span').remove('span.loading');
		setAlign(this.container, jQuery(this.container).find('.table'));
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		finishSyncParts();
	},
	getHtmlLink: function(links) {
		var url = '';
		for (var i=0,l=links.length; i<l; i++) {
			var ln = links[i];
			if (ln.rel == 'alternate') {
				url = ln.href;
				break;
			}
		}
		return url;
	},
	renderHeaderV2: function(json, skin) {
		var url = this.getHtmlLink(json.feed.link);

		// タイトル
		var h3div = null;
		if (skin.indexOf('standard') > -1) {
			h3div = nineSlice('slice h3', this.container);
		} else {
			h3div = jQuery('<div class="h3"/>').appendTo(this.container);
		}

		var h3 = jQuery('<h3/>').appendTo(h3div);
		jQuery('<a href="' + url + '"></a>').append(json.feed.title.$t).appendTo(h3);

		// サブタイトル
		var subt = json.feed.subtitle;
		if (subt && subt.$t.length > 0)
			jQuery('<p class="lead"></p>').text(subt.$t).appendTo(this.container);
	},
	renderDetailV2: function(e, wrapper, skin) {
		var url = this.getHtmlLink(e.link);

		var h2 = null;
		if (skin.indexOf('standard') > -1) {
			h2 = jQuery('<span class="mc"></span>');
			var h2core = jQuery('<span class="mm"></span>').append(h2);
			var h2div = jQuery('<h2></h2>').append(h2core)
			jQuery('<div class="h2"></div>').append(h2div).appendTo(wrapper);
		} else {
			h2 = jQuery('<h2></h2>');
			jQuery('<div class="h2"></div>').append(h2).appendTo(wrapper);
		}
		var a = jQuery('<a href="' + url + '"></a>').append(e.title.$t).appendTo(h2);

		var bodyWrapper = jQuery('<div></div>').appendTo(wrapper);

		jQuery('<address class="ar"></address>').append(this.formatBlogDate(e.published.$t)).appendTo(bodyWrapper);

		if (e.content)
			bodyWrapper.append(e.content.$t).append('<br class="clear" />');
		else if (e.summary)
			bodyWrapper.append(e.summary.$t).append('<br class="clear" />');

		// for IE
		//this.normalizeObj(bodyWrapper);

		if (this.option.link_words != '') {
			var anc = jQuery('<a href="' + url + '"></a>').append(this.option.link_words + ' &gt;&gt;&gt;');
			var p = jQuery('<p class="kakomi ar"></p>').append(anc);
			jQuery('<div class="kakomi"></div>').append(p).appendTo(bodyWrapper);
		}

		jQuery('<div class="hr"></div>').appendTo(bodyWrapper);
	},
	cutBody: function(str) {
		var pos = str.indexOf('<br');
		var cutPt = 0;
		if (pos==-1) {
			pos = str.indexOf('</p>');
			cutPt = 4;
		}
		if (pos==-1) {
			pos = str.indexOf('</div>');
			cutPt = 6;
		}
		if (pos > -1) return str.substring(0, pos + cutPt);
		return str;
	},
	renderStandard: function(json, skin) {
		var clazz = this;

		jQuery.each(json.feed.entry, function(i, e) {
			clazz.renderDetailV2(e, clazz.container, skin);
		});
	},
	renderTitle: function(json, skin) {
		// タイトル、サブタイトル表示
		this.renderHeaderV2(json, skin);

		var dl = jQuery('<dl></dl>');
		jQuery('<div class="indent lined"></div>').append(dl).appendTo(this.container);

		// 記事一覧
		var ents = json.feed.entry;
		for (var i=0, l=ents.length; i<l; i++) {
			var e = ents[i];
			jQuery('<dt></dt>').append(this.formatBlogDate(e.published.$t)).appendTo(dl);
			var url = this.getHtmlLink(e.link);
			var a = jQuery('<a href="' + url + '"></a>').append(e.title.$t);
			jQuery('<dd></dd>').append(a).appendTo(dl);
		}

		// more
		if (this.option.link_words != '') {
			var url = this.getHtmlLink(json.feed.link);
			var anc = jQuery('<a href="' + url + '"></a>').append(this.option.link_words + ' &gt;&gt;&gt;');
			var p = jQuery('<p class="kakomi"></p>').append(anc);
			jQuery('<div class="kakomi"></div>').append(p).appendTo(this.container);
		}
	},
	renderTable: function(json, skin) {
		// タイトル、サブタイトル表示
		this.renderHeaderV2(json, skin);

		var div = jQuery('<div class="indent tabular"></div>');
		var table = jQuery('<table class="table"></table>').appendTo(div);

		// 記事一覧
		var ents = json.feed.entry;
		for (var i=0, l=ents.length; i<l; i++) {
			var e = ents[i];
			var tr = jQuery('<tr></tr>');
			var th = jQuery('<th><div class="th">' + this.formatBlogDate(e.published.$t) + '</div></th>').appendTo(tr);
			var td = jQuery('<td></td>').appendTo(tr);
			var url = this.getHtmlLink(e.link);
			var a = jQuery('<a href="' + url + '">' + e.title.$t + '</a>');
			var balloon = (skin.indexOf('standard') > -1) ? nineSlice('balloon', td) : jQuery('<div class="balloon"></div>').appendTo(td);
			balloon.append(a);

			var affix = jQuery('<p class="affix"></p>').append(e.content.$t).appendTo(td);
			// forIE
			//this.normalizeObj(affix);

			// more
			if (this.option.link_words != '') {
				var anc = jQuery('<a href="' + url + '"></a>').append(this.option.link_words + ' &gt;&gt;&gt;');
				jQuery('<p class="affix"></p>').append(anc).appendTo(td);
			}

			table.append(tr);
		}

		div.appendTo(this.container);

	},
	renderPaging: function(json, skin) {
		var prev = jQuery('<a href="#" class="prev"></a>').append('前のエントリーへ').click(jQuery.fnbind(this, this.pagePrev));
		var next = jQuery('<a href="#" class="next"></a>').append('次のエントリーへ').click(jQuery.fnbind(this, this.pageNext));
		jQuery('<p class="ac"></p>').append(prev).append('|').append(next).appendTo(this.container);
		jQuery('<div class="hr"></div>').appendTo(this.container);

		jQuery('<div id="blogWrapper"></div>').appendTo(this.container);

		// more
		if (this.option.link_words != '') {
			var url = this.getHtmlLink(json.feed.link);
			var anc = jQuery('<a href="' + url + '"></a>').append(this.option.link_words + ' &gt;&gt;&gt;');
			var p = jQuery('<p class="kakomi ar"></p>').append(anc);
			jQuery('<div class="kakomi"></div>').append(p).appendTo(this.container);
		}

		jQuery('<div class="hr"></div>').appendTo(this.container);
		var prevB = jQuery('<a href="#" class="prev"></a>').append('前のエントリーへ').click(jQuery.fnbind(this, this.pagePrev));
		var nextB = jQuery('<a href="#" class="next"></a>').append('次のエントリーへ').click(jQuery.fnbind(this, this.pageNext));
		jQuery('<p class="ac"></p>').append(prevB).append('|').append(nextB).appendTo(this.container);

		this.pageDisp(0);
	},
	pageNext: function() {
		if (this.pageIndex < this.json.feed.entry.length) this.pageDisp(this.pageIndex + 1);
	},
	pagePrev: function() {
		if (this.pageIndex > 0) this.pageDisp(this.pageIndex - 1);
	},
	pageDisp: function(idx) {
		var ents = this.json.feed.entry;
		if (ents.length > idx) {
			var e = ents[idx];
			var blogWrapper = jQuery(this.container).find('#blogWrapper');
			blogWrapper.html('');

			var h2 = null;
			if (this.skin.indexOf('standard') > -1) {
				h2 = jQuery('<span class="mc"></span>');
				var h2core = jQuery('<span class="mm"></span>').append(h2);
				var h2div = jQuery('<h2></h2>').append(h2core)
				jQuery('<div class="h2"></div>').append(h2div).appendTo(blogWrapper);
			} else {
				h2 = jQuery('<h2></h2>');
				jQuery('<div class="h2"></div>').append(h2).appendTo(blogWrapper);
			}
			var ary = e.id.$t.split('-');
			var eid = ary[ary.length-1];
			var url = this.getHtmlLink(e.link);
			var a = jQuery('<a href="' + url + '"></a>').append(e.title.$t).appendTo(h2);

			jQuery('<address class="ar"></address>').append(this.formatBlogDate(e.published.$t)).appendTo(blogWrapper);
			blogWrapper.append(e.content.$t + '<br /><br class="clear" />');

			// for IE
			//this.normalizeObj(blogWrapper);

			if (idx == 0) {
				jQuery('a.prev').css('visibility', 'hidden');
			} else {
				jQuery('a.prev').css('visibility', 'visible');
			}

			if (idx == ents.length-1) {
				jQuery('a.next').css('visibility', 'hidden');
			} else {
				jQuery('a.next').css('visibility', 'visible');
			}

			this.pageIndex = idx;
		}
	},
	normalizeObj: function(dest) {
		if ( !jQuery.support.opacity ) {
			jQuery('object', dest).each(function(i, obj) {
				var jqObj = jQuery(obj);
				var ah = jqObj.attr('altHtml');
				if (typeof(ah) == 'undefined') {
					ah = obj.altHtml;
				}
				if (ah.length > 0) jqObj.replaceWith(ah);
			});
		}
	},
	renderAccordion: function(json, skin) {
		this.container.html('アコーディオン！');
	},
	renderTab: function(json, skin) {
		this.container.html('タブ！');
	},
	// ブログのメイン部の書き出し処理
	//
	renderMain01: function(json, skin) {
		var blogWrapper = null;

		// まだ初期描画をしていない時
		if (this.rendered1st == false && json.feed) {
			// タイトル
			var h3div = null;
			if (skin.indexOf('standard') > -1) {
				h3div = nineSlice('slice h3', this.container);
			} else {
				h3div = jQuery('<div class="h3"/>').appendTo(this.container);
			}

			var h3 = jQuery('<h3/>').appendTo(h3div);
			jQuery('<a href="javascript:;"></a>').append(json.feed.title.$t).bind('click', function(e) {
				SWFAddress.setValue('');
			}).appendTo(h3);
			this.labelArea = jQuery('<span id="blog-pwd"></span>').appendTo(h3);

			// サブタイトル
			var subt = json.feed.subtitle;
			if (subt && subt.$t.length > 0)
				jQuery('<p class="lead"></p>').text(subt.$t).appendTo(this.container);

			blogWrapper = jQuery('<div id="blogWrapper"></div>').appendTo(this.container);

		} else {
			blogWrapper = jQuery(this.container).find('#blogWrapper');
			blogWrapper.removeClass('loading');

		}

		if (json.feed) {
			var clazz = this;
			jQuery.each(json.feed.entry, function(i, e) {
				clazz.renderDetail(e, blogWrapper, skin);
			});
		} else {
			this.renderDetail(json.entry, blogWrapper, skin);
		}

	},
	renderDetail: function(e, blogWrapper, skin) {
		var wrapper = jQuery('<div class="entryWrapper"></div>').appendTo(blogWrapper);

		var h2 = null;
		//if (skin.indexOf('standard') > -1) {
		//	h2 = jQuery('<span class="mc"></span>');
		//	var h2core = jQuery('<span class="mm"></span>').append(h2);
		//	var h2div = jQuery('<h2></h2>').append(h2core)
		//	jQuery('<div class="h2"></div>').append(h2div).appendTo(wrapper);
		//} else {
			h2 = jQuery('<h2></h2>');
			jQuery('<div class="h2"></div>').append(h2).appendTo(wrapper);
		//}
		var ary = e.id.$t.split('-');
		var eid = ary[ary.length-1];
		var a = jQuery('<a href="javascript:;"></a>').append(e.title.$t).bind('click', {blogId: this.blogId, entryId: eid}, function(e) {
			SWFAddress.setValue('detail/' + e.data.entryId);
		}).appendTo(h2);

		jQuery('<address class="ar"></address>').append(this.formatBlogDate(e.published.$t)).appendTo(wrapper);
		wrapper.append(e.content.$t).append('<br class="clear" />');

		// for IE
		//this.normalizeObj(wrapper);

		// 投稿者が取得できるのはBloggerのみ
		if (this.service == 'google') {
			var link = this.findCommentLink(e.link);
			var footer = jQuery('<p class="kakomi ar"></p>').append('投稿者：');
			if (skin.indexOf('standard') > -1) {
				var mm = nineSlice('slice kakomi', wrapper);
				mm.append(footer);
			} else {
				jQuery('<div class="kakomi"></div>').append(footer).appendTo(wrapper);
			}
			for (var i=0; i<e.author.length; i++) {
				if (i > 0) footer.append(', ');
				var auth = e.author[i];
				if (auth.uri)
					jQuery('<a target="_blank"></a>').text(auth.name.$t).attr('href', auth.uri.$t).appendTo(footer);
				else
					footer.append(auth.name.$t);
			}

			footer.append('&nbsp;&nbsp;&nbsp;');

			a = jQuery('<a></a>').attr({href: link.href, title: link.title});
			a.text(link.text);
			a.appendTo(footer);
		}

		jQuery('<div class="hr"></div>').appendTo(wrapper);

	},
	renderBlogSide: function(json, skin) {
		var clazz = this;

		if (this.rendered1st == false) {
			// カレンダー
			var calWrap = jQuery('<div class="calWrapper"></div>').appendTo(this.container);
			jQuery('<h3 class="ac" id="blog-calendar-ym"></h3>').appendTo(calWrap);
			var calHdr = jQuery('<div class="calHdr"></div>').appendTo(calWrap);
			jQuery('<a href="javascript:;" class="prevM">&lt;&lt;</a>').appendTo(calHdr).click(function(e) {
				clazz.moveMonth(-1);
			});
			jQuery('<a href="javascript:;" class="nextM">&gt;&gt;</a>').appendTo(calHdr).click(function(e) {
				clazz.moveMonth(1);
			});
			jQuery('<div class="hr clear"></div>').appendTo(calWrap);
			this.calArea = jQuery('<div id="blog-calendar-area"></div>').appendTo(calWrap);

			jQuery('<div class="hr"></div>').appendTo(this.container);
		}

		// カレンダー読み込み
		this.loadCalendar();

	},

	loadCalendar: function(ym) {
		this.calArea.empty();
		this.calArea.attr('className', 'loading');

		var y, m;
		if (ym == null) {
			var d = new Date();
			y = d.getFullYear();
			m = d.getMonth() + 1;
		} else {
			y = new Number(ym.substring(0, 4));
			sm = ym.substring(4);
			if (sm.substring(0, 1) == '0') sm = sm.substring(1);
			m = new Number(sm);
		}

		jQuery('#blog-calendar-ym').text(y + '年 ' + m + '月');

		var st = new Date(y, m - 1, 1);
		var ed = new Date(y, m, 0, 23, 59, 59);	//月末
		var published_min = formatFeedDate(st);
		var published_max = formatFeedDate(ed);

		var url = '';
		copyOpt = {};
		if (this.service == 'google') {
			if (this.oldId != '') {
				url = PRTCL + '//www.blogger.com/feeds/' + this.oldId + '/posts/default';
			} else if (this.blogId.length > 0) {
				url = PRTCL + '//' + this.blogId + '.blogspot.com/feeds/posts/default';
			}
			url += '?redirect=false' +
				'&published-min=' + published_min +
				'&published-max=' + published_max +
				'&alt=json-in-script&callback=?';
		} else {
			url = SYNC5_SERVER + "blog/rss/json?callback=?";
			copyOpt = objClone(this.option);
			copyOpt.published_min = published_min;
			copyOpt.published_max = published_max;
		}

		var clazz = this;
		jQuery.getJSON(url, copyOpt, function(json) {
			// カテゴリ
			// amebaはカテゴリーが取得できないので
			if (clazz.service != 'ameba') {
				var ul = clazz.container.children('#category-list');
				if (ul.length == 0) {
					jQuery('<h4>ラベル</h4>').appendTo(clazz.container);
					ul = jQuery('<ul id="category-list" class="disc"></ul>').appendTo(clazz.container);

					jQuery('<div class="hr"></div>').appendTo(clazz.container);
				}

				// カテゴリ表示
				catList = [];
				clazz.renderCategory(ul, json);
			}

			// カレンダー描画
			clazz.calArea.removeAttr('className');
			clazz.calArea.find('table#blog-calendar').remove();
			var list = [];
			if (json.feed.entry) {
				jQuery.each(json.feed.entry, function(i, e) {
					var o = {
						title: e.title.$t,
						pubdate: parseFeedDate(e.published.$t)
					};
					list.push(o);
				});
			}

			var calTbl = jQuery('<table id="blog-calendar"></table>').appendTo(clazz.calArea);

			var tr  = jQuery('<tr></tr>').appendTo(calTbl);
			for (var i=0; i<7; i++) {
				var d = '';
				switch (i) {
					case 0: d = '日'; break;
					case 1: d = '月'; break;
					case 2: d = '火'; break;
					case 3: d = '水'; break;
					case 4: d = '木'; break;
					case 5: d = '金'; break;
					case 6: d = '土'; break;
				}
				jQuery('<th>' + d + '</th>').appendTo(tr);
			}

			var day = 1;
			var dt = st;
			var stw = dt.getDay();
			var iniMon = dt.getMonth();
			var inCal = false;
			for (var i=0; i<6; i++) {
				tr = jQuery('<tr></tr>').appendTo(calTbl);
				for (var j=0; j<7; j++) {
					if (i==0 && !inCal && j==stw) inCal = true;

					if (inCal) {
						var e = clazz.findEntry(dt, list);

						if (e != null) {
							var td = jQuery('<td></td>').appendTo(tr);
							var a = jQuery('<a href="javascript:;"></a>').attr('title', e.title).text(dt.getDate()).appendTo(td).click(function(evt) {
								SWFAddress.setValue('list/' + this.rel);
							});
							a.attr('rel', e.pubdate.ymd);
						} else {
							jQuery('<td></td>').appendTo(tr).text(dt.getDate());
						}
						day++;
						dt.setDate(day);
						if (dt.getMonth() != iniMon) inCal = false;
					} else {
						jQuery('<td></td>').appendTo(tr).html('&nbsp;');
					}
				}
				if (i > 1 && inCal == false) break;
			}
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
		});

	},

	renderCategory: function(wrapper, json) {
		wrapper.empty();
		if (json.feed.entry) {
			jQuery.each(json.feed.entry, function(i, e) {
				if (e.category) {
					for (var i=0; i<e.category.length; i++) {
						var nm = e.category[i].term;
						if (nm != '' && jQuery.inArray(nm, catList) == -1) {
							var a = jQuery('<a href="javascript:;"></a>').text(nm).click(function() {
								SWFAddress.setValue('label/' + encodeURIComponent(jQuery(this).text()));
							});
							jQuery('<li></li>').append(a).appendTo(wrapper);
							catList.push(nm);
						}
					}
				}
			});
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
		}
	},

	moveMonth: function(amont) {
		if (!this.currentYm) this.currentYm = getYm();
		this.currentYm.setMonth(this.currentYm.getMonth() + amont);
		var ym = String(this.currentYm.getFullYear()) + zeroPad(String(this.currentYm.getMonth() + 1));
		this.loadCalendar(ym);
	},

	formatBlogDate: function(srcString) {
		var d = parseFeedDate(srcString);
		return d.year + '年' + d.month + '月' + d.day + '日&nbsp;&nbsp;' + d.tm;
	},

	findCommentLink: function(links) {
		var o = {};
		for (var i=0; i<links.length; i++) {
			var link = links[i];
			if (link.rel == 'replies') {
				if (link.type == 'text/html') {
					o.href = link.href;
					o.text = link.title;
				} else {
					o.title = link.title;
				}
			}
		}
		return o;
	},

	findEntry: function(dt, list) {
		for (var i=0; i<list.length; i++) {
			var o = list[i];
			var pub = o.pubdate;
			if (dt.getFullYear() == pub.year
				&& dt.getMonth() + 1 == pub.month
				&& dt.getDate() == pub.day) {
				return o;
			}
		}
		return null;
	}
};

/*
 * ブログのFeed管理クラス
 */
function FeedManager() {
	this.initialize.apply(this, arguments);
}
FeedManager.prototype = {
	initialize: function() {
		this.db = {};
		this.gfeeds = [];
	},
	addFeed: function(service, blogId, designId, option, container, sid) {
		var handler = new BlogHandler(service, blogId, designId, option, container, sid);
		if (service=='google') {
			this.gfeeds.push(new FeedLoader(service, blogId, option, handler, sid));
		} else {
			var key = service + ':' + blogId;
			if (!(key in this.db)) {
				this.db[key] = new FeedLoader(service, blogId, option, handler, sid);
			} else {
				var ldr = this.db[key];
				ldr.addFeed(handler);
			}
		}
	},
	load: function(evt) {
		var path = '/';
		if (typeof(evt) != 'undefined') {
			path = evt;
		}

		if (path == 'page') return;

		var args = path.split('/');
		var type = (args.length > 1) ? args[1] : '';
		var param1 = (args.length > 2) ? args[2] : '';
		var param2 = (args.length > 3) ? args[3] : '';

		for (var i=0,l=this.gfeeds.length; i<l; i++) {
			var ldr = this.gfeeds[i];
			ldr.load(type, param1, param2);
		}

		for (var key in this.db) {
			var ldr = this.db[key];
			ldr.load(type, param1, param2);
		}
	}
};

/*
 * ブログのFeed読み込みクラス
 */
function FeedLoader() {
	this.initialize.apply(this, arguments);
}
FeedLoader.prototype = {
	initialize: function(service, blogId, option, handler, sid) {
		this.service = service;
		this.blogId = blogId;
		this.option = option;
		this.oldId = sid;
		this.loaded1st = false;
		this.detailTopMode = false;
		this.addFeed(handler);
	},
	addFeed: function(handler) {
		handler.attachFeedLoader(this);
		if (!this.handlers) this.handlers = [];
		this.handlers.push(handler);
	},
	load: function(type, param1, param2) {
		// ローディング表示
		this.doLoading();

		// ブックマークなどで、詳細ページが最初から読まれた場合の対処
		if (this.loaded1st == false && type == 'detail') {
			this.detailTopMode = true;
			this.getDetailTopFeed(type, param1, param2);
			return;
		}

		// 通常の読み込み
		var url = '';
		var loadOpt = {};
		var guide = '';
		var published_min = '';
		var published_max = '';

		if (type == 'label') {
			guide = ' − ラベル：「' + decodeURI(param1) + '」のリスト';

		} else if (type == 'list') {
			var y = param1.substring(0, 4);
			var m = new Number(omitZero(param1.substring(4, 6)));
			var d = omitZero(param1.substring(6));
			var st = new Date(y, m - 1, d);
			var ed = new Date(y, m - 1, d, 23, 59, 59);
			published_min = formatFeedDate(st);
			published_max = formatFeedDate(ed);

			guide = ' − ' + y + '年' + m + '月' + d + '日のリスト';
		}

		if (this.service == 'google') {
			var dt_condition = '';
			if (this.blogId == 'aaaa') {
				this.oldId = '3954754025523399702';
				//this.blogId = 'digitalstagedemo';
			}
			if (this.oldId != '') {
				url = PRTCL + '//www.blogger.com/feeds/' + this.oldId + '/posts/default';
			} else if (this.blogId.length > 0) {
				url = PRTCL + '//' + this.blogId + '.blogspot.com/feeds/posts/default';
			}

			if (type == 'detail') {
				url += '/' + param1;

			} else if (type == 'label') {
				url += '/-/' + param1;

			} else if (type == 'list') {
				dt_condition = '&published-min=' + published_min +
							'&published-max=' + published_max;

			}

			url += '?redirect=false';
			url += dt_condition;
			if (type != 'label' && type != 'detail') url += '&max-results=' + this.option.max_results;
			url += '&alt=json-in-script&callback=?';

		} else {
			url = SYNC5_SERVER + "blog/rss/json?callback=?";
			loadOpt = objClone(this.option);
			if (type == 'detail') loadOpt.entryid = param1;
			else if (type == 'label') loadOpt.category = param1;
			else if (type == 'list') {
				loadOpt.published_min = published_min;
				loadOpt.published_max = published_max;
			}
		}

		var clazz = this;

		jQuery.getJSON(url, loadOpt, function(json) {
			json.headerGuide = guide;

			if (clazz.detailTopMode && clazz.detailTopFeed != null) {
				clazz.detailTopFeed.feed.entry = [];
				clazz.detailTopFeed.feed.entry[0] = json.entry;
				json = clazz.detailTopFeed;
				clazz.detailTopMode = false;
			}

			clazz.feed = json;
			clazz.doCallback(json);
			clazz.loaded1st = true;
		});
	},
	getDetailTopFeed: function(type, param1, param2) {
		var url = '';
		var loadOpt = {};
		if (this.service == 'google') {
			if (this.oldId != '') {
				url = PRTCL + '//www.blogger.com/feeds/' + this.oldId + '/posts/default';
			} else {
				url = 'http://' + this.blogId + '.blogspot.com/feeds/posts/default';
			}
			url += '?redirect=false&max-results=1&alt=json-in-script&callback=?';

		} else {
			url = SYNC5_SERVER + "blog/rss/json?callback=?";
			loadOpt = objClone(this.option);
		}

		jQuery.getJSON(url, loadOpt, jQuery.fnbind(this, function(json) {
			this.detailTopFeed = json;
			this.loaded1st = true;
			this.load(type, param1, param2);
		}));

	},
	doLoading: function() {
		for (var i=0,l=this.handlers.length; i<l; i++) this.handlers[i].loadStart();
	},
	doCallback: function(json) {
		for (var i=0,l=this.handlers.length; i<l; i++) this.handlers[i].render(json);
	}
};

/**********
Yahoo! Map
********/
function SyncYMap() {
	this.initialize.apply(this, arguments);
}
SyncYMap.prototype = {
	countDown: 2,
	initialize: function(sid, c, tp) {
		this.mapId = sid;
		this.cnt = c;
		this.type = tp;

		if (ymapLoader == null) {
			ymapLoader = new YMapLoader();
		}
		ymapLoader.addMap(this);

		jQuery.getJSON(this.getServer() + 'sync/ymap?callback=?', {s : this.mapId}, jQuery.fnbind(this, function(json) {
			this.mapdata = eval('(' + json.mapdata + ')');
			if (typeof(this.mapdata.wUnit) == 'undefined') this.mapdata.wUnit = 'px';
			this.countDown--;
			this.render();
		}));
	},
	getServer: function() {
		return (this.type=='map') ? SYNC3_SERVER:SYNC5_SERVER;
	},
	onApiLoaded: function() {
		this.countDown--;
		this.render();
	},
	render: function() {
		if (this.countDown == 0) {
			this.dispMap();
		}
	},
	dispMap: function() {
		var w = this.mapdata.w;
		var bkW = getBkWidth(jQuery(this.cnt));
		if (this.mapdata.wUnit == '%') {
			w = bkW * this.mapdata.w / 100;
		} else {
			w = (this.mapdata.w > bkW) ? bkW : this.mapdata.w;
		}
		var div = jQuery('<div></div>').width(w).height(this.mapdata.h);
		jQuery(this.cnt).html('').append(div).show();

		this.map = new Y.Map(div, {
			configure: {
				continuousZoom:true
			}
		});
		if (bindobj.isCloud) this.map.setApplicationId("dj0zaiZpPXJXbklLbGc1T3JNMSZzPWNvbnN1bWVyc2VjcmV0Jng9ZmQ-");
		this.map.addControl(new Y.LayerSetControl());
		this.cmark = new Y.CenterMarkControl({ visibleButton: true, visible: this.mapdata.centerMark });
		this.map.addControl(this.cmark);
		this.map.addControl(new Y.SliderZoomControlVertical(),
			new Y.ControlPosition(Y.ControlPosition.TOP_LEFT, new Y.Size(0, 28)) );
		this.map.addControl(new Y.ScaleControl());
		this.map.removeLayerSet(Y.LayerSetId.B1);
		this.map.drawMap(new Y.LatLng(this.mapdata.lat, this.mapdata.lng), this.mapdata.zoom, this.mapdata.layer);

		for (var k in this.mapdata.markers) {
			var mkdt = this.mapdata.markers[ k ];
			if (mkdt.url.indexOf('/pics/') == 0)
				mkdt.url = this.getServer() + mkdt.url.substring(1);
			var mk = new Y.Marker(new Y.LatLng(mkdt.lat, mkdt.lng), {
				icon: new Y.Icon(mkdt.url)
			});

			mk.id = k;
			this.map.addFeature(mk);

			this.setMarkerCaption(mk, mkdt.title, mkdt.body);

		}

		this.cnt.style.display = '';
		setAlign(this.cnt);
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		finishSyncParts();
	},
	setMarkerCaption: function(mk, ttl, body) {
		var buff = '';
		if (ttl != '') buff += '<h3>' + ttl + '</h3>';
		if (body != '') buff += body;
		if (ttl != '' || body != '') mk.bindInfoWindow( buff );

		mk.setTitle(ttl);
	}
};

var ymapLoader = null;
function YMapLoader() {
	this.initialize.apply(this, arguments);
}
YMapLoader.prototype = {
	isLoaded: false,
	maps: [],
	initialize: function() {
		var src = 'https://map.yahooapis.jp/js/V1/jsapi?appid=iSiHwv2xg66mcy5bW_maWJ0rQ2AebH2VxFHFOhZRjSOhe0ZcN_.bjwW9z3oduzc-';
		/*if (bindobj.isCloud && (!bindobj.isBind8))
			src = 'https://ssl.api.olp.yahooapis.jp/OpenLocalPlatform/V1/jsapi?appid=dj0zaiZpPXJXbklLbGc1T3JNMSZzPWNvbnN1bWVyc2VjcmV0Jng9ZmQ-';
		else
			src = 'http://js.api.olp.yahooapis.jp/OpenLocalPlatform/V1/jsapi?appid=iSiHwv2xg66mcy5bW_maWJ0rQ2AebH2VxFHFOhZRjSOhe0ZcN_.bjwW9z3oduzc-';
			*/
		var script_tag = document.createElement('script');
		script_tag.type = 'text/javascript';
		// 単体・テスト環境ではapiはhttpを使用
		//script_tag.src = 'http://js.api.olp.yahooapis.jp/OpenLocalPlatform/V1/jsapi?appid=iSiHwv2xg66mcy5bW_maWJ0rQ2AebH2VxFHFOhZRjSOhe0ZcN_.bjwW9z3oduzc-';
		script_tag.src = src;
		document.body.appendChild(script_tag);

		this.tm = setInterval(jQuery.fnbind(this, this.checkLoaded), 100);
	},
	checkLoaded: function() {
		if (typeof(Y) != 'undefined') {
			clearInterval(this.tm);
			this.isLoaded = true;

			for (var i=0; i<this.maps.length; i++) {
				var map = this.maps[ i ];
				map.onApiLoaded();
			}
		}
	},
	addMap: function(ymap) {
		if (this.isLoaded) {
			ymap.onApiLoaded();
		} else {
			this.maps.push(ymap);
		}
	}
};

/**********
V I D E O
********/
function getYTHeight(w) {
	return Math.floor(w / 16 * 9 + 25);
}

function dispVideo(c, sid, did, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	setVideo(c, sid, did, opt);

	var evt = (isIpad || isIphone) ? 'orientationchange' : 'resize';
	//var evt = (isMobile) ? 'orientationchange' : 'resize';
	// portrait
	var orientation = 0;
	if (isAndroid) {
		// landscape
		if (window.innerHeight < window.innerWidth) orientation = 1;
	}
	jQuery(window).on(evt, function(e) {
		var ele =  DocumentGetFullscreenElement(document);
		if ( ele == null ) {
			if ( fullScreenFlg == 0 ) {
				if (isAndroid) {
					var disp = (window.innerHeight > window.innerWidth) ? 0 : 1;
					if (orientation != disp) {
						setVideo(c, sid, did, opt);
						orientation = disp;
					}
				} else {
					setVideo(c, sid, did, opt);
				}
			} else {
				fullScreenFlg--;
			}
		} else {
			// Full Screen
			fullScreenFlg++;
		}
	});
}

function setVideo(c, sid, did, opt) {

	var buf = '';
	sid = sid.replace('http:',PRTCL);
	//var plyW = (getBkWidth(jQuery(c)) < opt.playerWidth) ? getBkWidth(jQuery(c)) : opt.playerWidth;
	var plyW = (getBkWidth(jQuery(c)) < opt.playerWidth) ? '100%' : opt.playerWidth;
	var pos = sid.lastIndexOf('/');
	var vid = sid.substring(pos+1);

	//var h = getYTHeight(plyW);
	var h = (getBkWidth(jQuery(c)) < opt.playerWidth) ? getYTHeight(getBkWidth(jQuery(c))) : getYTHeight(plyW);
	var a = '';
	if (sid.indexOf('playlists') > -1) {
		a = '/videoseries?'
		a += 'list=PL' + vid;
		a += (opt.autoLoop) ? '&loop=1':'';
	} else {
		a = '/' + vid;
		a += '?loop=' + ((opt.autoLoop) ? '1&playlist=' + vid:'0');
	}
	// 編集モードON時は、自動再生OFF
	var autoPlayFlg = (opt.autoPlay) ? '1':'0';
	if (bindobj.isCloudEditer && _bind.fn.isEditBlock())
		autoPlayFlg = '0';
	a += '&autoplay=' + autoPlayFlg;
	a += '&fs=1&rel=0';

	if (jQuery(c).find('iframe').length > 0) {
		jQuery(c).find('iframe').width(plyW);
		jQuery(c).find('iframe').height(h);
	} else {
		buf += '<iframe width="' + plyW + '" height="' + h + '" src="' + PRTCL + '//www.youtube.com/embed' + a + '" frameborder="0"  allowfullscreen></iframe>';

		buf += '<br /><br />';
		c.innerHTML = buf;

		c.style.display = '';
		//c.style.textAlign = 'center';
		if(c.parentElement.parentElement.style.height){
			var oh = c.parentElement.parentElement.style.height;
			c.parentElement.parentElement.style.height = (Number(oh.replace('px','')) + h) + 'px';
		}
	}
	if (plyW == '100%') jQuery(c).css('width', '100%');
	if (jQuery(c).closest('.b-tab_contents').length > 0) {
		if (plyW == '100%') jQuery(c).css('width', '110%');
		jQuery(c).closest('.b-tab_contents').height(h);
		var _bdTab = $.extend(true, _bind.base.tab, {});
		_bdTab.target = jQuery(c).closest('.b-tab')[0];
		_bdTab.init();
		_bdTab.resize();
		/*var _this = {};
		_this.target = jQuery(c).closest('.b-tab')[0];
		_bind.base.tab.init.apply(_this);
		_bind.base.tab.resize.apply(_this);*/
	}
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}

var Utils = function() {
};
Utils.prototype = {
};

/*******
 * Utils
 ********/
//cにアペンドして、mcを返す
function nineSlice(cls, c) {
	var mc = jQuery('<div class="mc"></div>');
	var mm = jQuery('<div class="mm"></div>').append('<div class="ml"></div>').append('<div class="mr"></div>').append(mc);
	var h3 = jQuery('<div class="' + cls + '"></div>')
		.append('<div class="tl"></div>').append('<div class="tr"></div>').append('<div class="tc"></div>').append(mm);
	h3.append('<div class="bl"></div>').append('<div class="br"></div>').append('<div class="bc"></div>').appendTo(c);
	return mc;
}

function getSkinClass(c) {
	/*var p = c.parentNode;
	while(true) {
		if (p.tagName && p.tagName=='body') return;
		var cls = p.className;
		if (cls.indexOf('simple')==0 || cls.indexOf('standard')==0) return cls;
		p = p.parentNode;
	}*/
	// レスポンシブ形式対応で常にsimpleを返却
	return 'simple';
}

function getYm() {
	var d = new Date();
	d.setDate(1);
	d.setHours(0);
	d.setMinutes(0);
	d.setSeconds(0);
	d.setMilliseconds(0);
	return d;
}

// feed 日付変換
function formatFeedDate(dt) {
	var y = String(dt.getFullYear());
	var m = zeroPad(String(dt.getMonth() + 1));
	var d = zeroPad(String(dt.getDate()));
	var h = zeroPad(String(dt.getHours()));
	var mi = zeroPad(String(dt.getMinutes()));
	var s = zeroPad(String(dt.getSeconds()));
	return y + '-' + m + '-' + d + 'T' + h + ':' + mi + ':' + s + '%2b09:00';
}

// feed 日付解析
function parseFeedDate(s) {
	var local = s.substring(0, s.length - 6);
	var ary = local.split('T');
	var dary = ary[0].split('-');
	var wk = ary[1].split('.');
	var tary = wk[0].split(':');
	var ms = wk[1];
	var o = {
		year: dary[0],
		month: omitZero(dary[1]),
		day: omitZero(dary[2]),
		hour: omitZero(tary[0]),
		min: omitZero(tary[1]),
		sec: omitZero(tary[2]),
		tm: omitZero(tary[0]) + ':' + tary[1]
	};
	o['ymd'] = o.year + zeroPad(o.month) + zeroPad(o.day);
	return o;
}

function zeroPad(s) {
	if (s.length==1) return '0' + s;
	return s;
}

// ゼロ除去。先頭のみ
function omitZero(s) {
	if (s.substring(0, 1) == '0') return s.substring(1);
	return s;
}

function breakToTag(str) {
	rtn = str.replace(/\r\n/ig, '<br />');
	rtn = rtn.replace(/\n/ig, '<br />');
	rtn = rtn.replace(/\r/ig, '<br />');
	return rtn;
}

/* オブジェクトコピー */
function objClone(obj) {
	var func = function(){};
	func.prototype = obj;
	return new func;
}

function getByFieldId(id) {
	if (id.indexOf('__')>0) {
		return id.substring(0,id.indexOf('__'));
	}
	return id;
}

function findWord(id,word) {
	res = false;
	if (id.indexOf(word)>=0) {
		res = true;
	}
	return res;
}

function getParameters(params) {

	if (params.indexOf('{')>=0 && params.indexOf('}')>=0) {
		var startidx = params.indexOf('{');
		var endidx = params.indexOf('}');
		option = JSON.parse(params.substring(startidx,endidx+1));
	}
	return option;
}

function getSyncPartsId() {
	partsId++;
	return 'syncpt-' + String(partsId);
}




var load = function(src, check, next) {
	check = new Function('return !!(' + check + ')');
	if (!check()) {
		var script = document.createElement('script')
		script.src = src;
		document.body.appendChild(script);
		setTimeout(function() {
			if (!check()) setTimeout(arguments.callee, 100);
			else next();
		}, 100);
	}
	else next();
}



/*************
T W I T T E R
*************/
function dispTwitter(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'center';

	opt.theme.shell.background = '#'+opt.theme.shell.background;
	opt.theme.shell.color = '#'+opt.theme.shell.color;
	opt.theme.tweets.background = '#'+opt.theme.tweets.background;
	opt.theme.tweets.color = '#'+opt.theme.tweets.color;
	opt.theme.tweets.links = '#'+opt.theme.tweets.links;
	if (typeof(opt.wUnit) == 'undefined') opt.wUnit = 'px';
	if (typeof(opt.hUnit) == 'undefined') opt.hUnit = 'px';

	new TwitterLoader(c, sid, opt).start();

	/*
	//var widgeturl = 'http://twitter.com/javascripts/widgets/widget.js';
	//var widgeturl = 'http://widgets.twimg.com/j/2/widget.js';
	var widgeturl = SYNC_RES_SERVER + '_modules/js/widget.js';
	jQuery.getScript(widgeturl, function(){
		opt.id = 'widget-' + sid + '';
		jQuery('<div id="' + opt.id + '"></div>').appendTo(c);
		new TWTR.Widget(opt).render().setUser(sid).start();
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
	});
	*/
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
}
function TwitterLoader() {
	this.initialize.apply(this, arguments);
}
TwitterLoader.prototype = {
	twid: null,
	opt: null,
	tw: null,
	twuser: null,
	twtmln: null,
	twlist: null,
	running: false,
	waittime: 10000,
	twnum: 0,
	tweetid: 0,
	tweet: [],

	initialize: function(c, sid, opt) {
		c.innerHTML = '';
		c.style.display = '';
		c.style.textAlign = 'left';
		this.twid = sid;
		this.opt = opt;
		this.tw = jQuery('<div><span>loading... </span></div>').appendTo(c);
	},
	start: function() {
		var that = this;
		if(this.tw){
			this.loading();
			this.getTwitter();
			this.waiter();
			this.tw.click(function(e) {
				that.handleIntent(e);
			});
		}
	},
	loading: function(){
		this.tw.html("<span>Loading Twitter </span>");
		var wimg = new Image();
		wimg.src = PRTCL + '//twitter-widgets.s3.amazonaws.com/j/1/spinner.gif';
		this.tw.append(wimg);

		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
	},
	getTwitter: function(){
		var that = this;
		this.tlTimer = setInterval(function() {
			clearInterval(that.tlTimer);
			that.tlLoad();
		}, 500);
	},
	tlLoad: function() {
		var tlurl = '';
		if (typeof(this.opt.widgetId) != 'undefined') {
			if ((typeof(this.opt.oem) != 'undefined') && (this.opt.oem == '1'))
				tlurl = PRTCL + '//sc.blks.jp/twitter/feed/?widget_id=' + this.opt.widgetId;
			else
				tlurl = PRTCL + '//sc.digitalstage.jp/twitter/feed/?widget_id=' + this.opt.widgetId;
		} else {
			tlurl = PRTCL + '//api.twitter.com/1/statuses/user_timeline.json?screen_name='+this.twid;
			tlurl += '&count='+this.opt.rpp+'&include_rts=1';
		}
		var that = this;
		jQuery.ajax({
			url: tlurl,
			type: 'GET',
			dataType: 'jsonp',
			timeout: 2000,
			async: true
		}).done(function(twjson){
			if (twjson) {
				that.twtmln = (twjson.slice(0,that.opt.rpp)).reverse();

				if (that.twtmln.length > 0) {
					that.tw.html("");
					that.twuser = that.twtmln[0].user;
					that.conectaTwitter(0);
				}

				that.conectaTwitter(1);
				if(!that.running) {
					that.temporizador();
				}
			} else {
				that.tw.html("<span>Twitter Error </span>");
			}
			setAlign(jQuery(that.tw).parent());
			jQuery(that.tw).css('text-align','');
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		}).fail(function() {
			that.tw.html("<span>Twitter Error </span>");
		});
	},
	tlCallback: function(json) {
	},
	waiter: function(){
		var that = this;
		if(!that.twtmln){
			setTimeout(function() {
				if(!that.twtmln){
					that.tw.html("<span>Cannot get Tweet Data </span>");
					_bind.fn.bdRefresh();
					_bind.fn.setFooter();
					finishSyncParts();
				}
			},that.waittime);
		}
	},
	temporizador: function(){
		var that = this;
		this.running=true;
		if (that.opt.features.live) {
			if (that.twnum<that.opt.rpp) {
				setTimeout(function() {
					that.conectaTwitter(1);
					that.temporizador();
				},that.opt.interval);
			}
			else {
				_bind.fn.bdRefresh();
				_bind.fn.setFooter();
				finishSyncParts();
			}
		}
		else {
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		}
	},
	textFormat: function(texto){
		var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
		texto = texto.replace(exp,"<a href='$1' class='twlink' target='_blank'>$1</a>");
		var exp = /[\@]+([A-Za-z0-9-_]+)/ig;
		texto = texto.replace(exp,"@<a href='http://twitter.com/intent/user?screen_name=$1' class='twlink' target='_blank'>$1</a>");
		var exp = /[\#]+([A-Za-z0-9-_]+)/ig;
		texto = texto.replace(exp,"<a href='http://twitter.com/search?q=%23$1' class='twlink' target='_blank'>#$1</a>");
		return texto;
	},
	timeAgo: function(dateString) {
		var rightNow = new Date();
		var then = new Date(dateString);
		if (navigator.userAgent.match(/MSIE\s([^;]*)/)) {
			// IE can't parse these crazy Ruby dates
			then = Date.parse(dateString.replace(/( \+)/, ' UTC$1'));
		}
		var diff = rightNow - then;
		var second = 1000,
		minute = second * 60,
		hour = minute * 60,
		day = hour * 24,
		week = day * 7;
		if (isNaN(diff) || diff < 0) {
			return ""; // return blank string if unknown
		}
		if (diff < second * 7) {
		// within 7 seconds
			return "right now";
		}
		if (diff < minute) {
			return Math.floor(diff / second) + " seconds ago";
		}
		if (diff < minute * 2) {
			return "about 1 minute ago";
		}
		if (diff < hour) {
			return Math.floor(diff / minute) + " minutes ago";
		}
		if (diff < hour * 2) {
			return "about 1 hour ago";
		}
		if (diff < day) {
			return  Math.floor(diff / hour) + " hours ago";
		}
		if (diff > day && diff < day * 2) {
			return "yesterday";
		}
		if (diff < day * 365) {
			return Math.floor(diff / day) + " days ago";
		}
		else {
			return "over a year ago";
		}
	},
	conectaTwitter: function(e){
		var that = this;
		if(e==0) {
			var item = {'user':that.twuser};
			//var item = that.twtmln[0];
			var w = 0;
			if (that.opt.width == 'auto') {
				w = 'auto';
			} else {
				w = that.opt.width + that.opt.wUnit;
			}
			that.tw.html("")
				.attr('style','width: '+w+';'
					+'position: relative;'
					+'font-size: 12px!important;'
					+'font-family: "lucida grande",lucida,tahoma,helvetica,arial,sans-serif!important;'
					+'text-align: left;'
					+'background: '+that.opt.theme.shell.background+';'
					+'color: '+that.opt.theme.shell.color+';'
					+'padding: 1px;'
					+'-webkit-border-radius: 5px;'
					+'-moz-border-radius: 5px;'
					+'border-radius: 5px;'
					+'height: '+that.opt.height+'px;'
					+'overflow: hidden;');

			// head
			var head = jQuery("<div></div>")
				.attr('style','margin:5px;')
				.appendTo(that.tw);
			var twurl = PRTCL + '//twitter.com/intent/user?screen_name='+item.user.screen_name;
			var imgUrl = (PRTCL == 'https:') ? item.user.profile_image_url_https : item.user.profile_image_url;
			var upico = "<img src='"+imgUrl+"' alt='"+item.user.screen_name+"' style='float:left;padding:4px;width:32px;height:32px;vertical-align:top;text-align:left;' />";
			var upimg = jQuery("<a href='"+twurl+"' border='0' style='border:none;' target='_blank'>"+upico+"</a>");
			var uname = jQuery("<div style='color:"+that.opt.theme.shell.color+";padding: 2px 0px 0px 48px;font-size:12px;vertical-align:top;text-align:left;'>"+item.user.name+"</div>");
			var auser = jQuery("<a href='"+twurl+"' target='_blank'>"+item.user.screen_name+"</a>")
				.attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;')
				.hover(
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:underline;background:transparent;border:none;');
					},
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;');
					});
			var utwid = jQuery("<div style='padding: 0px 0px 2px 48px;font-size:16px;font-weight:bold;vertical-align:top;text-align:left;'></div>");
			utwid.append(auser);

			head.append(upimg);
			head.append(uname);
			head.append(utwid);
			head.append(jQuery("<span style='clear:both;'></span>"))

			// body
			that.twlist = jQuery("<div></div>")
				.attr('style','margin:0px;padding:0px;background:'+that.opt.theme.tweets.background+';clear:both;-webkit-border-radius: 5px;-moz-border-radius: 5px;border-radius: 5px;')
				.appendTo(that.tw);
			if (that.opt.features.scrollbar) {
				that.twlist.css("height",that.opt.height+"px");
				that.twlist.css("overflow-y","auto");
			}
			else if (that.opt.features.live) {
				that.twlist.css("height",that.opt.height+"px");
				that.twlist.css("overflow-y","hidden")
			}

			// foot
			var alogo = jQuery('<a href="http://twitter.com/" target="_blank"><img height="15" src="' + SYNC_RES_SERVER + '_modules/images/twitter-widget-logo.png" style="float:left;" /></a>')
				.attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;')
				.hover(
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:underline;background:transparent;border:none;');
					},
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;');
					});
			var ajoin = jQuery("<a href='http://twitter.com/"+item.user.screen_name+"' target='_blank'>Join the conversation</a>")
				.attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;text-align:right;')
				.hover(
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:underline;background:transparent;border:none;');
					},
					function () {
						jQuery(this).attr('style','color:'+that.opt.theme.shell.color+';text-decoration:none;background:transparent;border:none;');
					});
			var utwid = jQuery("<div style='font-size:10px;vertical-align:bottom;text-align:right;'></div>").append(ajoin);
			jQuery("<div></div>")
				.attr('style','margin:0;padding:10px;vertical-align:bottom;clear:both;')
				.append(alogo)
				.append(utwid)
				.append(jQuery("<span style='clear:both;'></span>"))
				.appendTo(that.tw)
		}
		if(e!=0) {
			// tweets
			var itw = 0;
			jQuery.each(that.twtmln,function(i,item) {
				// one tweet
				if ((itw==0) && (that.opt.features.live==false || (that.twnum<that.opt.rpp && item.id_str>that.tweetid))){

					if (item.text != "undefined") {
						var tmlink = "http://twitter.com/"+item.user.screen_name+"/status/"+item.id_str;
						var rplink = "http://twitter.com/intent/tweet?in_reply_to="+item.id_str;
						var rtlink = "http://twitter.com/intent/retweet?tweet_id="+item.id_str;
						var fvlink = "http://twitter.com/intent/favorite?tweet_id="+item.id_str;
						var strtweet = that.textFormat(item.text);
						var mHTML="<div style='word-break:break-all;overflow:hidden'>"+strtweet+"</div>";
						mHTML+="<div style='word-break:break-all;font-size:10px'>";
						mHTML+="<a class='twtr-timestamp' href='" + tmlink + "' target='_blank'>"+that.timeAgo(item.created_at)+"</a>";
						mHTML+=" · <a class='twtr-reply' href='"+rplink+"' target='_blank'>reply</a>";
						mHTML+=" · <a class='twtr-rt' href='"+rtlink+"' target='_blank'>retweet</a>";
						mHTML+=" · <a class='twtr-fav' href='"+fvlink+"' target='_blank'>favorite</a>";
						mHTML+="</div>";
						var twclass = 'tw_'+item.user.screen_name+(new Date/1);
						that.tweet[that.twnum] = jQuery("<div class='"+twclass+"'></div>")
							.html(mHTML)
							.attr('style','color:'+that.opt.theme.tweets.color+';line-height:1.1;list-style:none;background:transparent;margin:4px;padding:4px;border-bottom:dotted 1px '+that.opt.theme.tweets.color+';clear:both;opacity:0;')
							.hide()
							.prependTo(that.twlist);
						jQuery('.'+twclass+' a').attr('style','color:'+that.opt.theme.tweets.links+';text-decoration:none;background:transparent;border:none;');
						jQuery('.'+twclass+' a').hover(
							function () {
								jQuery(this).attr('style','color:'+that.opt.theme.tweets.links+';text-decoration:underline;background:transparent;border:none;');
							},
							function () {
								jQuery(this).attr('style','color:'+that.opt.theme.tweets.links+';text-decoration:none;background:transparent;border:none;');
							}
						);
						that.tweet[that.twnum].fadeTo(0, 0);
						that.tweet[that.twnum].slideDown(1000);
						that.tweet[that.twnum].show();
						that.tweet[that.twnum].fadeTo(500, 1);
						that.tweetid=item.id_str;
						that.twnum++;
						if (that.opt.features.live) {
							itw++;
						}
					}
				}
			});
		}
	},
	handleIntent: function(e) {
		var intentRegex = /twitter\.com(\:\d{2,4})?\/intent\/(\w+)/,
		shortIntents = { tweet: true, retweet:true, favorite:true },
			windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
			winHeight = screen.height,
			winWidth = screen.width;

		e = e || window.event;
		var target = e.target || e.srcElement,
		m, width, height, left, top;
		while (target && target.nodeName.toLowerCase() !== 'a') {
			target = target.parentNode;
		}
		if (target && target.nodeName.toLowerCase() === 'a' && target.href) {
			m = target.href.match(intentRegex);
			if (m) {
				width = 550;
				height = (m[2] in shortIntents) ? 420 : 560;
				left = Math.round((winWidth / 2) - (width / 2));
				top = 0;
				if (winHeight > height) {
					top = Math.round((winHeight / 2) - (height / 2));
				}
				window.open(target.href, 'intent', windowOptions + ',width=' + width + ',height=' + height + ',left=' + left + ',top=' + top);
				e.returnValue = false;
				e.preventDefault && e.preventDefault();
			}
		}
	}
}


/*******
 * Google Translate
 ********/
_sync.googleTranslateElementInit = function (){
  new google.translate.TranslateElement({
    pageLanguage: 'ja'
  }, 'google_translate_element');
}
function dispTranslate(c, sid) {
	if (jQuery("#google_translate_element").length >= 1) return;
	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'left';

	var div = jQuery('<div id="google_translate_element"></div>');
	jQuery(c).append(div);
	if ((bindobj.ie && location.protocol == 'file:') || bindobj.isBind8) {
		div.append('<div class="kakomi"><p class="kakomi ac">サイトをアップロードすると、ここに翻訳パーツが表示されます。</p></div>');
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
		finishSyncParts();
	} else {
		jQuery.getScript(PRTCL + "//translate.google.com/translate_a/element.js?cb=sync.googleTranslateElementInit", function(){
			div.find("a").attr('style','text-decoration:none;background:transparent;border:none;');
			div.find("a").hover(
				function () {
					jQuery(this).attr('style','text-decoration:none;background:transparent;border:none;');
				},
				function () {
					jQuery(this).attr('style','text-decoration:none;background:transparent;border:none;');
				}
			);

			if (bindobj.isCloudEditer) div.css('height', '50px');
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		});
	}
	setAlign(c);
}

/*******
 * Site Search
 ********/
function dispSearch(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'center';

	var buf = '';
	if (opt.designid == 'yahoo01') {
		buf += '<div class="search-div-normal">';
		buf += '<form action="http://search.yahoo.co.jp/search" method="get" target="_self" style="margin:0;padding:0;">';
		buf += '<p style="margin:0;padding:0;">';
		buf += '<a href="http://www.yahoo.co.jp/" target="_blank">';
		buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/ysearch_logo_85_22.gif" alt="Yahoo! JAPAN" style="border:none;vertical-align:middle;padding:0;border:0;" width="85" height="22">';
		buf += '</a>';
		buf += '<input type="text" name="p" id="p" maxlength="2048" size="28" style="font-size:12pt;margin:0 3px;width:60%;border-width:1px 1px 1px 1px;border-style:solid;vertical-align:middle" />';
		buf += '<input type="hidden" name="fr" value="ysiw">';
		buf += '<input type="hidden" name="ei" value="utf-8">';
		buf += '<input name="vs" type="hidden" value="' + opt.domeignval + '">';
		buf += '<input type="submit" value="検索" style="vertical-align:middle">';
		buf += '</p>';
		buf += '</form>';
		buf += '</div>';
	} else if (opt.designid == 'yahoo02') {
		buf += '<div class="search-div-short">';
		buf += '<form method="get" action="http://search.yahoo.co.jp/search" target="_self" style="margin:0;padding:0;">';
//		buf +='	<h4 style="font-size:10pt;font-weight:normal;margin:0 0 0 0px;text-align:left">このサイト内を検索</h4>';
		buf += '<p style="margin:0;padding:0;">';
		buf += '<a href="http://www.yahoo.co.jp/" target="_blank">';
		buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/yjapan_logo_110_29.gif" alt="Yahoo! JAPAN" style="border:none;padding:0;" width="110" height="29">';
		buf += '</a>';
		buf += '</p>';
		buf += '<p style="margin:0;padding:2px 0 0 0;">';
		buf += '<input type="text" name="p" id="p" size="20" maxlength="2048" style="font-size:12pt;margin:0 3px;width:140px;border-width:1px 1px 1px 1px;border-style:solid;">';
		buf += '</p>';
		buf += '<p style="margin:0;padding:0 0 2px 0;">';
		buf += '<input type="hidden" name="fr" value="ysin">';
		buf += '<input type="hidden" name="ei" value="utf-8">';
		buf += '<input type="hidden" name="vs" value="' + opt.domeignval + '">';
		buf += '<input type="submit" value="検索" style="vertical-align:middle;margin:5px 0px;">';
		buf += '</p>';
		buf += '</form>';
		buf += '</div>';

	} else if (opt.designid == 'google01') {
		buf += '<div class="search-div-normal">';
		buf += '<form action="http://www.google.co.jp/search" method="get" target="_self" style="margin:0;padding:0;">';
//		buf +='	<h4 style="font-size:10pt;font-weight:normal;margin:0 0 0 0px;text-align:left">このサイト内を検索</h4>';
		buf += '<p style="margin:0;padding:0;">';
		buf += '<a href="http://www.google.co.jp/" target="_blank">';
		buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/google-Logo_40wht.gif" alt="Google" style="border:none;vertical-align:middle;padding:0;border:0;" width="85" height="36">';
		buf += '</a>';
		buf += '<input type="text" name="q" id="q" maxlength="2048" size="28" style="font-size:12pt;margin:0 3px;width:60%;border-width:1px 1px 1px 1px;border-style:solid;vertical-align:middle" />';
		buf += '<input type="hidden" name="ie" value="UTF-8">';
		buf += '<input type="hidden" name="oe" value="UTF-8">';
		buf += '<input type="hidden" name="hl" value="ja">';
		buf += '<input type=hidden name=domains value="' + opt.domeignval + '">';
		buf += '<input type=hidden  name=sitesearch value="' + opt.domeignval + '">';
		buf += '<input type="submit" name="btnG" value="検索" style="vertical-align:middle">';
		buf += '</p>';
		buf += '</form>';
		buf += '</div>';
	} else if (opt.designid == 'google02') {
		buf += '<div class="search-div-short">';
		buf += '<form method="get" action="http://www.google.co.jp/search" target="_self" style="margin:0;padding:0;">';
		buf += '<p style="margin:0;padding:0;">';
		buf += '<a href="http://www.google.co.jp/" target="_blank">';
		buf += '<img src="' + SYNC_RES_SERVER + '_modules/images/google-Logo_40wht.gif" alt="Google" style="border:none;padding:0;margin:0" width="85" height="36">';
		buf += '</a>';
		buf += '</p>';
		buf += '<p style="margin:0;padding:2px 0 0 0;">';
		buf += '<input type="text" name="q" id="q" maxlength="2048" size="20" style="font-size:12pt;margin:0 3px;width:140px;border-width:1px 1px 1px 1px;border-style:solid;">';
		buf += '</p>';
		buf += '<p style="margin:0;padding:0 0 2px 0;">';
		buf += '<input type="hidden" name="ie" value="UTF-8">';
		buf += '<input type="hidden" name="oe" value="UTF-8">';
		buf += '<input type="hidden" name="hl" value="ja">';
		buf += '<input type=hidden name=domains value="' + opt.domeignval + '">';
		buf += '<input type=hidden  name=sitesearch value="' + opt.domeignval + '">';
		buf += '<input type="submit" name="btnG" value="検索" style="vertical-align:middle;margin:5px 0px;">';
		buf += '</p>';
		buf += '</form>';
		buf += '</div>';

	}
//	c.innerHTML = buf;
	jQuery(buf).appendTo(c);

	var txtid = '';
	if (opt.designid == 'yahoo01' || opt.designid == 'yahoo02') {
		txtid = '#p';
	} else if (opt.designid == 'google01' || opt.designid == 'google02') {
		txtid = '#q';
	}
	if(jQuery(txtid,c).val()!=''){
		jQuery(txtid,c).addClass('search-nohint');
	}else{
		jQuery(txtid,c).addClass('search-hint');
	}
	jQuery(txtid,c).focus(function(){
		jQuery(txtid,c).removeClass('search-hint').addClass('search-nohint');
	}).blur(function(){
		if(jQuery(txtid,c).val()=='') jQuery(txtid,c).removeClass('search-nohint').addClass('search-hint');
	});

	setAlign(c);
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}

/*************
U S T R E A M
*************/
function dispUstream(c, sid, did, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	//var locale = 'ja_JP';
	var locale = 'en_US';

	if (typeof(opt.wUnit) == 'undefined') opt.wUnit = 'px';
	var bkW = getBkWidth(jQuery(c));
	var w = 0;
	if (opt.wUnit == '%') {
		w = opt.width+opt.wUnit;
	} else {
		w = (opt.width > bkW) ? bkW+'px' : opt.width+'px';
	}
	var buf = '';
	switch(did){
	case 'channel-live':
		if (bindobj.isBind8 || bindobj.isCloud) {
			buf += '<div>';
			buf += '<div class="kakomi"><p class="kakomi ac">サイトをアップロードすると、ここにUSTREAMパーツが表示されます。</p></div>';
			buf += '</div>';
		} else {
			if (isMobile) {
				var width = 'width';
				buf+='<iframe width="'+w+'" height="'+opt.height+'" src="http://www.ustream.tv/embed/'+opt.id+'" scrolling="no" frameborder="0" style="border: 0px none transparent;"></iframe>';
			} else {
				buf+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"';
				buf+=' width="'+w+'" height="'+opt.height+'" id="'+opt.prmid+'">';
				buf+='<param name="flashvars" value="autoplay=false&amp;brand=embed&amp;cid='+opt.id+'&amp;locale='+locale+'"/>';
				buf+='<param name="allowfullscreen" value="true"/>';
				buf+='<param name="allowscriptaccess" value="always"/>';
				buf+='<param name="wmode" value="opaque" />';
				buf+='<param name="movie" value="'+opt.src+'"/>';
				buf+='<embed flashvars="autoplay=false&amp;brand=embed&amp;cid='+opt.id+'&amp;locale='+locale+'"';
				buf+=' width="'+w+'" height="'+opt.height+'"';
				buf+=' allowfullscreen="true" allowscriptaccess="always"';
				buf+=' id="'+opt.prmid+'" name="'+opt.prmnm+'"';
				buf+=' src="'+opt.src+'"';
				buf+=' type="application/x-shockwave-flash" />';
				buf+='</object>';
			}
		}
		break;
	case 'channel-media':
		buf+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"';
		buf+=' width="'+w+'" height="'+opt.height+'" id="'+opt.prmid+'">';
		buf+='<param name="flashvars" value="autoplay=false&amp;brand=embed&amp;cid='+opt.id+'&amp;locale='+locale+'"/>';
		buf+='<param name="bgcolor" value="#000000"/>';
		buf+='<param name="allowfullscreen" value="true"/>';
		buf+='<param name="allowscriptaccess" value="always"/>';
		buf+='<param name="wmode" value="opaque" />';
		buf+='<param name="movie" value="http://www.ustream.tv/flash/mediastream/'+opt.id+'"/>';
		buf+='<embed flashvars="autoplay=false&amp;brand=embed&amp;cid='+opt.id+'&amp;locale='+locale+'"';
		buf+=' bgcolor="#000000"';
		buf+=' width="'+w+'"';
		buf+=' height="'+opt.height+'"';
		buf+=' allowfullscreen="true"';
		buf+=' allowscriptaccess="always"';
		buf+=' id="'+opt.prmid+'"';
		buf+=' name="'+opt.prmnm+'"';
		buf+=' src="http://www.ustream.tv/flash/mediastream/'+opt.id+'"';
		buf+=' type="application/x-shockwave-flash" />';
		buf+='</object>';
		break;
	case 'channel-social':
	case 'recorded-social':
		buf+='<iframe width="'+w+'" height="'+opt.height+'" scrolling="no" frameborder="0"';
		buf+='style="border: 0px none transparent;" src="' + PRTCL + '//www.ustream.tv/socialstream/'+opt.id+'"></iframe>';
		break;
	case 'recorded-video':
		if (bindobj.isBind8 || bindobj.isCloud) {
			buf += '<div>';
			buf += '<div class="kakomi"><p class="kakomi ac">サイトをアップロードすると、ここにUSTREAMパーツが表示されます。</p></div>';
			buf += '</div>';
		} else {
			if (isMobile) {
				buf+='<iframe width="'+w+'" height="'+opt.height+'" src="http://www.ustream.tv/embed/recorded/'+opt.id+'" scrolling="no" frameborder="0" style="border: 0px none transparent;"></iframe>';
			} else {
				buf+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"';
				buf+=' width="'+w+'" height="'+opt.height+'" id="'+opt.prmid+'" name="'+opt.prmnm+'">';
				buf+='<param name="flashvars" value="autoplay=false" />';
				buf+='<param name="allowfullscreen" value="true" />';
				buf+='<param name="allowscriptaccess" value="always" />';
				buf+='<param name="wmode" value="opaque" />';
				buf+='<param name="src" value="http://www.ustream.tv/flash/video/'+opt.id+'"/>';
				buf+='<embed flashvars="autoplay=false"';
				buf+=' width="'+w+'"';
				buf+=' height="'+opt.height+'"';
				buf+=' allowfullscreen="true"';
				buf+=' allowscriptaccess="always"';
				buf+=' id="'+opt.prmid+'"';
				buf+=' name="'+opt.prmnm+'"';
				buf+=' src="http://www.ustream.tv/flash/video/'+opt.id+'"';
				buf+=' type="application/x-shockwave-flash" />';
				buf+='</object>';
			}
		}
		break;
 	default:
 		break;
 	}

	c.innerHTML = buf;
	c.style.display = '';
	c.style.textAlign = 'center';

	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();

}


/*******
 * Like Buttom
 ********/
function LikeBtnLoader() {
	this.initialize.apply(this, arguments);
}
LikeBtnLoader.prototype = {
	initialize: function(c, sid, opt) {
		var defSort = [
			'twitter',
			'facebook',
			'facebookShare',
			'hatena',
			'google',
			'pocket',
			'tumblr',
			'pinterest',
			'linkedin',
			'line',
			'lineAdd',
			'lineShare',
			'mixi'
		];
		if(typeof(opt.sortItems) == 'undefined') opt.sortItems = defSort;

		c.innerHTML = '';
		this.area = jQuery(c);
		this.sid = sid;
		this.opt = opt;
		var options = opt.options || {};

		var obj = {};
		var div = jQuery('<div class="likebtn_area" style="display:inline-block; line-height:1.5;"></div>');
		if (opt.twitter) {
			obj['twitter'] = '<div class="tw_likebtn" style="float:left; width:75px; margin-right:5px"></div>';
		}
		if (opt.facebook || opt.facebookCom) {
			var w = ('facebook' in options && !options.facebook.counter) ? 75 : 100;
			obj['facebook'] = '<div class="fb_likebtn" style="float:left; width:'+w+'px; margin-right:5px"></div>';
		}
		if (opt.facebookShare) {
			var w = ('facebookShare' in options && !options.facebookShare.counter) ? 65 : 100;
			obj['facebookShare'] = '<div class="fb_sharebtn" style="float:left; width:'+w+'px; margin-right:5px"></div>';
		}
		/*if (opt.facebookCom) {
			if (location.href.indexOf('file:') == 0){
				obj['facebookCom'] = "<div style='float:left; margin-right:5px'><img src='"+SYNC5_SERVER+"_modules/images/likebtn/facebook.png'></div>";
			}else{
				obj['facebookCom'] = '<div class="fb_likebtn_comment" style="float:left; width:108px; margin-right:5px;"></div>';
			}
		}*/
		if (opt.hatena) {
			obj['hatena'] = '<div class="hatena_btn" style="float:left; margin-right:5px"></div>';
		}
		if (opt.google) {
			if (navigator.userAgent.indexOf('Win') >= 0 && location.href.indexOf('file:') == 0){
				obj['google'] = "<div style='float:left; margin-right:5px'><img src='"+SYNC5_SERVER+"_modules/images/likebtn/gplus.png'></div>";
			}else{
				var w = ('google' in options && !options.google.counter) ? 40 : 66;
				obj['google'] = '<div class="gp_likebtn" style="float:left; width:'+w+'px; margin-right:5px"></div>';
			}
		}
		if (opt.pocket) {
			var w = ('pocket' in options && !options.pocket.counter) ? 70 : 94;
			obj['pocket'] = '<div class="pocket_btn" style="float:left; width:'+w+'px; margin-right:5px"></div>';
		}
		if (opt.tumblr) {
			obj['tumblr'] = '<div class="tumblr_btn" style="float:left; margin-right:5px"></div>';
		}
		if (opt.pinterest) {
			obj['pinterest'] = '<div class="pinterest_btn" style="float:left; margin-right:5px"></div>';
		}
		if (opt.linkedin) {
			obj['linkedin'] = '<div class="linkedin_btn" style="float:left; margin-right:5px"></div>';
		}
		if (opt.line) {
			obj['line'] = '<div class="line_btn" style="float:left; margin-right:5px"></div>';
		}
		if (opt.lineAdd) {
			obj['lineAdd'] = '<div class="line_btn_add" style="float:left; margin-right:5px"></div>';
		}
		if (opt.lineShare) {
			obj['lineShare'] = '<div class="line_btn_share" style="float:left; margin-right:5px"></div>';
		}
		if (opt.mixi) {
			obj['mixi'] = '<div class="mx_likebtn" style="float:left; margin-right:5px"></div>';
		}
		for (var i=0; i<opt.sortItems.length; i++) {
			var key = opt.sortItems[i];
			if (key == 'facebookCom' && !opt.facebook) {
				key = 'facebook';
				opt[key] = true;
			}
			if (opt[key]) div.append(jQuery(obj[key]));
		}
		div.append('<div style="clear:both;"></div>');
		this.area.append(div);
		this.area.parent().css('paddingBottom', '0px');
	},
	start: function() {
		var that = this;
		(function() {
			var url = SYNC_RES_SERVER + '_modules/js/jquery.socialbutton.js';
			jQuery.getScript(url, function(){
				var opts = that.opt.options || {};
				if (that.opt.twitter) {
					//var opt = {button: 'horizontal'};
					var opt = {};
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('twitter' in opts) {
						if (opts.twitter.checkurl) opt['url'] = opts.twitter.url;
						opt['hash'] = opts.twitter.hash;
					}
					that.area.find('.tw_likebtn').socialbutton('twitter', opt);
				}
				if (that.opt.facebook || that.opt.facebookCom) {
					//var opt = {button: 'button_count'};
					var opt = {};
					var ogurl = jQuery("meta[property='og:url']").attr("content");
					if (ogurl) opt['url'] = ogurl;
					opt['counter'] = true;
					opt['locale'] = (userLang.indexOf('ja') > -1) ? 'ja_JP' : 'en_US';
					if ('facebook' in opts) {
						if (opts.facebook.checkurl) opt['url'] = opts.facebook.url;
						opt['counter'] = opts.facebook.counter;
					}
					that.area.find('.fb_likebtn').socialbutton('facebook_like', opt);
				}
				if (that.opt.facebookShare) {
					//var opt = {button: 'button_count'};
					var opt = {};
					var ogurl = jQuery("meta[property='og:url']").attr("content");
					if (ogurl) opt['url'] = ogurl;
					opt['counter'] = true;
					opt['locale'] = (userLang.indexOf('ja') > -1) ? 'ja_JP' : 'en_US';
					if ('facebookShare' in opts) {
						if (opts.facebookShare.checkurl) opt['url'] = opts.facebookShare.url;
						opt['counter'] = opts.facebookShare.counter;
					}
					that.area.find('.fb_sharebtn').socialbutton('facebook_share', opt);
				}
				/*if (that.opt.facebookCom) {
					fbJsSdkSet();
					var fbTag = '<div class="fb-like" data-href="' + document.URL + '" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" style="width:120px"></div>';
					that.area.find('.fb_likebtn_comment').append(fbTag);
				}*/
				if (that.opt.mixi) {
					that.area.find('.mx_likebtn').socialbutton('mixi_check', {key: that.opt.mixikey});
				}
				if (that.opt.google) {
					var opt = {size: 'medium'};
					opt['counter'] = true;
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en_US';
					if ('google' in opts) {
						if (opts.google.checkurl) opt['url'] = opts.google.url;
						opt['counter'] = opts.google.counter;
					}
					that.area.find('.gp_likebtn').socialbutton('google_plusone',opt);
				}
				if (that.opt.hatena) {
					var opt = {};
					opt['counter'] = true;
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja_JP' : 'en_US';
					if ('hatena' in opts) {
						if (opts.hatena.checkurl) opt['url'] = opts.hatena.url;
						opt['counter'] = opts.hatena.counter;
					}
					that.area.find('.hatena_btn').socialbutton('hatena', opt);
				}
				if (that.opt.pocket) {
					var opt = {};
					opt['counter'] = true;
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('hatena' in opts) {
						opt['counter'] = opts.hatena.counter;
					}
					that.area.find('.pocket_btn').socialbutton('pocket', opt);
				}
				if (that.opt.linkedin) {
					var opt = {};
					opt['counter'] = true;
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja_JP' : 'en_US';
					if ('linkedin' in opts) {
						if (opts.linkedin.checkurl) opt['url'] = opts.linkedin.url;
						opt['counter'] = opts.linkedin.counter;
					}
					that.area.find('.linkedin_btn').socialbutton('linkedin',opt);
				}
				if (that.opt.line) {
					var opt = {};
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('line' in opts) {
						if (opts.line.checkurl) opt['url'] = opts.line.url;
					}
					that.area.find('.line_btn').socialbutton('line', opt);
				}
				if (that.opt.lineAdd) {
					var opt = {};
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('lineAdd' in opts) {
						opt['counter'] = opts.lineAdd.counter;
						opt['uid'] = opts.lineAdd.uid;
					}
					that.area.find('.line_btn_add').socialbutton('line_add', opt);
				}
				if (that.opt.lineShare) {
					var opt = {};
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('lineShare' in opts) {
						if (opts.lineShare.checkurl) opt['url'] = opts.lineShare.url;
					}
					that.area.find('.line_btn_share').socialbutton('line_share', opt);
				}
				if (that.opt.tumblr) {
					var opt = {};
					opt['counter'] = true;
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					if ('tumblr' in opts) {
						opt['color'] = opts.tumblr.color;
						opt['counter'] = opts.tumblr.counter;
					}
					that.area.find('.tumblr_btn').socialbutton('tumblr', opt);
				}
				if (that.opt.pinterest) {
					var opt = {};
					opt['lang'] = (userLang.indexOf('ja') > -1) ? 'ja' : 'en';
					that.area.find('.pinterest_btn').socialbutton('pinterest', opt);
				}
				// Tumblrのみ独自でaタグにstyleを指定しているので処理分け
				/*that.area.find("a:not(#tumblr-a)").attr('style','text-decoration:none;background:transparent;border:none;');
				that.area.find("a:not(#tumblr-a)").hover(
					function () {
						jQuery(this).attr('style','text-decoration:none;background:transparent;border:none;');
					},
					function () {
						jQuery(this).attr('style','text-decoration:none;background:transparent;border:none;');
					}
				);
				that.area.find("#tumblr-a").css({'text-decoration':'none','border':'none'});
				that.area.find("#tumblr-a").hover(
					function () {
						jQuery(this).css({'text-decoration':'none','border':'none'});
					},
					function () {
						jQuery(this).css({'text-decoration':'none','border':'none'});
					}
				);*/
				if (that.opt.line || that.opt.lineShare || that.opt.lineAdd) {
					var cnt = 0;
					var lineload = function(){
						cnt++;
						var id = setTimeout(lineload, 1000);
						if(typeof LineIt != 'undefined'){　
							LineIt.loadButton();
							clearTimeout(id);
						}
						if (cnt > 10) clearTimeout(id);
					}
					lineload();
				}
				_bind.fn.bdRefresh();
				_bind.fn.setFooter();
				finishSyncParts();
			});
		}());
	}
};
function dispLikeButtom(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;
	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'left';

	new LikeBtnLoader(c, sid, opt).start();

	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
}

/*******
 * twitter follow badge
 ********/
function dispTwitbatch(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;
	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'left';
	// www.go2web20.net停止対応
	//if (bindobj.isCloud) {
		make_sample_badge_custom(opt);
	/*} else {
		jQuery.getScript('http://www.go2web20.net/twitterfollowbadge/1.0/badge.js', function(){
			if (typeof(tfb)!='undefined') {
				tfb.account = opt.account;
				tfb.label = opt.label;
				tfb.color = '#' + opt.color;
				tfb.side = opt.side;
				tfb.top = opt.top;
				tfb.showbadge();
			}

			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
		});
	}*/
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}

function make_sample_badge_custom(opt) {
	// BiNDクラウド編集画面用独自実装
	var $tfb = jQuery(document.createElement('div')),
		$tfbTab = jQuery(document.createElement('div')),
		$tfbAbt = jQuery(document.createElement('div'));
	$tfb.attr('id', 'twitterFollowBadge');
	$tfbTab.attr('id', 'tfbTab');
	var tfbImg;
	switch (opt.label) {
		case 'follow-me':
			tfbImg = 'follow-me.png';
			break;
		case 'follow-us':
			tfbImg = 'follow-us.png';
			break;
		case 'follow':
			tfbImg = 'follow.png';
			break;
		case 'my-twitter':
			tfbImg = 'my-twitter.png';
			break;
		default:
	}
	var tfbSide,bgSide;
	if (opt.side == "l") {
		tfbSide = 'left';
		bgSide = 'right';
	} else {
		tfbSide = 'right';
		bgSide = 'left';
	}
	$tfbTab.attr('style','position: fixed;'
						+'top: ' + opt.top + 'px;'
						+'width: 30px;'
						+'height: 119px;'
						+'z-index: 8765;'
						+'cursor: pointer;'
						+ tfbSide + ': 0;'
						+'background: #'+ opt.color +' url('+SYNC_RES_SERVER+'_modules/images/twitbatch/'+tfbImg+');'
						+'background-repeat: no-repeat;'
						+'background-position: ' + bgSide + ' top');
	$tfbAbt.attr('id', 'tfbAbout');
	$tfbAbt.attr('style','position: fixed;'
						+'top: 243px;'
						+'width: 10px;'
						+'height: 11px;'
						+'z-index: 9876;'
						+'cursor: pointer;'
						+'display: none;'
						+ tfbSide + ': 0;'
						+'background: url('+SYNC_RES_SERVER+'_modules/images/twitbatch/icon-about.png);'
						+'background-repeat: no-repeat;');
	$tfbTab.mouseover(function(){jQuery('#tfbAbout').show()});
	$tfbTab.mouseout(function(){jQuery('#tfbAbout').hide()});
	$tfbTab.click(function(){window.open('https://twitter.com/'+opt.account)});
	$tfb.append($tfbTab);
	$tfb.append($tfbAbt);
	jQuery('body').append($tfb);
}

/*******
 * Facebook Comments
 ********/
var facebookloader;
function dispFacebook(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	//c.innerHTML = '';
	if (c.hasChildNodes()) {
		for (var i=c.childNodes.length;i>0;i--) {
			if (c.childNodes[i-1].nodeName == '#text') {
				c.removeChild(c.childNodes[i-1]);
				continue;
			}
			if (c.childNodes[i-1].nodeName == 'SCRIPT') {
				c.removeChild(c.childNodes[i-1]);
			}
		}
	}
	c.style.display = '';
	c.style.textAlign = 'left';

	new FacebookLoader(c, opt).start();
	jQuery(window).resize(function() {
		if (opt.wUnit == 'px') return;
		var ww = jQuery(window).width();
		jQuery(c).empty();
		new FacebookLoader(c, opt).start();
		FB.XFBML.parse(jQuery(c).get(0));
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
	});

	setAlign(c);
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}
function FacebookLoader() {
	this.initialize.apply(this, arguments);
}
FacebookLoader.prototype = {
	initialize: function(c,opt) {
		this.wUnit = (typeof(opt.wUnit) == 'undefined') ? 'px' : opt.wUnit;
		//c.innerHTML = '';
		this.target = opt.commentTarget;
		this.pageUrl = opt.pageUrl;
		this.toukouNum = opt.toukouNum;
		this.bbsWidth = opt.bbsWidth;
		this.colorType = opt.colorType;
		//必要なタグ
		//jQuery("<div id='fb-root'></div>").appendTo(c);
		this.tw = jQuery('<div>Making Facebook Comments </div>').appendTo(c);
	},
	loading: function(){
		this.tw.html("<div>Loading Facebook </div>");
		var wimg = new Image();
		wimg.src = PRTCL + '//twitter-widgets.s3.amazonaws.com/j/1/spinner.gif';
		this.tw.append(wimg);
	},
	start: function() {
		this.loading();
		fbJsSdkSet();

		if(this.tw){
			var TYPE_URL_TARGET = 'pageUrl';
			var urlOp = '';
			//if(this.pageUrl != ''){
			if (this.target == TYPE_URL_TARGET){
				//pageUrlのある場合
				urlOp = " data-href='" + this.pageUrl +"'";
			}else{
				//pageUrlの無い場合
				urlOp = " data-href='" + location.href +"'";
			}
			var w = 0;
			var bkW = getBkWidth(jQuery(this.tw.parent()));
			if (this.wUnit == '%') {
				w = bkW * this.bbsWidth / 100;
			} else {
				w = (this.bbsWidth > bkW) ? bkW : this.bbsWidth;
			}
			if (navigator.userAgent.indexOf('Win') >= 0 &&
					location.href.indexOf('file:') == 0){
				this.tw.html("<div class='kakomi'><p class='kakomi ac'>サイトをアップロードすると、ここにFacebook Commentsパーツが表示されます。</p></div>");
			}else{
				this.tw.html("<div class='fb-comments'"+urlOp+" data-num_posts='"+this.toukouNum+"' data-width='"+w+"' data-colorscheme='"+this.colorType+"'></div>");
			}
		}
	}
}

/*******
 * Disqus Comments
 ********/
function dispDisqus(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	c.innerHTML = '';
	c.style.display = '';
	c.style.textAlign = 'left';
	c.style.width = '100%';

	new DisqusLoader(c, opt.shortname).start();

	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}
function DisqusLoader() {
	this.initialize.apply(this, arguments);
}
DisqusLoader.prototype = {
	initialize: function(c,shortname) {
		c.innerHTML = '';
		this.shortname = shortname;
		this.tw = jQuery('<div><span>Making Disqus Comments </span></div>').appendTo(c);
	},
	loading: function(){
		this.tw.html("<span>Loading Disqus </span>");
		var wimg = new Image();
		wimg.src = PRTCL + '//twitter-widgets.s3.amazonaws.com/j/1/spinner.gif';
		this.tw.append(wimg);
	},
	start: function() {
		this.loading();

		if(this.tw){
			//testing the system on an inaccessible website
			var dev = '';
			if(DISQUS_LOCAL_TEST){
				dev = " var disqus_developer = 1;";
			}
			if (navigator.userAgent.indexOf('Win') >= 0 &&
					location.href.indexOf('file:') == 0){
				this.tw.html("<div class='kakomi'><p class='kakomi ac'>サイトをアップロードすると、ここにDisqusパーツが表示されます。</p></div>");
			}else{
				var disqus_str= "<div id='disqus_thread'></div>";
				disqus_str += "<script type='text/javascript'>";
				disqus_str += " var disqus_shortname = '"+this.shortname+"';";
				disqus_str += dev;
				disqus_str += " var disqus_config = function() {";
				disqus_str += " this.callbacks.onReady = [function() {";
				disqus_str += " _bind.fn.bdRefresh();";
				disqus_str += " _bind.fn.setFooter();";
				disqus_str += " setTimeout(function(){";
				disqus_str += " _bind.fn.bdRefresh();";
				disqus_str += " _bind.fn.setFooter();";
				disqus_str += " }, 1000);";
				disqus_str += " }];";
				disqus_str += " };";
				disqus_str += "(function() {";
				disqus_str += "var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;";
				disqus_str += "dsq.src = '" + PRTCL + "//' + disqus_shortname + '.disqus.com/embed.js';";
				disqus_str += "(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);";
				disqus_str += "})();";
				disqus_str += "</script>";
				disqus_str += "<noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript>";
				disqus_str += "<a href='http://disqus.com' class='dsq-brlink'>blog comments powered by <span class='logo-disqus'>Disqus</span></a>";
				this.tw.html(disqus_str);
			}
		}
	}
}

/*******
 * Facebook Likebox
 ********/
var MIN_WIDTH = 180,
	MAX_WIDTH = 500,
	MIN_HEIGHT = 70;
function dispLikebox(c, sid, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	jQuery(c).text('');
	c.style.display = '';
	//c.style.textAlign = 'left';

	new LikeboxLoader(c, opt).start();
	
	var evt = (isIpad || isIphone) ? 'orientationchange' : 'resize';
	var initWW = jQuery(window).width();
	jQuery(window).on(evt, function(e) {
		if (opt.wUnit == 'px') return;
		var ww = jQuery(window).width();
		if (ww == initWW)
			return;
		else
			initWW = ww;
		jQuery(c).empty();
		new LikeboxLoader(c, opt).start();
		FB.XFBML.parse(jQuery(c).get(0));
		_bind.fn.bdRefresh();
		_bind.fn.setFooter();
	});

	//setAlign(c);
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}
function LikeboxLoader(likeBox,followConfig) {
	this.initialize.apply(this,arguments);
}
LikeboxLoader.prototype = {
	initialize: function(c,followConfig) {
		//c.innerHTML = '';
		this.wUnit = (typeof(followConfig.wUnit) == 'undefined') ? 'px' : followConfig.wUnit;
		this.hUnit = (typeof(followConfig.hUnit) == 'undefined') ? 'px' : followConfig.hUnit;
		this.facebookPageUrl = followConfig.facebookPageUrl;
		this.boxHeight = followConfig.boxHeight;
		if ((typeof(this.boxHeight) == 'undefined')) {
			this.boxHeight = getDefaultHeight(followConfig.dispFace, followConfig.dispUpdate, followConfig.dispHeader);
		}
		if (this.hUnit == '%') {
			if (this.boxHeight < MIN_HEIGHT) this.boxHeight = MIN_HEIGHT;
		}
		this.boxWidth = followConfig.boxWidth;
		if (this.wUnit == '%') {
			if (this.boxWidth > MAX_WIDTH) this.boxWidth = MAX_WIDTH;
		}
//		this.colorType = followConfig.colorType;
		this.dispFace = followConfig.dispFace;
		this.dispUpdate = followConfig.dispUpdate;
		this.dispHeader = followConfig.dispHeader;
		//必要なタグ
		//jQuery("<div id='fb-root'></div>").appendTo(c);
		this.tw = jQuery('<div>Making Facebook LikeBox </div>').appendTo(c);
	},
	loading: function(){
		this.tw.html("<div>Loading Facebook </div>");
		var wimg = new Image();
		wimg.src = PRTCL + '//twitter-widgets.s3.amazonaws.com/j/1/spinner.gif';
		this.tw.append(wimg);
	},
	start: function() {
		this.loading();
		fbJsSdkSet();

		if(this.tw){
			if (location.href.indexOf('file:') == 0){
				this.tw.html("<div class='kakomi'><p class='kakomi ac'>サイトをアップロードすると、ここにFacebook Page Pluginパーツが表示されます。</p></div>");
			}else{
				var w,h;
				var bkW = getBkWidth(jQuery(this.tw.parent()));
				if (this.wUnit == '%') {
					w = ((bkW * this.boxWidth / 100) > MAX_WIDTH) ? MAX_WIDTH : ((bkW * this.boxWidth / 100) < MIN_WIDTH) ? MIN_WIDTH : (bkW * this.boxWidth / 100);
				} else {
					w = (this.boxWidth > bkW) ? bkW : this.boxWidth;
				}
				if (this.hUnit == '%') {
					var bkH = getBkHeight(jQuery(this.tw.parent()));
					h = (bkH * this.boxWidth < MIN_HEIGHT) ? MIN_HEIGHT : (bkH * this.boxWidth);
				} else {
					h = this.boxHeight;
				}
				w = Math.floor(w);
				h = Math.floor(h);
				var tab = (this.dispUpdate) ? 'timeline' : 'false';
				// iPhone7 && 中央寄せ指定時に正常に表示されないため、調整（iPhone7のみだが、条件はiPhoneで判定）
				if (isIphone && (jQuery(this.tw.parent()[0]).parent()[0].className.indexOf('c-center') > -1))
					w = w-1;
				if (bindobj.ie) {
					this.tw.html('<iframe src="//www.facebook.com/plugins/page.php?href='+this.facebookPageUrl+'&amp;width='+w+'&amp;height='+h+'&amp;show_facepile='+this.dispFace+'&amp;tabs='+tab+'&amp;hide_cover='+!this.dispHeader+'&amp;container_width=588" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:'+w+'px; height:'+h+'px;" allowTransparency="true"></iframe>');
				} else {
					this.tw.html('<div style="width:auto; height:'+h+'px; display:inline-block;"><div class="fb-page" data-href="'+this.facebookPageUrl+ '" data-width="'+w+'" data-height="'+h+'" data-show-facepile="'+this.dispFace+'" data-tabs="'+tab+'" data-hide-cover="'+!this.dispHeader+'"></div></div>');
				}
			}
		}
		jQuery("#fb-root").css('display','none');
	}
}
var defaultHeight = {
		1: '571',//full
		2: '541',//face+update
		3: '427',//update+header
		4: '271',//face+header
		5: '241',//face
		6: '395',//update
		7: '70'//header
	};
function getDefaultHeight(dispFace,dispUpdate,dispHeader){
	if(dispFace && dispUpdate && dispHeader){
		return defaultHeight[1];
	}else if(dispFace && dispUpdate){
		return defaultHeight[2];
	}else if(dispUpdate && dispHeader){
		return defaultHeight[3];
	}else if(dispFace && dispHeader){
		return defaultHeight[4];
	}else if(dispFace){
		return defaultHeight[5];
	}else if(dispUpdate){
		return defaultHeight[6];
	}else{
		return defaultHeight[7];
	}
}
/*******
 * Facebook JavaScript SDK
 ********/
function fbJsSdkSet() {
	window.fbAsyncInit = function() {
		FB.init({
			status : true, // check login status
			cookie : true, // enable cookies to allow the server to access the session
			xfbml  : true,  // parse XFBML
			version : 'v2.9'
		});
		FB.Event.subscribe("xfbml.render", function () {
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
		});
		FB.Event.subscribe('comment.create', function(response){
			_gaq.push(["_trackEvent", "Facebook Comment", "Posted", response.commentID]);
		});
	};
	(function(d){
		var lang = (userLang.indexOf('ja') > -1) ? 'ja_JP' : 'en_US';
		var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement('script'); js.id = id; js.async = true;
		js.src = PRTCL + "//connect.facebook.net/"+lang+"/sdk.js#xfbml=1&version=v2.9";
		ref.parentNode.insertBefore(js, ref);
	}(document));
}


/*******
 * Instagram widget
 ********/
var imgLoadCnt = {};
var partsCnt = 0;
var instaFloatloaded = false;
var instaCarouselloaded = false;
var instaScraploaded = false;
function dispInstagram(c, sid, opt) {

	var url = SYNC5_SERVER + 'syncinstagramw.json/?instaid=' + opt.instagramId;
	var instaLoading = jQuery('<div class="loading"/>');
	jQuery(c).empty();
	jQuery(c).append(instaLoading).show();
	jQuery(c).css({'display': 'block', 'overflow': 'hidden'});
	jQuery.getJSON(url+'&callback=?', function(json) {
		//c.innerHTML = '';
		//c.style.display = '';
		//c.style.textAlign = 'left';

		var instaInfo = json.instagram;
		if (instaInfo.length > 0) {
			// 表示画像数
			var dispCnt = (instaInfo.length > (opt.layoutX*opt.layoutY))?(opt.layoutX*opt.layoutY):instaInfo.length;

			/* fix image size */
			function fixImgSize(info) {
				jQuery.each(info, function(i, e){
					var thumb = e.images.thumbnail.url;
					var low = thumb.replace(/s150x150/, "s320x320");
					var standard = thumb.replace(/s150x150/, "s640x640");
					e.images.low_resolution.url = low;
					e.images.standard_resolution.url = standard;
				});
				return info;
			}
			instaInfo = fixImgSize(instaInfo);

			partsCnt++;
			imgLoadCnt['img-disp-'+partsCnt] = dispCnt;

			var div = jQuery('<div/>');
			switch (opt.widgetType) {
				case 'grid':
					div.addClass('-instagramw-col'+opt.layoutX);
					var ul = jQuery('<ul class="media-grid"/>');
					if (opt.thumbPadding > 0) {
						ul.css({'margin-left': '-'+opt.thumbPadding+'px', 'margin-top': '-'+opt.thumbPadding+'px'});
					}
					for (var i=0; i<dispCnt; i++) {
						// List
						var li = jQuery('<li class="media-list-item grid no-border"/>');

						// IMG
						var liDiv = jQuery('<div class="clearfix" style="margin-left: '+opt.thumbPadding+'px; margin-top: '+opt.thumbPadding+'px;"/>'),
							liA = jQuery('<a class="insta-border" target="_blank"/>'),
							liImg = jQuery('<img class="thumbnail"/>');
						if (opt.shadow != 'none') liA.addClass('insta-shadow');
						liA.attr('href', instaInfo[i].link);
						// 枠線設定
						if (opt.borderSize > 0) {
							liA.css('border-width', opt.borderSize+'px');
							liA.css('border-color', opt.borderCol);
						} else {
							liA.mouseover(function() {
								jQuery(this).css('border', 'none');
							}).mouseout(function() {
								jQuery(this).css('border', 'none');
							});
						}
						// 画像は表示サイズに合わせる
						var imgUrl = instaInfo[i].images.standard_resolution.url;
						liImg.attr('src', imgUrl);
						// 画像効果
						switch (opt.effectType) {
							case 'fadeIn':
								liImg.css('opacity',0.5);
								liDiv.mouseenter(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 1.0);
								}).mouseleave(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 0.5);
								});
								break;
							case 'fadeOut':
								liDiv.mouseenter(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 0.5);
								}).mouseleave(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 1.0);
								});
								break;
							case 'none':
							default:
								break;
						}
						liDiv.append(liA.append(liImg));
						liImg.on("load", function(){
							if ('img-loaded-'+partsCnt in imgLoadCnt) {
								if ('img-disp-'+partsCnt in imgLoadCnt) {
									if (imgLoadCnt['img-loaded-'+partsCnt] == imgLoadCnt['img-disp-'+partsCnt]) {
										_bind.fn.bdRefresh();
										_bind.fn.setFooter();
										finishSyncParts();
										_bind.base.smoothScroll.init();
									} else {
										imgLoadCnt['img-loaded-'+partsCnt] = imgLoadCnt['img-loaded-'+partsCnt]+1;
									}
								} else {
									_bind.fn.bdRefresh();
									_bind.fn.setFooter();
									//_bind.base.smoothScroll.init();
								}
							} else {
								imgLoadCnt['img-loaded-'+partsCnt] = 2;
							}
						});

						// Share Button
						if (opt.shareButton == 'share') {
							var shareDiv = jQuery('<div class="share-button"/>');
							var bottomNum = 7+opt.borderSize;
							shareDiv.css('bottom', bottomNum + 'px');
							var rightNum = 7+opt.borderSize;
							shareDiv.css('right', rightNum + 'px');

							// Facebook Share Button
							var shareAfb = jQuery('<a />'),
								shareImgfb = jQuery('<img class="share-fb-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_facebook.png" width="20px" height="20px"/>');
							var fbCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
							shareAfb.attr('href', 'https://www.facebook.com/sharer.php?u='+instaInfo[i].link+'&amp;t='+fbCapt);
							shareAfb.css('float','left');
							shareAfb.click(function() {
								window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
									'facebookwindow',
									'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
									);
								return false;
							});
							shareImgfb.css('opacity',0);
							shareImgfb.mouseover(function() {
								jQuery(this).fadeTo(100, 1.0);
							}).mouseout(function() {
								jQuery(this).fadeTo(100, 0.7);
							});
							if (isMobile || isTablet) shareImgfb.css('opacity', 1.0);
							shareAfb.append(shareImgfb);
							shareDiv.append(shareAfb);

							// Twitter Share Button
							var shareAtw = jQuery('<a />'),
							shareImgtw = jQuery('<img class="share-tw-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_twitter.png" width="20px" height="20px"/>');
							var twCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
							shareAtw.attr('href', 'https://twitter.com/intent/tweet?url='+instaInfo[i].link+'&amp;text='+twCapt);
							shareAtw.css({'float':'left', 'margin-left': '2px'});
							shareAtw.click(function() {
								window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
									'tweetwindow',
									'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
									);
								return false;
							});
							shareImgtw.css('opacity',0);
							shareImgtw.mouseover(function() {
								jQuery(this).fadeTo(100, 1.0);
							}).mouseout(function() {
								jQuery(this).fadeTo(100, 0.7);
							});
							if (isMobile || isTablet) shareImgtw.css('opacity', 1.0);
							shareAtw.append(shareImgtw);
							shareDiv.append(shareAtw);

							// Share Button 表示／非表示切り替え
							liDiv.mouseenter(function() {
								jQuery(this).find('.share-fb-img').fadeTo(100, 0.7);
								jQuery(this).find('.share-tw-img').fadeTo(100, 0.7);
							}).mouseleave(function() {
								jQuery(this).find('.share-fb-img').fadeTo(100, 0.0);
								jQuery(this).find('.share-tw-img').fadeTo(100, 0.0);
							});

							liDiv.append(shareDiv);
						}

						li.append(liDiv);
						ul.append(li);
					}
					div.append(ul);
					instaLoading.remove();
					jQuery(c).append(div);
					jQuery(c).css({'display': 'block', 'overflow': ''});
					if (_bind.fn.isEditBlock()) jQuery(c).css('overflow', 'hidden');
			 		break;
				case 'board':
					div.addClass('-instagramw-col'+opt.layoutX);
					var ul = jQuery('<ul class="media-grid"/>');
					if (opt.thumbPadding > 0) {
						ul.css({'margin-left': '-'+opt.thumbPadding+'px', 'margin-top': '-'+opt.thumbPadding+'px'});
					}
					for (var i=0; i<dispCnt; i++) {
						// List
						var li = jQuery('<li class="media-list-item board insta-border"/>');
						if (opt.shadow != 'none') li.addClass('insta-shadow');
						li.css({'margin-left': opt.thumbPadding+'px', 'margin-top': opt.thumbPadding+'px'});
						// 枠線設定
						if (opt.borderSize > 0) {
							li.css('border-width', opt.borderSize+'px');
							li.css('border-color', opt.borderCol);
						}

						// IMG
						var liDiv = jQuery('<div class="clearfix"/>'),
							liA = jQuery('<a class="border-none" style="margin: 0;" target="_blank"/>'),
							liImg = jQuery('<img class="thumbnail"/>');
						liA.attr('href', instaInfo[i].link);
						// 画像は表示サイズに合わせる
						var imgUrl = instaInfo[i].images.standard_resolution.url;
						liImg.attr('src', imgUrl);
						// 画像効果
						switch (opt.effectType) {
							case 'fadeIn':
								liImg.css('opacity',0.5);
								liDiv.mouseenter(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 1.0);
								}).mouseleave(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 0.5);
								});
								break;
							case 'fadeOut':
								liDiv.mouseenter(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 0.5);
								}).mouseleave(function() {
									jQuery(this).find('.thumbnail').fadeTo(200, 1.0);
								});
								break;
							case 'none':
							default:
								break;
						}
						liDiv.append(liA.append(liImg));
						liImg.on("load", function(){
							if ('img-loaded-'+partsCnt in imgLoadCnt) {
								if ('img-disp-'+partsCnt in imgLoadCnt) {
									if (imgLoadCnt['img-loaded-'+partsCnt] == imgLoadCnt['img-disp-'+partsCnt]) {
										_bind.fn.bdRefresh();
										_bind.fn.setFooter();
										finishSyncParts();
										_bind.base.smoothScroll.init();
									} else {
										imgLoadCnt['img-loaded-'+partsCnt] = imgLoadCnt['img-loaded-'+partsCnt]+1;
									}
								} else {
									_bind.fn.bdRefresh();
									_bind.fn.setFooter();
									//_bind.base.smoothScroll.init();
								}
							} else {
								imgLoadCnt['img-loaded-'+partsCnt] = 2;
							}
						});

						// Share Button
						if (opt.shareButton == 'share') {
							var shareDiv = jQuery('<div class="share-button" style="bottom: 115px; right: 10px;"/>');

							// Facebook Share Button
							var shareAfb = jQuery('<a />'),
								shareImgfb = jQuery('<img class="share-fb-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_facebook.png" width="20px" height="20px"/>');
							var fbCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
							shareAfb.attr('href', 'https://www.facebook.com/sharer.php?u='+instaInfo[i].link+'&amp;t='+fbCapt);
							shareAfb.css('float','left');
							shareAfb.click(function() {
								window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
									'facebookwindow',
									'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
									);
								return false;
							});
							shareImgfb.css('opacity',0);
							shareImgfb.mouseover(function() {
								jQuery(this).fadeTo(100, 1.0);
							}).mouseout(function() {
								jQuery(this).fadeTo(100, 0.7);
							});
							if (isMobile || isTablet) shareImgfb.css('opacity', 1.0);
							shareAfb.append(shareImgfb);
							shareDiv.append(shareAfb);

							// Twitter Share Button
							var shareAtw = jQuery('<a />'),
							shareImgtw = jQuery('<img class="share-tw-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_twitter.png" width="20px" height="20px"/>');
							var twCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
							shareAtw.attr('href', 'https://twitter.com/intent/tweet?url='+instaInfo[i].link+'&amp;text='+twCapt);
							shareAtw.css({'float':'left', 'margin-left': '2px'});
							shareAtw.click(function() {
								window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
									'tweetwindow',
									'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
									);
								return false;
							});
							shareImgtw.css('opacity',0);
							shareImgtw.mouseover(function() {
								jQuery(this).fadeTo(100, 1.0);
							}).mouseout(function() {
								jQuery(this).fadeTo(100, 0.7);
							});
							if (isMobile || isTablet) shareImgtw.css('opacity', 1.0);
							shareAtw.append(shareImgtw);
							shareDiv.append(shareAtw);

							// Share Button 表示／非表示切り替え
							liDiv.mouseenter(function() {
								jQuery(this).find('.share-fb-img').fadeTo(100, 0.7);
								jQuery(this).find('.share-tw-img').fadeTo(100, 0.7);
							}).mouseleave(function() {
								jQuery(this).find('.share-fb-img').fadeTo(100, 0.0);
								jQuery(this).find('.share-tw-img').fadeTo(100, 0.0);
							});

							liDiv.append(shareDiv);
						}

						// Caption
						var liCapDiv = jQuery('<div class="media-board-info" style="height: 105px; padding: 10px;"/>'),
							liCapDivDiv = jQuery('<div class="clearfix"/>'),
							liCapUDiv = jQuery('<div class="info-profile-username"/>'),
							liCapUA = jQuery('<a class="no-border info-profile-username-link" target="_blank"/>'),
							liCap = jQuery('<div class="info-profile-caption"/>');
						liCapUA.attr('href', 'http://instagram.com/'+instaInfo[i].user.username);
						liCapUA.text(instaInfo[i].user.username);
						liCap.text((instaInfo[i].caption != null) ? instaInfo[i].caption.text : '');
						liCapDivDiv.append(liCapUDiv.append(liCapUA));
						liCapDiv.append(liCapDivDiv);
						liCapDiv.append(liCap);

						var rsDiv = jQuery('<div />').addClass('media-board');
						if (opt.shadow != 'none') {
							li.removeClass('insta-shadow');
							rsDiv.addClass('insta-shadow');
						}
						li.css('border-width', 0);
						li.css({'margin-left': '0px', 'margin-top': '0px'});
						rsDiv.css('border-width', opt.borderSize+'px');
						rsDiv.css('border-color', opt.borderCol);
						rsDiv.css({'margin-left': opt.thumbPadding+'px', 'margin-top': opt.thumbPadding+'px'});

						rsDiv.append(liDiv);
						rsDiv.append(liCapDiv)
						li.append(rsDiv);
						ul.append(li);
					}
					div.append(ul);
					instaLoading.remove();
					jQuery(c).append(div);
					jQuery(c).css({'display': 'block', 'overflow': ''});
					if (_bind.fn.isEditBlock()) jQuery(c).css('overflow', 'hidden');
			 		break;
				case 'slideshow':
					var url = SYNC_RES_SERVER + '_modules/_common/jQueryCycle/jquery.cycle.all.js';
					jQuery.getScript(url,  function(){
						//var w = ((opt.thumbSize+(opt.borderSize*2))*opt.layoutX) + (opt.thumbPadding*(opt.layoutX-1));
						//var h = ((opt.thumbSize+(opt.borderSize*2))*opt.layoutY) + (opt.thumbPadding*opt.layoutY);
						var w = ((opt.thumbSize+(opt.borderSize*2))*opt.layoutX);
						var h = ((opt.thumbSize+(opt.borderSize*2))*opt.layoutY);
						var unit = (typeof(opt.thumbUnit) == 'undefined') ? 'px' : opt.thumbUnit;
						var bkW = getBkWidth(c);
						var liH = 0;
						if (unit == '%') {
							liH = ((bkW*opt.thumbSize / 100) > 640) ? 640 : (bkW*opt.thumbSize / 100);
							div.css({
								'width': '100%',
								'height': '100%'
							});
						} else {
							liH = (bkW > 640) ? 640 : bkW;
							liH = (liH > opt.thumbSize) ? opt.thumbSize : liH;
							div.css({
								'max-width': opt.thumbSize + 'px',
								'max-height': opt.thumbSize + 'px',
								'margin': '0px auto'
							});
						}
						var ptid = getSyncPartsId();
						var ul = jQuery('<ul id="insta-silde-show-'+ptid+'" class="media-grid" style="margin: 0 auto;"/>');
						if (opt.shadow != 'none') ul.addClass('insta-shadow');
						ul.css('widht', liH + 'px');
						ul.css('height', liH + 'px');
						if (unit == 'px') {
							ul.css('max-widht', opt.thumbSize + 'px');
							ul.css('max-height', opt.thumbSize + 'px');
						}
						for (var i=0; i<instaInfo.length; i++) {
							// List
							var li = jQuery('<li />');
							li.css('width', liH+'px');
							li.css('height', liH+'px');
							if (unit == 'px') {
								li.css('max-widht', opt.thumbSize + 'px');
								li.css('max-height', opt.thumbSize + 'px');
							}

							// IMG
							var liDiv = jQuery('<div class="clearfix" />'),
								liA = jQuery('<a class="insta-border" style="margin: 0;" target="_blank"/>'),
								liImg = jQuery('<img class="thumbnail"/>');
							liA.attr('href', instaInfo[i].link);
							// 枠線設定
							if (opt.borderSize > 0) {
								liA.css('border-width', opt.borderSize+'px');
								liA.css('border-color', opt.borderCol);
							} else {
								liA.css('outline', 'none');
							}
							liA.css('width', liH+'px');
							liA.css('height', liH+'px');
							if (unit == 'px') {
								liA.css('max-widht', opt.thumbSize + 'px');
								liA.css('max-height', opt.thumbSize + 'px');
							}
							// 画像は表示サイズに合わせる
							var imgUrl = instaInfo[i].images.thumbnail.url;
							if (306 >= opt.thumbSize && opt.thumbSize > 150) {
								imgUrl = instaInfo[i].images.low_resolution.url;
							} else if (opt.thumbSize > 306) {
								imgUrl = instaInfo[i].images.standard_resolution.url;
							}
							if (unit == '%') imgUrl = instaInfo[i].images.standard_resolution.url;
							liImg.attr('src', imgUrl);
							liImg.css('width', (liH - opt.borderSize*2) + 'px');
							liImg.css('height', (liH - opt.borderSize*2) + 'px');
							if (unit == 'px') {
								liImg.css('max-widht', opt.thumbSize + 'px');
								liImg.css('max-height', opt.thumbSize + 'px');
							}
							//liImg.css('padding', opt.thumbPadding);
							// 画像効果
							switch (opt.effectType) {
								case 'fadeIn':
									liImg.css('opacity',0.5);
									liImg.mouseover(function() {
										jQuery(this).fadeTo(200, 1.0);
									}).mouseout(function() {
										jQuery(this).fadeTo(200, 0.5);
									});
									break;
								case 'fadeOut':
									liImg.mouseover(function() {
										jQuery(this).fadeTo(200, 0.5);
									}).mouseout(function() {
										jQuery(this).fadeTo(200, 1.0);
									});
									break;
								case 'none':
								default:
									break;
							}
							liDiv.append(liA.append(liImg));

							// Share Button
							if (opt.shareButton == 'share') {
								var shareDiv = jQuery('<div class="share-button"/>');
								var bottomNum = 7+opt.borderSize;
								shareDiv.css('bottom', bottomNum + 'px');
								var rightNum = 7+opt.borderSize;
								shareDiv.css('right', rightNum + 'px');

								// Facebook Share Button
								var shareAfb = jQuery('<a />'),
									shareImgfb = jQuery('<img class="share-fb-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_facebook.png" width="20px" height="20px"/>');
								var fbCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
								shareAfb.attr('href', 'https://www.facebook.com/sharer.php?u='+instaInfo[i].link+'&amp;t='+fbCapt);
								shareAfb.css('float','left');
								shareAfb.click(function() {
									window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
										'facebookwindow',
										'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
										);
									return false;
								});
								shareImgfb.css('opacity',0);
								shareImgfb.mouseover(function() {
									jQuery(this).fadeTo(100, 1.0);
								}).mouseout(function() {
									jQuery(this).fadeTo(100, 0.7);
								});
								if (isMobile || isTablet) shareImgfb.css('opacity', 1.0);
								shareAfb.append(shareImgfb);
								shareDiv.append(shareAfb);

								// Twitter Share Button
								var shareAtw = jQuery('<a />'),
								shareImgtw = jQuery('<img class="share-tw-img" src="'+SYNC_RES_SERVER+'/_modules/images/instagram/share_twitter.png" width="20px" height="20px"/>');
								var twCapt = (instaInfo[i].caption != null) ? instaInfo[i].caption.text : '';
								shareAtw.attr('href', 'https://twitter.com/intent/tweet?url='+instaInfo[i].link+'&amp;text='+twCapt);
								shareAtw.css({'float':'left', 'margin-left': '2px'});
								shareAtw.click(function() {
									window.open(encodeURI(decodeURI(jQuery(this)[0].href)),
										'tweetwindow',
										'width=550, height=450, personalbar=0, toolbar=0, scrollbars=1, resizable=!'
										);
									return false;
								});
								shareImgtw.css('opacity',0);
								shareImgtw.mouseover(function() {
									jQuery(this).fadeTo(100, 1.0);
								}).mouseout(function() {
									jQuery(this).fadeTo(100, 0.7);
								});
								if (isMobile || isTablet) shareImgtw.css('opacity', 1.0);
								shareAtw.append(shareImgtw);
								shareDiv.append(shareAtw);

								// Share Button 表示／非表示切り替え
								liDiv.mouseenter(function() {
									jQuery(this).find('.share-fb-img').fadeTo(100, 0.7);
									jQuery(this).find('.share-tw-img').fadeTo(100, 0.7);
								}).mouseleave(function() {
									jQuery(this).find('.share-fb-img').fadeTo(100, 0.0);
									jQuery(this).find('.share-tw-img').fadeTo(100, 0.0);
								});

								liDiv.append(shareDiv);
							}

							li.append(liDiv);
							ul.append(li);
						}
						div.append(ul);
						instaLoading.remove();
						jQuery(c).append(div);
						jQuery(c).css({'display': 'block', 'overflow': ''});
						if (_bind.fn.isEditBlock() && (opt.shadow != 'none')) jQuery(c).css('overflow', 'hidden');
						var opts = {
								width: liH+'px'
								,height: liH+'px'
						};
						jQuery('#insta-silde-show-'+ptid).cycle(opts);
						jQuery(window).resize(function() {
							var ww = jQuery(window).width();
							var syncSpan = jQuery('#insta-silde-show-'+ptid).closest('span');
							var bkW = getBkWidth(jQuery(syncSpan));
							var wh = 0;
							if (unit == '%') {
								wh = (bkW * opt.thumbSize) / 100;
								if (wh > 640) wh = 640;
							} else {
								wh = (bkW > 640) ? 640 : bkW;
								wh = (wh > opt.thumbSize) ? opt.thumbSize : wh;
							}
							if (wh > 640) wh = 640;
							jQuery('#insta-silde-show-'+ptid).css({'width': wh+'px', 'height': wh+'px', 'position': 'relative', 'margin':'0 auto'});
							jQuery('#insta-silde-show-'+ptid).find('li').each(function() {
								jQuery(this).css({'width': wh + 'px', 'height': wh + 'px'});
							});
							jQuery('#insta-silde-show-'+ptid).find('a').each(function() {
								if ((jQuery(this).children().hasClass('share-tw-img')) || (jQuery(this).children().hasClass('share-fb-img')))
									return;
								jQuery(this).css({'width': wh + 'px', 'height': wh + 'px'});
							});
							jQuery('#insta-silde-show-'+ptid).find('img').each(function() {
								if ((jQuery(this).hasClass('share-tw-img')) || (jQuery(this).hasClass('share-fb-img')))
									return;
								jQuery(this).css({'width': (wh-opt.borderSize*2) + 'px', 'height': (wh-opt.borderSize*2) + 'px'});
							});
							var opts = {
									width: wh+'px'
									//,height: wh+'px'
							};
							jQuery('#insta-silde-show-'+ptid).cycle('destroy');
							jQuery('#insta-silde-show-'+ptid).cycle(opts);
						});
						_bind.fn.bdRefresh();
						_bind.fn.setFooter();
						finishSyncParts();
					});
			 		break;
				case 'float':
					var imagesLoadedJs = SYNC_RES_SERVER + '_modules/js/imagesLoaded/imagesloaded.pkgd.min.js';
					var masonryJs = SYNC_RES_SERVER + '_modules/js/masonry/masonry.pkgd.min.js';
					if (!instaFloatloaded) {
						jQuery.when(
							jQuery.ajax({
								url: imagesLoadedJs
								,type: 'GET'
								,dataType: 'script'
							}),
							jQuery.ajax({
								url: masonryJs
								,type: 'GET'
								,dataType: 'script'
							})
						).done(function(){
							instaFloatloaded = true;
							loadFloat();
						}).fail(function(){
							console.log("instagram float faild.");
						});
					} else {
						loadFloat();
					}
					
					function loadFloat() {
						var ptid = getSyncPartsId();
						div.addClass('-instagramw-float');
						div.attr('id', 'insta-float-' + ptid);
						
						var imgNum = (opt.imgNum > instaInfo.length) ? instaInfo.length : opt.imgNum;
						for (var i=0; i<imgNum; i++) {
							var $awrap = jQuery('<a target="_blank">');
							$awrap.attr('href', instaInfo[i].link);
							
							if (opt.likes == 'show' || opt.comments == 'show' || opt.caption == 'show') {
								var $capDiv = jQuery('<div class="overlay">');
								$capDiv.css({'background-color': hexToRGBA(opt.hoverCol, 0.7)});
								if (!(isMobile && isTablet)) {
									$capDiv.hover(function(){
													jQuery(this).css('opacity', 1);
												},
												function(){
													jQuery(this).css('opacity', 0);
												}
									);
								}
								var $info = jQuery('<span class="option">');
								if (opt.likes == 'show') {
									var $likes = jQuery('<span class="option_likes">');
									$likes.append(jQuery('<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 19">'
											+ '<path style="fill:'+checkTxtColor(hexToRGB(opt.hoverCol))+'" d="M14.5,0A5.49,5.49,0,0,0,10,2.34,5.5,5.5,0,0,0,0,5.5C0,12.54,10,18,10,18S20,12.54,20,5.5A5.5,5.5,0,0,0,14.5,0Z"/></svg></span>'));
									$likes.append(jQuery('<span>' + instaInfo[i].likes.count + '</span>'));
									$info.append($likes);
								}
								if (opt.comments == 'show') {
									var $comments = jQuery('<span class="option_comments">');
									$comments.append(jQuery('<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 19">'
											+ '<path style="fill:'+checkTxtColor(hexToRGB(opt.hoverCol))+'" d="M17.59,14.49A8,8,0,0,0,20,8.5C20,3.81,16.86,0,10,0S0,3.81,0,8.5,3.14,17,10,17a13.51,13.51,0,0,0,4.64-.74L19,18Z"/></svg></span>'));
									$comments.append(jQuery('<span>' + instaInfo[i].comments.count + '</span>'));
									$info.append($comments);
								}
								if (opt.caption == 'show') {
									var $caption = jQuery('<span class="option_discription">');
									$caption.text((instaInfo[i].caption != null) ? instaInfo[i].caption.text : '');
									$info.append($caption);
								}
								$capDiv.css('color', checkTxtColor(hexToRGB(opt.hoverCol)));
								$capDiv.append($info);
							}
							var imgUrl = instaInfo[i].images.standard_resolution.url;
							// Non Square Img URL取得（API設定ではSquareかNon Squareかどちらかしか応答されないため）
							if ((imgUrl.match(/\//g)||[]).length >= 6) {
								var imgName = imgUrl.substring(imgUrl.lastIndexOf('/')+1);
								var imgStr = imgUrl.substring(0, imgUrl.lastIndexOf('/'));
								var imgPath = imgStr.substring(0, imgStr.lastIndexOf('/')+1);
								imgUrl = imgPath + imgName;
								//imgUrl = imgUrl.substring(0, getIndexStr(imgUrl, '/',5)) + imgUrl.substring(getIndexStr(imgUrl, '/',6));
							}
							var $img = jQuery('<img width="100%" height="100%">').attr('src', imgUrl);
							$awrap.append($capDiv);
							$awrap.append($img);
							var $divBox = jQuery('<div class="box">');
							$divBox.css({
								'width': '100%'
								,'margin-right': opt.thumbPadding+'px'
								,'margin-bottom': opt.thumbPadding+'px'
							});
							$divBox.append($awrap);
							div.append($divBox);
						}
						div.hide();
						jQuery(c).append(div);
						jQuery(c).css({'display': 'block', 'overflow': ''});
						if (_bind.fn.isEditBlock()) jQuery(c).css('overflow', 'hidden');

						if (isTablet) {
							  jQuery('.-instagramw-float .overlay').css({
								    'top': 'auto',
								    'opacity': 1
							  });
							  jQuery('.-instagramw-float .option').css({
								    'width': '90%',
								    'max-width': '90%'
							  });
							  jQuery('.-instagramw-float .option .option_like, .-instagramw-float .option .option_comment').css({
								    'padding-top': '1%',
								    'padding-bottom': '1%'
							  });
							  jQuery('.-instagramw-float .option .option_like + .option_discription, .-instagramw-float .option .option_comments + .option_discription').css({
								    'margin-top': 0,
								    'padding-top': '1%',
								    'border-top': '1px solid'
							  });
							  jQuery('.-instagramw-float .option .option_discription').css({
								    'display': 'block',
								    'padding-top': '1%',
								    'padding-bottom': '1%',
								    'text-align': 'left',
								    'overflow': 'hidden',
								    'white-space': 'nowrap',
								    'text-overflow': 'ellipsis' 
							  });
						}
						var thumbSize = opt.thumbSize + 'px';
						$float = jQuery('#insta-float-'+ptid);
						div.imagesLoaded(function(){
							
							var $that = jQuery(this.elements);
							var timer = 0;
							floatLoad($that);
							
							jQuery(window).resize(function () {
								floatLoad($that);
							});

							var masFlg = false;
							function floatLoad($f) {
								if (getBkWidth(jQuery(c)) > 640) {
									if (!masFlg) {
										jQuery('div.box', $f).css('max-width', thumbSize);
										instaLoading.remove();
										div.show();
										$f.masonry({
										  	itemSelector : '.box',
											columnWidth: 0,
											isFitWidth: true,
											isAnimated: true,
											animationOptions: {
															duration: 750,
															queue: false
															}
										});
										masFlg = true;
									}
								} else {
									if (masFlg) {
										jQuery('div.box', $f).css('max-width', '');
										$f.masonry('destroy');
										masFlg = false;
									}
									$f.css('display', 'inline-block');
									instaLoading.remove();
									div.show();
								}
								_bind.fn.bdRefresh();
								_bind.fn.setFooter();
								finishSyncParts();
							}
						});
					}
			 		break;
				case 'carousel':
					var imagesLoadedJs = SYNC_RES_SERVER + '_modules/js/imagesLoaded/imagesloaded.pkgd.min.js';
					var infiniteslidev2Js = SYNC_RES_SERVER + '_modules/js/infiniteslidev2/infiniteslidev2.js';
					if (!instaCarouselloaded) {
						jQuery.when(
								jQuery.ajax({
									url: imagesLoadedJs
									,type: 'GET'
									,dataType: 'script'
								}),
								jQuery.ajax({
									url: infiniteslidev2Js
									,type: 'GET'
									,dataType: 'script'
								})
							).done(function(){
								instaCarouselloaded = true;
								loadCarousel();
							}).fail(function(){
								console.log("instagram carousel faild.");
							});
					} else {
						loadCarousel();
					}
					
					function loadCarousel() {
						var ptid = getSyncPartsId();
						div.attr('id', 'insta-carousel-' + ptid);
						
						div.addClass('-instagramw-carousel');
						for (var i=0; i<instaInfo.length; i++) {

							var $awrap = jQuery('<div target="_blank">');
							$awrap.data('url', instaInfo[i].link);
							$awrap.click(function(){
								window.open(jQuery(this).data('url'));
							});
							
							if (opt.likes == 'show' || opt.comments == 'show' || opt.caption == 'show') {
								var $capDiv = jQuery('<div class="overlay">');
								$capDiv.css({'background-color': hexToRGBA(opt.hoverCol, 0.7)});
								if (!(isMobile && isTablet)) {
									$capDiv.hover(function(){
													jQuery(this).css('opacity', 1);
												},
												function(){
													jQuery(this).css('opacity', 0);
												}
									);
								}
								var $info = jQuery('<span class="option">');
								if (opt.likes == 'show') {
									var $likes = jQuery('<span class="option_likes">');
									$likes.append(jQuery('<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 19">'
											+ '<path style="fill:'+checkTxtColor(hexToRGB(opt.hoverCol))+'" d="M14.5,0A5.49,5.49,0,0,0,10,2.34,5.5,5.5,0,0,0,0,5.5C0,12.54,10,18,10,18S20,12.54,20,5.5A5.5,5.5,0,0,0,14.5,0Z"/></svg></span>'));
									$likes.append(jQuery('<span>' + instaInfo[i].likes.count + '</span>'));
									$info.append($likes);
								}
								if (opt.comments == 'show') {
									var $comments = jQuery('<span class="option_comments">');
									$comments.append(jQuery('<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 19">'
											+ '<path style="fill:'+checkTxtColor(hexToRGB(opt.hoverCol))+'" d="M17.59,14.49A8,8,0,0,0,20,8.5C20,3.81,16.86,0,10,0S0,3.81,0,8.5,3.14,17,10,17a13.51,13.51,0,0,0,4.64-.74L19,18Z"/></svg></span>'));
									$comments.append(jQuery('<span>' + instaInfo[i].comments.count + '</span>'));
									$info.append($comments);
								}
								if (opt.caption == 'show') {
									var $caption = jQuery('<span class="option_discription">');
									$caption.text((instaInfo[i].caption != null) ? instaInfo[i].caption.text : '');
									$info.append($caption);
								}
								$capDiv.css('color', checkTxtColor(hexToRGB(opt.hoverCol)));
								$capDiv.append($info);
							}
							var imgUrl = instaInfo[i].images.standard_resolution.url;
							var $img = jQuery('<img width="100%" height="100%">').attr('src', imgUrl);
							if (typeof($capDiv) != 'undefined') $awrap.append($capDiv);
							$awrap.append($img);
							var $divBox = jQuery('<div class="box">');
							$divBox.css({
								'width': opt.thumbSize+'px'
								,'height': opt.thumbSize+'px'
								,'margin-right': opt.thumbPadding+'px'
								,'margin-bottom': opt.thumbPadding+'px'
								});
							$divBox.append($awrap);
							div.append($divBox);
						}
						div.hide();
						jQuery(c).append(div);
						jQuery(c).css({'display': 'block', 'overflow': ''});
						if (_bind.fn.isEditBlock()) jQuery(c).css('overflow', 'hidden');
						if (isTablet) {
							  jQuery('.-instagramw-carousel .overlay').css({
								    'top': 'auto',
								    'opacity': 1
							  });
							  jQuery('.-instagramw-carousel .option').css({
								    'width': '90%',
								    'max-width': '90%'
							  });
							  jQuery('.-instagramw-carousel .option .option_like, .-instagramw-carousel .option .option_comment').css({
								    'padding-top': '1%',
								    'padding-bottom': '1%'
							  });
							  jQuery('.-instagramw-carousel .option .option_like + .option_discription, .-instagramw-carousel .option .option_comments + .option_discription').css({
								    'margin-top': 0,
								    'padding-top': '1%',
								    'border-top': '1px solid'
							  });
							  jQuery('.-instagramw-carousel .option .option_discription').css({
								    'display': 'block',
								    'padding-top': '1%',
								    'padding-bottom': '1%',
								    'text-align': 'left',
								    'overflow': 'hidden',
								    'white-space': 'nowrap',
								    'text-overflow': 'ellipsis' 
							  });
						}
						div.imagesLoaded(function(){
							jQuery('#insta-carousel-' + ptid).infiniteslide({
								direction: opt.flow
							});
							instaLoading.remove();
							div.show();
							//if (isAndroid) setInterval(function(){jQuery('.overlay', div).show()},1000);
							_bind.fn.bdRefresh();
							_bind.fn.setFooter();
							finishSyncParts();
						});
					}
					
			 		break;
				case 'scrap':
					var easingJs = SYNC_RES_SERVER + '_modules/js/easing/jquery.easing.1.3.js';
					var velocityJs = SYNC_RES_SERVER + '_modules/js/velocity/velocity.min.js';
					var imagesLoadedJs = SYNC_RES_SERVER + '_modules/js/imagesLoaded/imagesloaded.pkgd.min.js';
					var slickJs = SYNC_RES_SERVER + '_modules/js/slick/slick.min.js';
					var slickCss = SYNC_RES_SERVER + '_modules/js/slick/slick.css';
					var googleLatoFont = '<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">';
					jQuery('head').append('<link rel="stylesheet" href="' + slickCss + '" type="text/css">');
					jQuery('head').append(googleLatoFont);
					if (!instaScraploaded) {
						jQuery.when(
							jQuery.ajax({
								url: easingJs
								,type: 'GET'
								,dataType: 'script'
							}),
							jQuery.ajax({
								url: velocityJs
								,type: 'GET'
								,dataType: 'script'
							}),
							jQuery.ajax({
								url: imagesLoadedJs
								,type: 'GET'
								,dataType: 'script'
							}),
							jQuery.ajax({
								url: slickJs
								,type: 'GET'
								,dataType: 'script'
							})
						).done(function(){
							instaScraploaded = true;
							loadScrap();
						}).fail(function(){
							console.log("instagram scrap faild.");
						});
					} else {
						loadScrap();
					}
					
					function loadScrap() {
						var ptid = getSyncPartsId();
						div.attr('id', 'insta-scrap-' + ptid);
	
						div.addClass('sec-t-main');
						var $sec = jQuery('<section>').addClass('sec-t-main-card');
						var $container = jQuery('<div class="container">');
						
						for (var i=0; i<instaInfo.length; i++) {
							var $item = jQuery('<div class="sec-t-main-card-list item">');
							if (getBkWidth(jQuery(c)) > 640) {
								$item = jQuery('<div class="sec-t-main-card-list item">').css({
									'width': opt.thumbSize+'px',
									'height': opt.thumbSize+'px'});
							} else {
								div.css({'display': 'block'})
								$item.css({'position': 'relative','width':'100%','height':'100%'});
							}
							
							var $imgA = jQuery('<a href="' + instaInfo[i].link + '" class="url" target="_blank"></a>');
							var $imgDiv = jQuery('<div class="img thumbnail"><img src="' + instaInfo[i].images.standard_resolution.url + '"></div>');
							$imgA.append($imgDiv);
							var $opDate = jQuery('<div class="option_date">'+getDate(instaInfo[i].created_time)+'</div>');
							$opDate.css({
								'color': checkTxtColor(hexToRGB(opt.textCol))
								,'background-color': hexToRGBA(opt.textCol,0.8)
							});
							$imgA.append($opDate);
							if (instaInfo[i].caption != null) {
								var $opCp = jQuery('<div class="option_discription">'+instaInfo[i].caption.text+'</div>');
								$opCp.css({
									'color': checkTxtColor(hexToRGB(opt.textCol))
									,'background-color': hexToRGBA(opt.textCol,0.8)
								})
								$imgA.append($opCp);
							}
							$item.append($imgA);
							$container.append($item);
						}
						$sec.append($container);
						div.append($sec);
						
						var $navi = jQuery('<div class="nav">');
						var $prev = jQuery('<div class="nav_prev"><span class="arrow"><svg xmlns="http://www.w3.org/2000/svg" width="8" height="14" viewBox="0 0 8 14"><title>prev</title><path class="path" d="M7,0,0,7l7,7,1-1L2,7,8,1Z" style="fill-rule:evenodd"/></svg></span></div>');
						var $next = jQuery('<div class="nav_next"><span class="arrow"><svg xmlns="http://www.w3.org/2000/svg" width="8" height="14" viewBox="0 0 8 14"><title>next</title><path class="path" d="M1,0,8,7,1,14,0,13,6,7,0,1Z" style="fill-rule:evenodd"/></svg></span></div>');
						
						$navi.append($prev);
						$navi.append($next);
						div.append($navi);
						div.hide();

						jQuery(c).append(div);
						jQuery(c).css({'display': 'block', 'overflow': ''});
	
						//jQuery(c).height(opt.dispHeight+'px');
						var serviceConfig = opt;
						dispScrap();
	
						/* load scrap design */
						var isPC = false;
						var isSP = false;
						var routine;
						var initLoad = false;
						function dispScrap(){
							//if (typeof(routine) != 'undefined') clearInterval(routine);
							loading();

							function loading() {
								div.imagesLoaded(function() {
									if (getBkWidth(jQuery(c)) > 640) {
										isPC = true;
										bgAdjust(div);
										reallocation(div);
										init(div);
										instaLoading.remove();
										div.show();
									} else {
										isSP = true;
										instaLoading.remove();
										div.show();
										$container.slick({
											infinite: true,
											speed: 300,
											slidesToShow: 1,
											adaptiveHeight: true,
											prevArrow: $prev,
											nextArrow: $next
										});
									}
									_bind.fn.bdRefresh();
									_bind.fn.setFooter();
									finishSyncParts();
								});
							}

							jQuery(window).resize(function() {
								if (jQuery('.sec-t-main-card-list', div).length > 0) {
									if (getBkWidth(jQuery(c)) > 640) {
										if (isPC) {
											bgAdjust(div);
											reallocation(div);
										} else {
											$container.slick('unslick');
											div.css({'height': opt.dispHeight+'px'});
											jQuery('.sec-t-main-card-list', div).css({
												'position': 'absolute'
												,'width': opt.thumbSize+'px'
												,'height': opt.thumbSize+'px'});
											bgAdjust(div);
											reallocation(div);
											if (!initLoad) {
												init(div);
											} else {
												intervalStart();
											}
										}
										isPC = true;
										isSP = false;
									} else {
										if (isSP) {
											// dummy
										} else {
											div.css({'display': 'block','height': '100%'});
											jQuery('.sec-t-main-card-list', div).css({
												'position': 'relative'
												,'width':'100%'
												,'height':'100%'
												,'top': 0
												,'left':0
												,'transform': 'none'
												,'cursor': 'default'});
											jQuery('.nav').css({'top':0});
											if (typeof(routine) != 'undefined') clearInterval(routine);
											$container.slick({
												infinite: true,
												speed: 300,
												slidesToShow: 1,
												adaptiveHeight: true,
												prevArrow: $prev,
												nextArrow: $next
											});
										}
										isPC = false;
										isSP = true;
									}
									_bind.fn.bdRefresh();
									_bind.fn.setFooter();
									finishSyncParts();
								}
							})
							
							jQuery.fx.interval = 20;
							var colorId = 0;
							//var bgColor = ['#fff5e5','#fae9e9','#ebf8eb','#e4f8fe','#ebe9fa'];
							var autoFlg = true;
							var moveFlg = false;
							var imgNum = 10;
							var sw,
								sh,
								tM,
								tS = serviceConfig.thumbSize;
								
							function bgAdjust(div){
								
								//sw = jQuery(window).width();
								sw = jQuery(c).width();
								//sh = jQuery(window).height();
								sh = serviceConfig.dispHeight;
								
								div.css({height:sh});
								jQuery('.nav', div).css({top:(sh/2)+(tS/2)});
							}
							
							function nX_l(){
								return Math.floor( Math.random() * (0-(-tS/2)) ) + (-tS/2);
							}
							function nX_r(){
								return Math.floor( Math.random() * (sw-(sw-tS)) ) + (sw-tS);
							}
							
							function reallocation(div){
								var nX;
								var r = Math.round( Math.random() * 1 ) + 1;
								for(var i=0; i<instaInfo.length; i++){
									
									if(i%2 ==0){
										if(r==1){
											nX = nX_l();
										}else{
											nX = nX_r();
										}
									}else{
										if(r==1){
											nX = nX_r();
										}else{
											nX = nX_l();
										}
									}
									var nY = Math.floor( Math.random() * (sh-tS) );
									var nZ = Math.floor( Math.random() * -100 ) + 50;
									
									if (jQuery('.sec-t-main-card-list', div).eq(i).hasClass('current')) {
										nY = (sh/2)-(tS/2);
										nX = (sw/2)-(tS/2);
									}
									jQuery('.sec-t-main-card-list', div).eq(i).velocity({
										top:nY,
										left:nX,
										rotateZ:nZ,
										scale:1
									},{
										duration:0,
										easing:'easeOutCubic',
										complete:function(){
										}
									});
								}
							}
							
							function reallocation_simgle(n, div){
								nowP = n;
								var r = Math.round( Math.random() * 1 ) + 1;
								if(r==1){
									nX = nX_r();
								}else{
									nX = nX_l();
								}
								var nY = Math.floor( Math.random() * (sh-tS) );
								var nZ = Math.floor( Math.random() * -120 ) + 60;
							
								jQuery('.sec-t-main-card-list', div).eq(n).velocity("stop");
								jQuery('.sec-t-main-card-list', div).eq(p).css('z-index','70');
							
								jQuery('.sec-t-main-card-list', div).eq(n).velocity({
									top:nY,
									left:nX
								},{
									duration:800,
									easing:'easeOutCubic'
								});
							
								jQuery('.sec-t-main-card-list', div).eq(n).velocity({
									rotateZ:nZ,
									scale:1
								},{
									queue:"f",
									duration:800,
									easing:'easeOutCubic',
									begin:function(){
										/*if(colorId<4){
											colorId++;
										}else{
											colorId = 0;
										}*/
							
										if(autoFlg){
											if(p<(instaInfo.length-1)){ p++; }else{ p=0; }
											reallocation_center(p, div)
										}
									}
								});
								jQuery('.sec-t-main-card-list', div).eq(p).dequeue("f");
							}
							
							var nowP=0;
							function reallocation_center(n, div){
							
								jQuery('.sec-t-main-card-list', div).eq(p).css('z-index','80');
								jQuery('.sec-t-main-card-list', div).eq(p).velocity({
									left:(sw/2)-(tS/2),
									top:(sh/2)-(tS/2)
								},{
									queue:"c",
									duration:800,
									easing:'easeOutExpo',
									begin:function(){
										moveFlg = true;
										//jQuery('.sec-t-main-card-list').eq(nowP).removeClass('current');
										jQuery('.sec-t-main-card-list', div).removeClass('current');
										jQuery('.sec-t-main-card-list', div).eq(n).addClass('current');
										
										/*jQuery('.sec-t-main').velocity({
											backgroundColor: bgColor[colorId]
										},{
											duration:300,
											easing:'linear'
							
										})*/
									},
									complete:function(){
										moveFlg = false;
									}
								});
								var nZ = Math.floor( Math.random() * -16 ) + 8;
							
								jQuery('.sec-t-main-card-list', div).eq(p).velocity({
									rotateZ:nZ
								},{
									queue:"d",
									duration:1000,
									easing:'easeOutQuint'
								});
								
								jQuery('.sec-t-main-card-list', div).eq(p).dequeue("c");
								jQuery('.sec-t-main-card-list', div).eq(p).dequeue("d");
							}
							
							function init(div){
								var nZ = Math.floor( Math.random() * -16 ) + 8;
								/*jQuery('.sec-t-main-card-list', div).velocity({
									rotateZ:nZ
								},{
									delay:0,
									duration:0,
									easing:'easeOutCubic',
									complete:function(){
									}
								});*/
								
								jQuery('.sec-t-main-card-list', div).eq(0).css('z-index','80');
								jQuery('.sec-t-main-card-list', div).eq(0).addClass('current');
								jQuery('.sec-t-main-card-list', div).eq(0).velocity({
									left:(sw/2)-(tS/2),
									top:(sh/2)-(tS/2)
								},{
									//delay:1000,
									queue:"a",
									duration:0,
									easing:'easeOutExpo',
									begin:function(){
										/*jQuery('.sec-t-main').velocity({
											backgroundColor: bgColor[colorId]
										},{
											duration:0,
											easing:'linear'
										})*/
									}
								});
							
								jQuery('.sec-t-main-card-list', div).eq(0).velocity({
									rotateZ:nZ
								},{
									queue:"b",
									duration:0,
									easing:'easeOutQuint'
								});
							
								jQuery('.sec-t-main-card-list', div).eq(0).dequeue("a");
								jQuery('.sec-t-main-card-list', div).eq(0).dequeue("b");
							
							/*	jQuery('.sec-t-main-card-list', div).hover(function(){
									jQuery(this).css('cursor','pointer')
									jQuery(this).find('.img img').velocity('stop').velocity({
											scale:1.06
										},{
											duration:350,
											easing:'easeOutQuint'
									});
								},function(){
									jQuery(this).find('.img img').velocity('stop').velocity({
											scale:1
										},{
											duration:600,
											easing:'easeOutQuint'
									});
								});
								jQuery('.sec-t-main-card-list', div).click(function(){
									var href = jQuery(this).find('a').attr('href');
									window.open(href,'_blank');
								});*/
								
								intervalStart();
								initLoad = true;
							}

							function intervalStart(){
								autoFlg = true;
								clearInterval(routine);
								routine = setInterval(routine_interval,5000);
							}
							
							var p=0;
							function routine_interval(){
								reallocation_simgle(p, div);
							}
							
							function pagenation(str){
								if(!moveFlg){
									t = 0;
									autoFlg = false;
									clearInterval(routine);
									reallocation_simgle(p, div);
									
									if(str =='next'){
										if(p<(instaInfo.length-1)){
											p++;
										}else{
											p=0;
										}
									}else if(str =='prev'){
										p--;
										if(p<0){
											p=(instaInfo.length-1)
										}
									}else{
										p = str;
									}
									reallocation_center(p, div);
									intervalStart();
								}
							}
							//Click Event
							jQuery('.nav_next', div).click(function(){
								if(!moveFlg && !jQuery(this).hasClass('slick-arrow')) pagenation('next');
							});
							jQuery('.nav_prev', div).click(function(){
								if(!moveFlg && !jQuery(this).hasClass('slick-arrow')) pagenation('prev');
							});
						}
					}
			 		break;
				default:
			 		break;
			}
		} else {
			var noImgDiv= jQuery('<div class="kakomi"><p class="kakomi ac">Instagramに投稿された写真が存在しません。</p></div>');
			jQuery(c).append(noImgDiv);
		}
	});
}

/** 対象文字列valのn番目のstr文字列のindex取得 **/
function getIndexStr(val, str, n) {
	if (val.indexOf(str) <= 0) return 0;
	var idx=0,el=val;
	for (i=0;i<n;i++) {
		var t = el.indexOf(str);
		if (t < 0) break;
		idx = idx+t+1;
		el = el.substring(t+1);
	}
	return idx;
}

/** 色判定 **/
var checkTxtColor = function(rgb) {
	// 最高値は 255 なので、約半分の数値 127 を堺目にして白/黒の判別する
	var cY = 0.3*rgb.r + 0.6*rgb.g + 0.1*rgb.b;
	if(cY > 127){
		return "#000000"; // 黒に設定
	}
	return "#FFFFFF"; // 白に設定
}

/** 色変換（16進数>10進数） **/
var hexToRGB = function(hex) {
	if (hex.indexOf('#') > -1) hex = hex.substring(1);
	return {
        r: parseInt(hex.substring(0,2), 16),
        g: parseInt(hex.substring(2,4), 16),
        b: parseInt(hex.substring(4,6), 16)
      };
}

/** 色変換（16進数>10進数）css **/
var hexToRGBA = function(hex, alpha) {
	if (hex.indexOf('#') > -1) hex = hex.substring(1);
	return 'rgba('
		+ parseInt(hex.substring(0,2), 16) + ','
		+ parseInt(hex.substring(2,4), 16) + ','
		+ parseInt(hex.substring(4,6), 16) + ','
		+ alpha
		+ ')';
	
}

/** 日付取得 YYYY-MM-DD **/
function getDate(ms) {
	return new Date(ms+'000'-0).getFullYear()
		+ '-' + ('00' + (new Date(ms+'000'-0).getMonth()+1)).slice( -2 )
		+ '-' + ('00' + new Date(ms+'000'-0).getDate()).slice( -2 );
}


/*******
 * Google Styled Map
 * 読み込みのマネージャークラス
 ********/
function GMapManager() {
	this.initialize.apply(this, arguments);
}
GMapManager.prototype = {
	initialize: function() {
		this.initialized = false;
		this.loadApiFlg = false;
		this.gmap = new Array();
	},
	addGmap: function(gMapRenderer) {
		if (this.initialized) {
			gMapRenderer.renderer();

		} else if (this.gmap.length == 0 && !this.loadApiFlg) {
			var url = PRTCL + '//maps.googleapis.com/maps/api/js?key='+gMapRenderer.gmapApiKey+'&callback=sync.gmapInitialize';
			googleMapApiSet(url);
			this.loadApiFlg = true;
			this.gmap.push(gMapRenderer);
		} else {
			this.gmap.push(gMapRenderer);
		}
	},
	gmapInitialize: function(evt) {
		this.initialized = true;

		for (var i=0; i < this.gmap.length; i++) {
			this.gmap[i].renderer();
		}
	}
};

/*******
 * Google Styled Map
 * パーツ分だけインスタンス生成して、マネージャークラスで読み込みのハンドリング実施
 ********/
var mk_animation = {
		'default': '',
		'bounce': '',
		'drop': ''
	}
var cnt=0;
var mpArray = {};
var mpCnt = 0;
var mkArray = {};
var mkCnt = 0;
function GMapRenderer() {
	this.initialize.apply(this, arguments);
}
GMapRenderer.prototype = {
	initialize: function(c, sid, option, json) {
		this.mapC = c;
		this.mapC.innerHTML = '';
		this.mapC.style.display = '';
		var gmapLoading = jQuery('<div class="loading"/>');
		jQuery(this.mapC).empty();
		jQuery(this.mapC).append(gmapLoading).show();
		this.gmapId = sid;
		this.option = option;
		this.gmapId = sid;
		this.gmapApiKey = json.gmap_api_key;
		this.gmapDataJson = json;
		this.canvasId = this.gmapId+cnt;
		var gmapWidth = this.option.gmapWidth + this.option.gmapWidthUnit;
		var gmapHeight = this.option.gmapHeight + this.option.gmapHeightUnit;
		this.gmapZoomLevel = this.option.gmapZoomLevel-0;
		this.gmapScrollWheel = (typeof(this.option.gmapScrollWheel) == 'undefined') ? false : this.option.gmapScrollWheel;
		this.gmapCanvas = jQuery('<div id="gmap-canvas-'+this.canvasId+'"/>');
		this.gmapCanvas.css({'max-width': gmapWidth, 'height': gmapHeight});
		gHeight =+ (this.option.gmapHeight-0);
		cnt++;
	},
	renderer: function() {
		jQuery(this.mapC).empty();
		jQuery(this.mapC).append(this.gmapCanvas);
		jQuery(this.mapC).css('overflow', 'hidden');

		var gmapCanvas = document.getElementById('gmap-canvas-'+this.canvasId);

		var gmapLat = this.gmapDataJson.gmap_lat-0;
		var gmapLng = this.gmapDataJson.gmap_lng-0;
		var gmapData = this.gmapDataJson.gmap_data;
		var gmapMks = this.gmapDataJson.gmap_icons;

		var latlng = new google.maps.LatLng(gmapLat, gmapLng);

		var mapOptions = {
				zoom: this.gmapZoomLevel,
				center: latlng,
				scrollwheel: this.gmapScrollWheel,
				mapTypeControlOptions: {
		            mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain',
		                    'styled_map']
		          }
		};

		mpArray[mpCnt] = new google.maps.Map( gmapCanvas , mapOptions );

		var mapType = new google.maps.StyledMapType(gmapData);
		mapType.name = 'Styled Map';
		mpArray[mpCnt].mapTypes.set('styled_map', mapType);
		mpArray[mpCnt].setMapTypeId('styled_map');
		google.maps.event.addListenerOnce(mpArray[mpCnt], 'tilesloaded', function(){
			_bind.fn.bdRefresh();
			_bind.fn.setFooter();
			finishSyncParts();
		});

		// set Marker
		for (var mk in gmapMks) {
			var url = gmapMks[mk].icnUrl;
			// when default icon, delete url
			if (url == '//maps.gstatic.com/mapfiles/api-3/images/spotlight-poi.png') url = '';
			if (url != '') url = (gmapMks[mk].icnUrl.indexOf('http') > -1) ? gmapMks[mk].icnUrl : SYNC5_SERVER + gmapMks[mk].icnUrl.substring(1);
			mkArray[mkCnt] = new google.maps.Marker({
				position: new google.maps.LatLng(gmapMks[mk].lat, gmapMks[mk].lng),
				title: gmapMks[mk].title,
				optimized: gmapMks[mk].optimized,
				icon: url,
				animation: mk_animation[gmapMks[mk].animation],
				map: mpArray[mpCnt]
			});
			setClickMarker(gmapMks, mk, mkCnt, mpCnt);
			mkCnt++;
		}
		mpCnt++;

		setAlign(this.mapC);
	}
};

/*******
 * Markerのクリック設定
 ********/
var infowindow;
function setClickMarker(gmapMks, mk, mkCnt, mpCnt) {

	if (gmapMks[mk].contents != '') {
		google.maps.event.addListener(mkArray[mkCnt], "click", function(e) {
			if (infowindow) infowindow.close();
			infowindow = new google.maps.InfoWindow({
				content: gmapMks[mk].contents
			});
			infowindow.open(mpArray[mpCnt], mkArray[mkCnt]);
		});
	}
}

/*******
 * Google Styled Map
 * APIからのCallback
 ********/
_sync.gmapInitialize = function() {
	gMapManager.initialized = true;
	mk_animation.bounce = google.maps.Animation.BOUNCE;
	mk_animation.drop = google.maps.Animation.DROP;

	for (var i=0; i < gMapManager.gmap.length; i++) {
		gMapManager.gmap[i].renderer();
	}
};

/*******
 * Load Google Map JavaScript API v3
 ********/
function googleMapApiSet(url) {
	var js, id = 'google-map-js-api', ref = document.getElementsByTagName('script')[0];
	if (document.getElementById(id)) {return;}
	js = document.createElement('script'); js.id = id;
	js = document.createElement('script'); js.id = id; js.async = true;
	js.src = url;
	ref.parentNode.insertBefore(js, ref);
}

/*******
 * 編集時・余白ゼロの時の対応 ユニークブロックに対して高さを加算していく
 ********/
function setEditBkHeight(c, h) {
	var height = 0;
	if (jQuery.isNumeric(h)) {
		height = h-0;
	} else {
		if (h.indexOf('px') > -1) height = h.replace(/px/g, '')-0;
	}
	var $clm = jQuery(c).closest('[data-bk-id]').find('>div');
	if (($clm.css('padding').replace(/px/g, '')-0) <= 0) {
		var bkH = jQuery(c).closest('[data-bk-id]').height();
		if (bkH == 100) {
			var bkId = jQuery(c).closest('[data-bk-id]').attr('id');
			bkHeight[bkId] = (bkHeight[bkId]) ? bkHeight[bkId] + height : height;
		}
	}
}

/*******
 * ブロックの横位置指定
 ********/
function setAlign(c, $t) {
	var cBdyCls = jQuery(c).parent()[0].className;
	if (cBdyCls.indexOf('c-left') > -1) {
		var bdy = (typeof($t) == 'undefined') ? jQuery(jQuery(c).children()[0]) : $t;
		bdy = fbCheck(bdy);
		bdy.css({
			'margin-right': 'auto'
			,'text-align': 'left'
		});
	} else if (cBdyCls.indexOf('c-center') > -1) {
		var bdy = (typeof($t) == 'undefined') ? jQuery(jQuery(c).children()[0]) : $t;
		bdy = fbCheck(bdy);
		bdy.css({
			'margin': '0 auto'
			,'text-align': 'center'
		});
	} else if (cBdyCls.indexOf('c-right') > -1) {
		var bdy = (typeof($t) == 'undefined') ? jQuery(jQuery(c).children()[0]) : $t;
		bdy = fbCheck(bdy);
		bdy.css({
			'margin-left': 'auto'
			,'text-align': 'right'
		});
	}
}

function fbCheck($c) {
	return ($c.attr('id') && $c.attr('id').indexOf('fb-root') > -1) ? $c.next() : $c;
}

/*******
 * ブロックの幅取得（余白抜き・段落分け考慮）
 ********/
function getBkWidth($c) {
	var clmn = jQuery($c).closest('.column');
	if (jQuery($c).closest('.b-tab_contents').length > 0) clmn = jQuery($c).closest('.b-tab_contents');
	var width = jQuery(clmn).width();
	var maxWidth = (jQuery(clmn).css('max-width') != 'none' && (jQuery(clmn).css('max-width').indexOf('100%') < 0)) ? jQuery(clmn).css('max-width') : jQuery(clmn).width();
	if (width > maxWidth) width = maxWidth;
	if (jQuery.isNumeric(width)) {
		return width-0;
	} else {
		if (width.indexOf('px') > -1) width = width.replace(/px/g, '')-0;
		return width;
	}
}

/*******
 * ブロックの高さ取得（余白抜き・段落分け考慮）パーツ単位
 * ※実質使用していない関数
 ********/
function getBkHeight($c) {
	var clm = jQuery($c).closest('.column');
	return jQuery(clm).height();
}

/*******
 * 読み込み終了後にブロックのcss調整
 ********/
function setBkCss() {
	for (var id in bkHeight) {
		jQuery('#'+id).height(bkHeight[id]);
	}
}

function DocumentGetFullscreenElement(document_obj){
	return (
		document_obj.fullscreenElement ||
		document_obj.webkitFullscreenElement ||
		document_obj.webkitCurrentFullscreenElement ||
		document_obj.mozFullScreenElement ||
		document_obj.msFullscreenElement ||
		null
	);
}

/*******
 * 最終パーツ描画終了後の関数
 ********/
function finishSyncParts() {
	if (partsCnt == (finishCnt+1)) {
		_bind.syncLoad = true;
	} else {
		finishCnt++;
	}
}

_sync.init = function() {
	jQuery(document).ready(function() {
		
		jQuery.ajax({
				url: SYNC5_SERVER + '_modules/js/i18next/i18next-1.6.3.min.js'
				,dataType: 'script'
		}).done(function(){
					var lang = (navigator.languages && navigator.languages.length > 0) ? navigator.languages[0] : (navigator.language || navigator.userLanguage || navigator.browserLanguage);
					lang = lang.substr(0,2);
					var option = {
					    lng: lang,
					    debug: false,
					    getAsync: false,
					    resGetPath: SYNC5_SERVER + '/_modules/js/i18next/locales/__lng__/translation.json'
					};
					i18n.init(option);
					if('ja' != lang) jQuery('html').attr('lang', 'en');

					syncDig(document);

					if (feedManager!=null) {
						if ((typeof(BlockEdit) == 'undefined') && (hashChangeFlg)) {
							jQuery(function(){
								var url = SYNC_RES_SERVER + '_modules/js/jquery.ba-hashchange.min.js';
								jQuery.getScript(url,  function(){
									jQuery(window).hashchange(function() {
									setHash = location.hash.replace('#','');
									feedManager.load(setHash);
									})
									jQuery(window).hashchange();
								})
							})
						} else {
							feedManager.load();
						}
					}
		});
	});
};



/*******
 * Amazon アソシエイト
 ********/
function dispAffiliate(c, sid, did, opt) {
	if (c.innerHTML.substring(0, 1) == '<') return;

	c.innerHTML = '';
	c.style.display = 'inline-block';
	c.style.textAlign = 'left';
	c.style.boxSizing = 'border-box';

	var DESIGNS = {
		amazon: [
			{id: 'standard', title: '標準', html: ''
					+ '<div style="clear: both; display:table-cell;">'
					+ '<div style="display: inline-block; float:left;">'
					+ '<div style="width: 85px; height: 85px; text-align: center; display:table-cell; vertical-align: middle; background-color:#FFFFFF;'
					+ ' border: 0px; padding 0px; box-sizing: border-box;">'
					+ '<a href="'+'{link}'+'" rel="nofollow" target="_blank" style="border: 0px; padding 0px;">'
					+ '<img src="'+'{image}'+'" title="'+'{title}'+'" style="max-width:75px; max-height:75px;  border: 0px; padding:0px; box-sizing: border-box;" />'
					+ '</a></div>'
					+ '</div>'
					+ '<div style="font-size:12px; line-height: 1.6; padding-left: 91px; padding-right: 6px;"><a href="'+'{link}'+'" target="_blank">{title}</a></div>'
					+ '<div style="font-size:12px; line-height: 1.6; padding-left: 91px; padding-right: 6px;"><span> '+'{author}'+'</span></div>'
					+ '<div style="clear:left;"></div>'
					+ '</div>'
			},
			{id: 'sample01', title: '画像のみ', html:  ''
					+ '<div style="width: 85px; height: 85px; text-align: center; display:table-cell; vertical-align: middle; background-color:#FFFFFF;'
					+ ' border: 0px; padding 0px; box-sizing: border-box;">'
					+ '<a href="'+'{link}'+'" rel="nofollow" target="_blank" style="border: 0px; padding 0px;">'
					+ '<img src="'+'{image}'+'" title="'+'{title}'+'" style="max-width:75px; max-height:75px;  border: 0px; padding:0px; box-sizing: border-box;" />'
					+ '</a></div>'
			},
			{id: 'sample02', title: '画像+商品名', html:  ''
					+ '<div style="padding: 10px; margin-bottom: 0.5em; text-align: left; height: auto;">'
					+ '<div style="float: left; width: 92px;">'
					+ '<div style="width: 92px; height: 92px; text-align: center; display:table-cell; vertical-align: middle; background-color:#FFFFFF;'
					+ ' border: 1px solid #BBBB99; padding 0px; box-sizing: border-box;">'
					+ '<a href="'+'{link}'+'" rel="nofollow" target="_blank" style="border: 0px; padding 0px;">'
					+ '<img src="'+'{image}'+'" title="'+'{title}'+'" style="max-width:75px; max-height:75px;  border: 0px; padding:0px; box-sizing: border-box;" />'
					+ '</a></div>'
					+ '</div>'
					+ '<h3 style="text-align: left; color: #333366; font-family: Verdana; font-size: 14px; border-bottom: 1px solid #BBBB99;'
					+ ' margin: 0px 0px 0px 92px; padding: 0px 0px 3px 10px; line-height: 1.8em;">'
					+ '<a href="'+'{link}'+'" target="_blank" style="text-align: left; color:#336633; border: 0px;'
					+ ' {color: #900} :link {color: #336633} :visited {color: #336633} :hover {color: #55BB33} :active {color: #FF0000}">'+'{title}'+'</a></h3>'
					+ '<div style="border:none; text-align: left; color: #333366; font-size: 12px; margin: 0px 0px 0px 92px; padding: 3px 0px 0px 10px; line-height: 1.8em;">'
					+ ''+'{author}'+'</div>'
					+ '<div style="clear: both;"></div>'
					+ '</div>'
			},
			{id: 'sample03', title: 'シンプル', html:  ''
					+ '<div style="overflow: hidden; font-size: small; zoom: 1; margin: 15px 0; text-align: left;">'
					+ '<div style="float: left; margin: 0px 15px 10px 0px; width: 75px; height: 75px; text-align: center; background-color:#fff;">'
					+ '<a href="'+'{link}'+'" rel="nofollow" target="_blank" style="border: 0px;">'
					+ '<img style="border-top: medium none; border-right: medium none; border-bottom: medium none; border-left: medium none;'
					+ ' padding:0px; max-width:75px; max-height:75px;"'
					+ ' src="'+'{image}'+'" title="'+'{title}'+'" /></a></div>'
					+ '<div style="overflow: hidden; zoom: 1; line-height: 120%;">'
					+ '<div style="margin-bottom: 2px; line-height: 120%;">'
					+ '<a href="'+'{link}'+'" rel="nofollow" target="_blank">'+'{title}'+'</a>'
					+ '</div>'
					+ '<div style="margin-bottom: 5px;">'+'{author}'+'</div>'
					+ '</div>'
					+ '<div style="clear: left"></div>'
					+ '</div>'
			},
			{id: 'iframe', title: 'Amazon標準', html:  ''
					+ '<iframe'
					+ ' src="//rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&bc1=000000&IS2=1'//&nou=1'
					+ '&o=9&p=8&l=as1&m=amazon&f=ifr&ref=tf_til'
					+ '&t='+ '{affiliateid}'
					+ '&asins='+ '{asin}'
					+ '&bg1=FFFFFF&fc1=000000&lc1=0000FF"'
					+ ' style="width:120px;height:240px; box-sizing: border-box;"'
					+ ' scrolling="no"'
					+ ' marginwidth="0"'
					+ ' marginheight="0"'
					+ ' frameborder="0">'
					+ '</iframe>'
			}
		]
	};

	var buf = DESIGNS.amazon[0].html;
	for (var i=0; i<DESIGNS.amazon.length; i++) {
		var p = DESIGNS.amazon[i];
		if (p.id == did) {
			buf = DESIGNS.amazon[i].html;
			break;
		}
	}
	var fields =  ['asin', 'title', 'author', 'link', 'image', 'affiliateid'];
	for (i=0;i<fields.length;i++){
		var regExp = new RegExp( '{'+fields[i]+'}' ,"gi") ;
		buf = buf.replace(regExp , opt[fields[i]] ) ;
	}

	//c.innerHTML = buf;
	jQuery(buf).appendTo(c);

	setAlign(c);
	_bind.fn.bdRefresh();
	_bind.fn.setFooter();
	finishSyncParts();
}


})(sync);	// 定義終了

sync.init();